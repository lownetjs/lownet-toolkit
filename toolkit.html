<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'sha256-B8RbkvjKl2IYPav8g1upjqDsJNKmBMM+Fz3DsMG28Wg='; style-src 'unsafe-inline'; connect-src 'self' https://lownet.org; img-src data: blob:; worker-src 'self' blob:; manifest-src 'self' data:; base-uri 'none'; frame-ancestors 'none'; object-src 'none';">
  <!-- CSP (v1.1.2): Hash-based script-src (deploy.sh injects hash). connect-src locked to official relay.
       base-uri/frame-ancestors/object-src: none. Zero eval, zero external scripts, zero CDN. -->
  <meta name="theme-color" content="#050505">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LOWNET">
  <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22LOWNET%20Toolkit%22%2C%22short_name%22%3A%22LOWNET%22%2C%22description%22%3A%22Cryptographic%20toolkit%20for%20signed%20statements%2C%20encrypted%20messages%20%26%20files.%20Ed25519%20%5Cu00b7%20P-256%20%5Cu00b7%20AES-GCM.%20Offline-first%2C%20no%20server%20required.%22%2C%22start_url%22%3A%22.%22%2C%22scope%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22orientation%22%3A%22any%22%2C%22background_color%22%3A%22%23050505%22%2C%22theme_color%22%3A%22%23050505%22%2C%22categories%22%3A%5B%22security%22%2C%22utilities%22%2C%22productivity%22%5D%2C%22lang%22%3A%22en%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%253D%2527http%253A%2F%2Fwww.w3.org%2F2000%2Fsvg%2527%2520viewBox%253D%25270%25200%2520512%2520512%2527%253E%253Crect%2520fill%253D%2527%2523050505%2527%2520width%253D%2527512%2527%2520height%253D%2527512%2527%2520rx%253D%252780%2527%2F%253E%253Ctext%2520x%253D%2527256%2527%2520y%253D%2527358%2527%2520text-anchor%253D%2527middle%2527%2520font-size%253D%2527280%2527%2520font-family%253D%2527monospace%2527%2520font-weight%253D%2527700%2527%2520fill%253D%2527white%2527%253EL%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%22%7D%2C%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%253D%2527http%253A%2F%2Fwww.w3.org%2F2000%2Fsvg%2527%2520viewBox%253D%25270%25200%2520512%2520512%2527%253E%253Crect%2520fill%253D%2527%2523050505%2527%2520width%253D%2527512%2527%2520height%253D%2527512%2527%2F%253E%253Ctext%2520x%253D%2527256%2527%2520y%253D%2527358%2527%2520text-anchor%253D%2527middle%2527%2520font-size%253D%2527280%2527%2520font-family%253D%2527monospace%2527%2520font-weight%253D%2527700%2527%2520fill%253D%2527white%2527%253EL%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22maskable%22%7D%5D%7D">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23050505' width='180' height='180' rx='36'/><text x='90' y='126' text-anchor='middle' font-size='110' font-family='monospace' font-weight='700' fill='white'>L</text></svg>">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23050505' rx='8' width='100' height='100'/><text x='50' y='70' text-anchor='middle' font-size='56' font-family='monospace' font-weight='700' fill='white'>L</text></svg>">
  <title>LOWNET Toolkit</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #070708;
      --surface: #0c0c0d;
      --surface-hover: #131314;
      --input-bg: #1a1a1c;
      --border: #1c1c1e;
      --border-light: #282829;
      --border-subtle: #161617;
      --text: #e4e4e6;
      --text-secondary: #a8a8ac;
      --text-muted: #58585c;
      --text-dim: #78787c;
      --accent: #00d970;
      --accent-muted: #00b85c;
      --accent-subtle: rgba(0, 217, 112, 0.10);
      --error: #ef4444;
      --error-subtle: rgba(239, 68, 68, 0.10);
      --warning: #f59e0b;
      --warning-subtle: rgba(245, 158, 11, 0.10);
      --radius: 3px;
      --radius-sm: 2px;
    }
    
    html.light {
      color-scheme: light;
      --bg: #e8e8ea;
      --surface: #ffffff;
      --surface-hover: #f5f5f5;
      --input-bg: #f0f0f2;
      --border: #d0d0d2;
      --border-light: #b8b8ba;
      --border-subtle: #dcdcde;
      --text: #0f0f10;
      --text-secondary: #404042;
      --text-muted: #707072;
      --text-dim: #606062;
      --accent: #00a854;
      --accent-muted: #008c46;
      --accent-subtle: rgba(0, 168, 84, 0.12);
      --error: #dc2626;
      --error-subtle: rgba(220, 38, 38, 0.1);
      --warning: #d97706;
      --warning-subtle: rgba(217, 119, 6, 0.1);
    }
    

    /* Premium / PRO */
    .pro-badge { display:inline-block; font-size:8px; font-weight:700; letter-spacing:0.5px; padding:2px 5px; border-radius:3px; background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff; vertical-align:middle; margin-left:6px; line-height:1; }
    .pro-badge-active { background:linear-gradient(135deg,var(--accent),#059669); }
    .template-item[data-template="file"] .template-desc { display:flex; align-items:center; gap:4px; }
    .premium-gate-overlay { position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.03);border-radius:var(--radius);pointer-events:none; }
    .template-item[data-template="file"]:not(.pro-unlocked) { opacity:0.7; }
    .template-item[data-template="file"].pro-unlocked { opacity:1; }
    #license-status { font-size:10px; padding:8px 10px; border-radius:var(--radius-sm); margin-bottom:10px; }
    #license-status.active { background:var(--accent-subtle); color:var(--accent); }
    #license-status.inactive { background:var(--bg); color:var(--text-muted); }

    /* PWA standalone mode */
    .pwa-standalone .header { padding-top: calc(12px + env(safe-area-inset-top)); }
    .pwa-standalone .footer { padding-bottom: calc(6px + env(safe-area-inset-bottom)); }
    .pwa-standalone .tab-bar { padding-bottom: env(safe-area-inset-bottom); }
    .security-banner { display:flex; align-items:center; gap:8px; padding:8px 12px; margin:0 0 12px; background:var(--warning-bg, #f59e0b12); border:1px solid var(--warning-border, #f59e0b30); border-radius:var(--radius-sm); font-size:11px; color:var(--text-muted); line-height:1.4; }
    .security-banner-close { margin-left:auto; cursor:pointer; color:var(--text-muted); font-size:16px; padding:0 4px; opacity:0.6; }
    .security-banner-close:hover { opacity:1; }
    @media (display-mode: standalone) {
      body { -webkit-user-select: none; user-select: none; }
      .code-block, input, textarea, [style*="user-select"] { -webkit-user-select: text; user-select: text; }
    }

    /* Classic Theme (Easter Egg) - rounded, emerald, sans-serif */
    html.classic {
      --bg: #0f0f10;
      --surface: #1a1a1c;
      --surface-hover: #252528;
      --input-bg: #1a1a1c;
      --border: #2a2a2d;
      --border-light: #2a2a2d;
      --border-subtle: #1f1f22;
      --text: #f4f4f5;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --text-dim: #71717a;
      --accent: #10b981;
      --accent-muted: #059669;
      --accent-subtle: rgba(16, 185, 129, 0.12);
      --error: #ef4444;
      --error-subtle: rgba(239, 68, 68, 0.12);
      --warning: #f59e0b;
      --warning-subtle: rgba(245, 158, 11, 0.12);
      --radius: 8px;
      --radius-sm: 5px;
    }
    html.classic body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      font-size: 13px;
    }
    html.classic.light {
      --bg: #f5f5f5;
      --surface: #ffffff;
      --surface-hover: #e8e8e8;
      --input-bg: #ffffff;
      --border: #d4d4d4;
      --border-subtle: #e5e5e5;
      --text: #1a1a1c;
      --text-secondary: #52525b;
      --text-muted: #71717a;
      --text-dim: #a1a1aa;
      --accent: #059669;
      --accent-muted: #047857;
      --accent-subtle: rgba(5, 150, 105, 0.12);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html { overflow-y: scroll; }
    body { 
      background: var(--bg); 
      color: var(--text); 
      font-family: ui-monospace, 'SF Mono', 'Cascadia Mono', 'Segoe UI Mono', Consolas, monospace;
      font-size: 12px;
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    
    ::selection { background: var(--accent); color: var(--bg); }
    
    /* Grid overlay - dark mode only, very subtle */
    html:not(.light) body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: 
        linear-gradient(rgba(16, 185, 129, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(16, 185, 129, 0.02) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: -1;
    }
    
    .app { max-width: 580px; margin: 0 auto; padding: 0 20px 20px; overflow-x: hidden; }
    
    /* Header */
    .header { display: flex; align-items: center; justify-content: space-between; padding: 18px 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
    .header-left { display: flex; align-items: center; gap: 10px; }
    .header-icon { width: 28px; height: 28px; background: var(--accent); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; }
    .header-icon svg { width: 14px; height: 14px; fill: var(--bg); }
    .header-title { font-size: 13px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; }
    .header-title span { font-weight: 400; color: var(--text-dim); letter-spacing: 1px; }
    .header-sub { font-size: 9px; color: var(--text-muted); letter-spacing: 0.5px; margin-top: 1px; }
    .header-right { display: flex; align-items: center; gap: 6px; }
    .header-badge { display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 9px; letter-spacing: 0.5px; color: var(--text-dim); cursor: pointer; transition: all 0.2s; }
    .header-badge:hover { border-color: var(--accent); color: var(--accent); }
    .header-badge svg { width: 12px; height: 12px; }
    
    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
    .tab { flex: 1; padding: 10px 6px; text-align: center; font-size: 9px; font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text-muted); cursor: pointer; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .tab:hover { color: var(--text-dim); border-color: var(--text-muted); }
    .tab.active { color: var(--accent); border-color: var(--accent); background: var(--accent-subtle); }
    .tab svg { width: 15px; height: 15px; opacity: 0.5; }
    .tab.active svg { opacity: 1; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Cards */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
    .card-header { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 14px; }
    .card-icon { color: var(--accent); margin-top: 1px; }
    .card-icon svg { width: 13px; height: 13px; }
    .card-title { font-size: 11px; font-weight: 600; letter-spacing: 0.3px; }
    .card-subtitle { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
    
    /* Buttons */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 11px 18px; font-family: ui-monospace, 'SF Mono', 'Cascadia Mono', 'Segoe UI Mono', Consolas, monospace; font-size: 10px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; border: 1px solid transparent; border-radius: var(--radius-sm); transition: all 0.2s; width: 100%; text-decoration: none; }
    .btn-primary { background: transparent; border-color: var(--accent); color: var(--accent); }
    .btn-primary:hover { background: var(--accent); color: var(--bg); }
    .btn-primary:disabled { border-color: var(--border); color: var(--text-muted); cursor: not-allowed; }
    .btn-primary:disabled:hover { background: transparent; }
    .btn-secondary { background: var(--surface); border-color: var(--border); color: var(--text-dim); }
    .btn-secondary:hover { border-color: var(--text-muted); color: var(--text); background: var(--surface-hover); }
    .btn-accent { background: var(--accent-subtle); border-color: var(--accent); color: var(--accent); }
    .btn-accent:hover { background: var(--accent); color: var(--bg); }
    .btn-row { display: flex; gap: 8px; margin-top: 14px; }
    .btn-row .btn { flex: 1; }
    .btn-small { padding: 7px 12px; font-size: 9px; width: auto; }
    
    /* Form Fields */
    .field { margin-bottom: 14px; }
    .field-label { display: block; font-size: 10px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
    .field-label .required { color: var(--error); }
    input, textarea, select { width: 100%; padding: 11px 13px; background: var(--input-bg); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: ui-monospace, 'SF Mono', 'Cascadia Mono', 'Segoe UI Mono', Consolas, monospace; font-size: 11px; outline: none; resize: none; transition: border-color 0.2s; }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); background: var(--surface); }
    textarea { min-height: 90px; line-height: 1.6; }
    select { cursor: pointer; }
    
    /* Steps */
    .steps { display: flex; align-items: center; padding: 10px 14px; margin-bottom: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); }
    .step { display: flex; align-items: center; gap: 6px; }
    .step-num { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; background: var(--bg); color: var(--text-muted); border: 1px solid var(--border); border-radius: var(--radius-sm); }
    .step.active .step-num, .step.done .step-num { border-color: var(--accent); background: var(--accent); color: var(--bg); }
    .step-label { font-size: 9px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); display: none; }
    .step.active .step-label { display: block; color: var(--text); }
    .step-line { flex: 1; height: 1px; background: var(--border); margin: 0 10px; }
    
    /* Template List */
    .template-list { display: flex; flex-direction: column; gap: 6px; }
    .template-item { display: flex; align-items: center; gap: 14px; padding: 12px 14px; background: var(--input-bg); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; transition: all 0.2s; }
    .template-item:hover { border-color: var(--text-muted); background: var(--surface-hover); }
    .template-item.selected { border-color: var(--accent); background: var(--accent-subtle); }
    .template-icon { width: 30px; height: 30px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: var(--text-muted); }
    .template-icon svg { width: 14px; height: 14px; }
    .template-item.selected .template-icon { background: var(--accent); border-color: var(--accent); color: var(--bg); }
    .template-info { flex: 1; }
    .template-name { font-size: 11px; font-weight: 500; }
    .template-desc { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
    .template-check { width: 16px; height: 16px; border: 1px solid var(--border); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; }
    .template-item.selected .template-check { background: var(--accent); border-color: var(--accent); }
    .template-item.selected .template-check::after { content: '✓'; color: var(--bg); font-size: 10px; font-weight: 700; }
    
    /* Identity Row */
    .identity-row { display: flex; align-items: center; gap: 12px; padding: 11px 13px; background: var(--input-bg); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; margin-bottom: 6px; transition: all 0.2s; }
    .identity-row:hover { border-color: var(--text-muted); background: var(--surface-hover); }
    .identity-row.selected { border-color: var(--accent); background: var(--accent-subtle); }
    .identity-icon { color: var(--text-muted); }
    .identity-row.selected .identity-icon { color: var(--accent); }
    .identity-info { flex: 1; }
    .identity-name { font-size: 11px; font-weight: 500; }
    .identity-fp { font-size: 9px; color: var(--text-muted); }
    
    /* Result Badge */
    .result-badge { display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: var(--accent-subtle); border: 1px solid var(--accent); border-radius: var(--radius); margin-bottom: 14px; }
    .result-badge.error { background: var(--error-subtle); border-color: var(--error); }
    .result-badge-icon { width: 36px; height: 36px; background: var(--accent); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: var(--bg); }
    .result-badge.error .result-badge-icon { background: var(--error); }
    .result-badge-text { flex: 1; }
    .result-badge-title { font-size: 12px; font-weight: 600; color: var(--accent); letter-spacing: 0.5px; }
    .result-badge.error .result-badge-title { color: var(--error); }
    .result-badge-sub { font-size: 10px; color: var(--text-secondary); margin-top: 2px; }
    
    /* Info Row */
    .info-row { display: flex; justify-content: space-between; padding: 9px 0; border-bottom: 1px solid var(--border-subtle); font-size: 11px; }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--text-muted); }
    .info-value { color: var(--text); }
    
    /* List Items */
    .list-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--input-bg); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
    .list-item:hover { border-color: var(--text-muted); background: var(--surface-hover); }
    .list-item:hover .vault-delete { opacity: 1; }
    .vault-delete:hover { background: var(--error) !important; color: white !important; opacity: 1 !important; }
    .list-type { font-size: 8px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--accent); background: var(--accent-subtle); padding: 4px 10px; border-radius: var(--radius-sm); width: 76px; text-align: center; flex-shrink: 0; }
    .list-info { flex: 1; }
    .list-title { font-size: 11px; font-weight: 500; }
    .list-meta { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
    .list-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 11px; border: 1px dashed var(--border); border-radius: var(--radius); background: var(--input-bg); }
    
    /* Key Card */
    .key-card { background: var(--input-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; margin-bottom: 10px; }
    .key-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .key-card-name { font-size: 12px; font-weight: 600; flex: 1; }
    .key-card-fp { font-size: 9px; color: var(--accent); background: var(--accent-subtle); padding: 4px 10px; border-radius: var(--radius-sm); }
    .key-card-actions { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
    .key-card-actions .btn { padding: 7px 10px; font-size: 9px; flex: 1; min-width: 70px; }
    .key-status { font-size: 8px; letter-spacing: 1px; text-transform: uppercase; padding: 3px 8px; border-radius: var(--radius-sm); font-weight: 500; }
    .key-status.locked { background: var(--surface); color: var(--text-muted); }
    .key-status.unlocked { background: var(--accent-subtle); color: var(--accent); }
    
    /* Code Block */
    .code-block { background: var(--input-bg); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 14px; font-size: 10px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; line-height: 1.6; }
    
    /* Divider */
    .divider { display: flex; align-items: center; gap: 14px; margin: 18px 0; color: var(--text-muted); font-size: 9px; letter-spacing: 2px; text-transform: uppercase; }
    .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
    
    /* PoW Status */
    .pow-status { background: var(--input-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; margin: 14px 0; text-align: center; }
    .pow-label { font-size: 9px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
    .pow-value { font-size: 18px; font-weight: 600; color: var(--accent); }
    .pow-progress { height: 3px; background: var(--border); border-radius: 2px; margin-top: 10px; overflow: hidden; }
    .pow-progress-bar { height: 100%; background: var(--accent); width: 0; transition: width 0.1s; }
    .pow-detail { font-size: 9px; color: var(--text-muted); margin-top: 8px; }
    .pow-wait { font-size: 10px; color: var(--warning); text-align: center; padding: 10px 12px; background: var(--warning-subtle); border: 1px solid var(--warning); border-radius: var(--radius-sm); margin-bottom: 12px; }
    
    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 16px; }
    .modal { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); max-width: 560px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; }
    .modal-header { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-weight: 600; font-size: 12px; letter-spacing: 1px; text-transform: uppercase; }
    .modal-close { background: none; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; padding: 4px 8px; transition: color 0.2s; }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 18px; overflow-y: auto; flex: 1; }
    .modal-body h2 { font-size: 11px; font-weight: 600; letter-spacing: 1px; color: var(--accent); margin: 20px 0 10px 0; padding-bottom: 6px; border-bottom: 1px solid var(--border); text-transform: uppercase; }
    .modal-body h2:first-child { margin-top: 0; }
    .modal-body h3 { font-size: 11px; font-weight: 600; color: var(--text); margin: 16px 0 8px 0; }
    .modal-body p { font-size: 11px; color: var(--text-secondary); line-height: 1.7; margin: 8px 0; }
    .modal-body ul, .modal-body ol { font-size: 11px; color: var(--text-secondary); line-height: 1.7; margin: 8px 0; padding-left: 18px; }
    .modal-body table { width: 100%; border-collapse: collapse; font-size: 10px; margin: 12px 0; }
    .modal-body th, .modal-body td { padding: 8px 10px; text-align: left; border: 1px solid var(--border); }
    .modal-body th { background: var(--bg); color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; font-size: 9px; }
    .modal-body code { background: var(--bg); padding: 2px 6px; font-size: 10px; border-radius: var(--radius-sm); }
    .modal-body pre { background: var(--bg); padding: 12px; border-radius: var(--radius-sm); overflow-x: auto; font-size: 10px; line-height: 1.5; }
    
    /* Status Toast */
    .status { padding: 10px 16px; font-size: 10px; letter-spacing: 0.5px; position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 100; border-radius: var(--radius-sm); }
    .status.success { background: var(--accent-subtle); color: var(--accent); border: 1px solid var(--accent); }
    .status.error { background: var(--error-subtle); color: var(--error); border: 1px solid var(--error); }
    
    /* Footer */
    .footer { display: flex; align-items: center; justify-content: center; padding: 16px 0; margin-top: 24px; border-top: 1px solid var(--border); }
    .footer-badges { display: flex; gap: 16px; }
    .footer-badge { font-size: 9px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; }
    
    .hide { display: none !important; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    /* Easter Egg: Classic Mode (OG Design) */
    html.classic {
      --radius: 8px;
      --radius-sm: 5px;
    }
    html.classic body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      font-size: 13px;
    }
    html.classic:not(.light) {
      --bg: #0f0f10;
      --surface: #1a1a1c;
      --surface-hover: #252528;
      --input-bg: #252528;
      --border: #2a2a2d;
      --accent: #10b981;
    }
    html.classic.light {
      --bg: #f5f5f5;
      --surface: #ffffff;
      --input-bg: #e8e8e8;
      --accent: #059669;
    }
    html.classic body::before { display: none; }
    html.classic .header-title { letter-spacing: 0.5px; }
    html.classic .tab { border-radius: 5px; }
    html.classic .card { border-radius: 8px; }
    html.classic .header-badge { border-radius: 12px; }
    
    @media (max-width: 640px) {
      .app { padding: 0 16px 16px; }
      .header { padding: 16px 0; }
      .header-title { font-size: 12px; letter-spacing: 1px; }
      .tabs { flex-wrap: wrap; }
      .tab { flex: 1 1 30%; min-width: 0; padding: 10px 4px; }
      .btn { padding: 10px 14px; }
    }
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="header-left">
      <div>
        <div class="header-title">LOWNET <span>Toolkit</span></div>
        <div class="header-sub">CNP-1 · ENV-1.2 · ENV-F-1 · SCP-1 · PoW v2</div>
      </div>
    </div>
    <div class="header-right">
      <div class="header-badge hide" id="btn-install" title="Install App"><svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></div>
      <div class="header-badge" id="btn-help" title="Help"><svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg></div>
      <div class="header-badge" id="theme-toggle" title="Toggle theme"><svg id="theme-icon" viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></svg></div>
      <div class="header-badge" id="lock-status" title="Manage identities"><svg id="lock-icon" viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9z"/></svg></div>
    </div>
  </header>
  
  <div class="security-banner hide" id="ext-warning">
    <svg viewBox="0 0 24 24" fill="var(--warning)" width="14" height="14"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
    <span>Browser extensions can access your keys and plaintext. For maximum security, <strong id="ext-warn-action" style="color:var(--accent);cursor:pointer;text-decoration:underline;">install as app</strong> or use Incognito mode.</span>
    <span class="security-banner-close" id="ext-warning-close">&times;</span>
  </div>
  
  <div class="tabs">
    <div class="tab active" data-tab="create"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Create</div>
    <div class="tab" data-tab="verify"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>Verify</div>
    <div class="tab" data-tab="vault"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg>Vault</div>
    <div class="tab" data-tab="keys"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>Keys</div>
    <div class="tab" data-tab="public"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>Public</div>
    <div class="tab" data-tab="settings"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>Settings</div>
  </div>

  <!-- CREATE TAB -->
  <div class="tab-content active" id="tab-create">
    <div class="steps">
      <div class="step active"><div class="step-num">1</div><span class="step-label">Type</span></div>
      <div class="step-line"></div>
      <div class="step"><div class="step-num">2</div><span class="step-label">Content</span></div>
      <div class="step-line"></div>
      <div class="step"><div class="step-num">3</div><span class="step-label">Sign</span></div>
      <div class="step-line"></div>
      <div class="step"><div class="step-num">4</div><span class="step-label">Done</span></div>
    </div>
    
    <div id="create-step-1">
      <div class="card">
        <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"/></svg></div><div><div class="card-title">Select Type</div><div class="card-subtitle">Choose notice type</div></div></div>
        <div class="template-list">
          <div class="template-item" data-template="statement"><div class="template-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></div><div class="template-info"><div class="template-name">Statement</div><div class="template-desc">General signed statement</div></div><div class="template-check"></div></div>
          <div class="template-item" data-template="commitment"><div class="template-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3z"/></svg></div><div class="template-info"><div class="template-name">Commitment</div><div class="template-desc">Promise or obligation</div></div><div class="template-check"></div></div>
          <div class="template-item" data-template="attestation"><div class="template-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg></div><div class="template-info"><div class="template-name">Attestation</div><div class="template-desc">ISO / audit-ready format</div></div><div class="template-check"></div></div>
          <div class="template-item" data-template="envelope"><div class="template-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg></div><div class="template-info"><div class="template-name">Encrypted Envelope</div><div class="template-desc">Private message (ENV-1.2)</div></div><div class="template-check"></div></div>
                    <div class="template-item" data-template="file"><div class="template-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm0 7V3.5L18.5 9H14zM12 11l-4 4h2.5v4h3v-4H16l-4-4z"/></svg></div><div class="template-info"><div class="template-name">Encrypted File</div><div class="template-desc">E2E encrypted file (ENV-F-1) <span class="pro-badge" id="file-pro-badge">PRO</span></div></div><div class="template-check"></div></div>
          <div class="template-item" data-template="lora"><div class="template-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div><div class="template-info"><div class="template-name">LoRa Commitment</div><div class="template-desc">SCP-1 packet (~110 bytes)</div></div><div class="template-check"></div></div>
        </div>
        <div class="btn-row"><button class="btn btn-primary" id="btn-step1-next" disabled>Continue</button></div>
      </div>
    </div>
    
    <div id="create-step-2" class="hide">
      <div class="card">
        <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg></div><div><div class="card-title">Notice Details</div><div class="card-subtitle" id="details-subtitle">Enter content</div></div></div>
        <div id="envelope-recipient" class="hide">
          <div class="field"><label class="field-label">Recipient Public Key <span class="required">*</span></label><textarea id="recipient-key" placeholder="Paste public key here" style="min-height:70px;"></textarea><div class="btn-row" style="margin-top:6px;"><button class="btn btn-secondary btn-small" id="btn-scan-recipient">Scan QR</button><button class="btn btn-secondary btn-small" id="btn-pick-contact">From Contacts</button></div></div>
          <div id="recipient-fp" style="font-size:10px;color:var(--text-muted);margin-bottom:14px;">No recipient</div>
        </div>
        <div id="file-fields" class="hide">
          <div style="background:var(--accent-subtle);padding:12px;border-radius:var(--radius-sm);margin-bottom:14px;">
            <div style="font-size:11px;font-weight:600;color:var(--accent);margin-bottom:4px;">Encrypted File (ENV-F-1)</div>
            <div style="font-size:10px;color:var(--text-secondary);">End-to-end encrypted. Recipient needs their private key to decrypt. Max 50 MB.</div>
          </div>
          <div id="file-recipient" class="field">
            <label class="field-label">Recipient Public Key(s) <span class="required">*</span></label>
            <textarea id="file-recipient-key" placeholder="Paste public key or scan QR" style="min-height:70px;"></textarea>
            <div class="btn-row" style="margin-top:6px;">
              <button class="btn btn-secondary btn-small" id="btn-scan-file-recipient">Scan QR</button>
              <button class="btn btn-secondary btn-small" id="btn-pick-file-contact">From Contacts</button>
              <button class="btn btn-secondary btn-small hide" id="btn-add-file-recipient" title="Add another recipient">+ Recipient</button>
            </div>
            <div id="file-recipient-fp" style="font-size:10px;color:var(--text-muted);margin-top:6px;margin-bottom:4px;">No recipient</div>
            <div id="file-recipients-list" style="font-size:10px;margin-bottom:14px;"></div>
          </div>
          <div class="field">
            <label class="field-label">Select File <span class="required">*</span></label>
            <div id="file-drop-zone" style="border:2px dashed var(--border);border-radius:var(--radius);padding:30px 20px;text-align:center;cursor:pointer;transition:all 0.2s;background:var(--input-bg);">
              <svg viewBox="0 0 24 24" fill="var(--text-muted)" width="32" height="32" style="margin-bottom:8px;"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
              <div style="font-size:11px;color:var(--text-muted);">Click to select or drag & drop</div>
              <div id="file-size-limit" style="font-size:9px;color:var(--text-dim);margin-top:4px;">Max 50 MB</div>
            </div>
            <input type="file" id="file-encrypt-input" class="hide">
          </div>
          <div id="file-info-display" class="hide" style="padding:12px;background:var(--surface);border:1px solid var(--accent);border-radius:var(--radius-sm);margin-bottom:14px;">
            <div style="display:flex;align-items:center;gap:10px;">
              <svg viewBox="0 0 24 24" fill="var(--accent)" width="20" height="20"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>
              <div style="flex:1;">
                <div id="file-info-name" style="font-size:11px;font-weight:600;word-break:break-all;"></div>
                <div id="file-info-meta" style="font-size:10px;color:var(--text-muted);margin-top:2px;"></div>
              </div>
              <button id="btn-file-clear" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;padding:4px;">✕</button>
            </div>
          </div>
        </div>
        <div id="attestation-fields" class="hide">
          <div class="field"><label class="field-label">Subject <span class="required">*</span></label><input type="text" id="att-subject" placeholder="Person, system, or process"></div>
          <div class="field"><label class="field-label">Scope</label><input type="text" id="att-scope" placeholder="e.g. ISO 27001:2022"></div>
          <div class="field"><label class="field-label">Control Reference</label><input type="text" id="att-control" placeholder="e.g. A.8.1"></div>
          <div class="field"><label class="field-label">Evidence Reference</label><input type="text" id="att-evidence" placeholder="Document ID or hash"></div>
          <div class="field"><label class="field-label">Validity</label><div style="display:flex;gap:8px;"><input type="date" id="att-valid-from" style="flex:1;"><input type="date" id="att-valid-until" style="flex:1;"></div></div>
          <div class="field"><label class="field-label">Statement <span class="required">*</span></label><textarea id="att-statement" placeholder="I attest that..."></textarea></div>
        </div>
        <div id="lora-fields" class="hide">
          <div style="background:var(--accent-subtle);padding:12px;border-radius:var(--radius-sm);margin-bottom:14px;">
            <div style="font-size:11px;font-weight:600;color:var(--accent);margin-bottom:4px;">SCP-1 LoRa Packet</div>
            <div style="font-size:10px;color:var(--text-secondary);">~110 bytes binary. Hash of payload + Ed25519 signature. Full CNP-1 notice stored separately.</div>
          </div>
          <div class="field"><label class="field-label">Payload to commit <span class="required">*</span></label><textarea id="lora-payload" placeholder="Content to hash (stored locally, not transmitted)"></textarea></div>
          <div id="lora-size" style="font-size:10px;color:var(--accent);margin-top:-10px;margin-bottom:14px;font-family:ui-monospace,monospace;"></div>
        </div>
        <div id="default-fields">
          <div class="field"><label class="field-label">Title</label><input type="text" id="notice-title" placeholder="Optional title"></div>
          <div class="field"><label class="field-label">Content <span class="required">*</span></label><textarea id="notice-content" placeholder="Your message"></textarea></div>
        </div>
        <!-- Cross-Notice Linking -->
        <div id="link-notice-section" style="margin-bottom:14px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <label class="field-label" style="margin:0;">Link Previous Notices</label>
            <button class="btn btn-secondary btn-small" id="btn-link-notice" style="font-size:10px;padding:4px 8px;">+ Add Link</button>
          </div>
          <div id="linked-notices-list" style="font-size:11px;color:var(--text-muted);"></div>
        </div>
        <div class="btn-row"><button class="btn btn-secondary" id="btn-step2-back">Back</button><button class="btn btn-primary" id="btn-step2-next">Continue</button></div>
      </div>
    </div>
    
    <div id="create-step-3" class="hide">
      <div class="card">
        <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div><div class="card-title">Select Identity & Sign</div><div class="card-subtitle">Choose signing key</div></div></div>
        <div id="pow-wait" class="pow-wait hide">Please wait <span id="pow-wait-time">30</span>s before signing (anti-spam)</div>
        <div id="identity-list"></div>
        <div id="security-level" class="hide" style="display:flex;align-items:center;gap:8px;padding:8px 12px;margin-bottom:10px;border-radius:var(--radius-sm);font-size:11px;">
          <span id="security-level-icon"></span>
          <span id="security-level-text"></span>
        </div>
        <div id="pow-status" class="pow-status hide">
          <div class="pow-label">Sequential PoW (not parallelizable)</div>
          <div class="pow-value" id="pow-value">0%</div>
          <div class="pow-progress"><div class="pow-progress-bar" id="pow-progress"></div></div>
          <div class="pow-detail" id="pow-detail"></div>
        </div>
        <div id="pow-custom-row" class="hide" style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:10px;">
          <div style="flex:1;">
            <div style="font-size:12px;font-weight:500;">PoW Strength <span class="pro-badge" style="font-size:8px;vertical-align:middle;">PRO</span></div>
            <div id="pow-custom-info" style="font-size:10px;color:var(--text-muted);margin-top:2px;font-family:ui-monospace,monospace;"></div>
          </div>
          <select id="pow-multiplier" style="background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;font-size:11px;font-family:inherit;">
            <option value="1">1× Standard</option>
            <option value="2">2× Enhanced</option>
            <option value="5">5× Strong</option>
            <option value="10">10× Maximum</option>
          </select>
        </div>
        <div class="divider" id="publish-divider">Publish</div>
        <div id="publish-toggle-row" style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:10px;cursor:pointer;">
          <div style="flex:1;">
            <div style="font-size:12px;font-weight:500;">Auto-Publish to Server</div>
            <div id="publish-server-info" class="hide" style="font-size:10px;color:var(--accent);font-family:ui-monospace,monospace;margin-top:2px;"></div>
          </div>
          <div id="publish-toggle" style="width:40px;height:22px;background:var(--surface-hover);border-radius:11px;position:relative;transition:all 0.2s;"><div style="position:absolute;width:18px;height:18px;background:white;border-radius:50%;top:2px;left:2px;transition:all 0.2s;"></div></div>
        </div>
        <div class="btn-row"><button class="btn btn-secondary" id="btn-step3-back">Back</button><button class="btn btn-primary" id="btn-step3-sign" disabled>Sign with PoW</button></div>
      </div>
    </div>
    
    <div id="create-step-4" class="hide">
      <div class="result-badge"><div class="result-badge-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div><div class="result-badge-text"><div class="result-badge-title">Signed</div><div class="result-badge-sub" id="sign-result-sub">Sequential PoW complete</div></div></div>
      <div id="publish-status-card" class="card hide">
        <div style="display:flex;align-items:center;gap:10px;">
          <div id="publish-status-icon" style="color:var(--accent);"><svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20" style="animation:spin 1s linear infinite;"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg></div>
          <div style="flex:1;">
            <div style="font-size:12px;font-weight:500;" id="publish-status-title">Publishing...</div>
            <div style="font-size:10px;color:var(--text-muted);" id="publish-status-detail"></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"/></svg></div><div><div class="card-title">Output</div><div class="card-subtitle" id="output-subtitle">CNP-1 Notice</div></div></div>
        <textarea id="signed-output" readonly style="min-height:150px;"></textarea>
        <div class="btn-row"><button class="btn btn-secondary" id="btn-copy-output">Copy JSON</button><button class="btn btn-secondary hide" id="btn-copy-packet">Copy Packet</button><button class="btn btn-secondary hide" id="btn-qr-packet">QR</button><button class="btn btn-secondary hide" id="btn-export-receipt">Receipt</button><button class="btn btn-secondary" id="btn-download-output">Download</button><button class="btn btn-accent" id="btn-save-vault">Save to Vault</button></div>
      </div>
<div id="file-output-card" class="card hide">
        <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm0 7V3.5L18.5 9H14zM12 11l-4 4h2.5v4h3v-4H16l-4-4z"/></svg></div><div><div class="card-title">Encrypted File</div><div class="card-subtitle" id="file-output-subtitle">ENV-F-1</div></div></div>
        <div id="file-output-info" style="padding:10px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:12px;font-size:11px;line-height:1.7;">
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" id="btn-download-encrypted-file">Download .lownet.enc</button>
          <button class="btn btn-secondary hide" id="btn-share-file" title="Share encrypted file">Share</button>
        </div>
      </div>
            <button class="btn btn-primary" id="btn-create-new" style="margin-top:14px;">Create Another</button>
    </div>
  </div>

  <!-- VERIFY TAB -->
  <div class="tab-content" id="tab-verify">
    <div class="card">
      <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg></div><div><div class="card-title">Verify Notice</div><div class="card-subtitle">Check signature + PoW</div></div></div>
      <div class="field"><label class="field-label">Input</label><textarea id="verify-input" placeholder="Paste JSON"></textarea></div>
      <div class="btn-row"><button class="btn btn-secondary" id="btn-load-verify">Load File</button><button class="btn btn-primary" id="btn-verify">Verify</button></div>
      <input type="file" id="file-verify" accept=".json" class="hide">
    </div>
    <div class="card" id="file-decrypt-card">
      <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm0 7V3.5L18.5 9H14zM12 11l-4 4h2.5v4h3v-4H16l-4-4z"/></svg></div><div><div class="card-title">Decrypt File <span class="pro-badge" id="decrypt-pro-badge">PRO</span></div><div class="card-subtitle">Open .lownet.enc files</div></div></div>
      <div class="btn-row" style="margin-top:0;"><button class="btn btn-primary" id="btn-load-encrypted-file">Load .lownet.enc</button></div>
      <input type="file" id="file-decrypt-input" accept=".enc,.json" class="hide">
      <div id="file-decrypt-status" class="hide" style="margin-top:12px;padding:12px;border-radius:var(--radius-sm);font-size:11px;"></div>
      <div id="file-decrypt-result" class="hide" style="margin-top:12px;">
        <div class="result-badge" id="file-decrypt-badge">
          <div class="result-badge-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"/></svg></div>
          <div class="result-badge-text">
            <div class="result-badge-title" id="file-decrypt-title">Decrypted</div>
            <div class="result-badge-sub" id="file-decrypt-sub"></div>
          </div>
        </div>
        <div id="file-decrypt-details" style="margin-bottom:12px;"></div>
        <div class="btn-row">
          <button class="btn btn-primary" id="btn-download-decrypted-file">Download File</button>
        </div>
      </div>
    </div>
    <div class="card" id="hash-verify-card">
      <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div><div><div class="card-title">File Hash</div><div class="card-subtitle">SHA-256 integrity check</div></div></div>
      <div id="hash-drop-zone" style="border:2px dashed var(--border);border-radius:var(--radius);padding:24px 16px;text-align:center;cursor:pointer;transition:all 0.2s;background:var(--input-bg);">
        <svg viewBox="0 0 24 24" fill="var(--text-muted)" width="28" height="28" style="margin-bottom:6px;"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
        <div style="font-size:11px;color:var(--text-muted);">Drop file or click to compute SHA-256</div>
      </div>
      <input type="file" id="hash-file-input" class="hide">
      <div id="hash-result" class="hide" style="margin-top:12px;">
        <div id="hash-file-info" style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;"></div>
        <div style="position:relative;">
          <div id="hash-output" style="font-family:ui-monospace,monospace;font-size:10px;background:var(--bg);padding:10px;border-radius:var(--radius-sm);word-break:break-all;color:var(--accent);line-height:1.6;user-select:all;"></div>
          <button id="btn-copy-hash" style="position:absolute;top:6px;right:6px;background:var(--surface);border:1px solid var(--border);border-radius:3px;color:var(--text-muted);cursor:pointer;font-size:9px;padding:3px 6px;">Copy</button>
        </div>
        <div id="hash-compare-section" style="margin-top:10px;">
          <div class="field">
            <label class="field-label">Compare with expected hash</label>
            <input type="text" id="hash-compare-input" placeholder="Paste SHA-256 to compare" style="font-family:ui-monospace,monospace;font-size:10px;">
          </div>
          <div id="hash-compare-result" class="hide" style="font-size:11px;padding:8px 10px;border-radius:var(--radius-sm);margin-top:4px;"></div>
        </div>
      </div>
    </div>
    <div id="verify-result" class="hide">
      <div class="result-badge" id="verify-badge"><div class="result-badge-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div><div class="result-badge-text"><div class="result-badge-title">Valid</div><div class="result-badge-sub">Verified</div></div></div>
      <div class="card"><div id="verify-details"></div><div class="divider">Content</div><div class="code-block" id="verify-content"></div><div class="btn-row"><button class="btn btn-accent" id="btn-verify-save">Save to Vault</button></div></div>
    </div>
  </div>

  <!-- VAULT TAB -->
  <div class="tab-content" id="tab-vault">
    <div class="card">
      <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg></div><div><div class="card-title">Your Vault</div><div class="card-subtitle">Local storage</div></div></div>
      <div class="btn-row" style="margin-top:0;"><button class="btn btn-secondary" id="btn-vault-export">Export</button><button class="btn btn-secondary" id="btn-vault-import">Import</button><button class="btn btn-secondary" id="btn-vault-clear">Clear</button></div>
      <input type="file" id="file-vault" accept=".json" class="hide">
    </div>
    <div id="vault-list"></div>
  </div>

  <!-- KEYS TAB -->
  <div class="tab-content" id="tab-keys">
    <div class="card">
      <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65z"/></svg></div><div><div class="card-title">Identity Management</div><div class="card-subtitle">Ed25519 + P-256 ECDH</div></div></div>
      <div class="btn-row" style="margin-top:0;"><button class="btn btn-primary" id="btn-new-identity">Create New</button><button class="btn btn-secondary" id="btn-load-identity">Load File</button></div>
      <input type="file" id="file-identity" accept=".json" class="hide">
    </div>
    <div id="new-identity-form" class="hide">
      <div class="card">
        <div class="field"><label class="field-label">Name <span class="required">*</span></label><input type="text" id="new-id-name" placeholder="Your name"></div>
        <div class="field"><label class="field-label">Passphrase <span class="required">*</span></label><input type="password" id="new-id-pass" placeholder="Encryption passphrase"></div>
        <div class="btn-row"><button class="btn btn-secondary" id="btn-cancel-identity">Cancel</button><button class="btn btn-primary" id="btn-create-identity">Create & Download</button></div>
      </div>
    </div>
    <div id="load-identity-form" class="hide">
      <div class="card">
        <div class="field"><label class="field-label">Passphrase</label><input type="password" id="load-id-pass" placeholder="Passphrase"></div>
        <button class="btn btn-secondary" id="btn-select-id-file">Select Identity File</button>
      </div>
    </div>
    <div id="keys-list"></div>
    
    <div class="divider">Address Book</div>
    <div class="card">
      <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div><div class="card-title">Contacts</div><div class="card-subtitle">Saved public keys</div></div></div>
      <div class="btn-row" style="margin-top:0;margin-bottom:12px;"><button class="btn btn-secondary" id="btn-add-contact">Add Contact</button></div>
      <div id="contacts-list"></div>
    </div>
    <div id="add-contact-form" class="hide">
      <div class="card">
        <div class="field"><label class="field-label">Name</label><input type="text" id="new-contact-name" placeholder="Contact name"></div>
        <div class="field"><label class="field-label">Public Key (JSON)</label><textarea id="new-contact-key" placeholder="Paste public key data" style="min-height:70px;"></textarea></div>
        <div id="new-contact-fp" style="font-size:10px;color:var(--text-muted);margin-bottom:12px;"></div>
        <div class="btn-row"><button class="btn btn-secondary" id="btn-cancel-contact">Cancel</button><button class="btn btn-primary" id="btn-save-contact">Save</button></div>
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div class="tab-content" id="tab-settings">
    <div class="card">
      <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg></div><div><div class="card-title">License</div><div class="card-subtitle">Free & PRO features</div></div></div>
      <div id="license-status" class="inactive">
        <div style="display:flex;align-items:center;gap:6px;">
          <span id="license-status-icon">○</span>
          <span id="license-status-text">Free — Text features only</span>
        </div>
      </div>
      <div id="license-free-info" style="font-size:10px;color:var(--text-muted);line-height:1.6;margin-bottom:12px;">
        <div style="margin-bottom:6px;font-weight:600;color:var(--text-secondary);">Included free:</div>
        <div>✓ Signed Statements & Commitments (CNP-1)</div>
        <div>✓ Encrypted Messages (ENV-1.2)</div>
        <div>✓ LoRa Commitments (SCP-1)</div>
        <div>✓ Attestations (ISO format)</div>
        <div>✓ Sequential Proof of Work</div>
        <div>✓ Identity Management & Contacts</div>
        <div>✓ File Hash Verification (SHA-256)</div>
        <div style="margin-top:8px;font-weight:600;color:var(--text-secondary);">PRO:</div>
        <div style="color:var(--accent);">Encrypted File Envelope (ENV-F-1) — up to 50 MB</div>
        <div style="color:var(--accent);">Native sharing via OS share sheet (AirDrop, Drive, Email, etc.)</div>
      </div>
      <div class="field">
        <label class="field-label">License Key</label>
        <textarea id="license-key-input" placeholder="LN-PRO-..." style="min-height:60px;font-family:ui-monospace,monospace;font-size:10px;"></textarea>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" id="btn-activate-license" style="flex:1;">Activate</button>
        <button class="btn btn-secondary hide" id="btn-remove-license">Remove</button>
      </div>
      <div id="license-detail" class="hide" style="margin-top:10px;font-size:10px;color:var(--text-muted);line-height:1.6;padding:8px;background:var(--bg);border-radius:var(--radius-sm);"></div>
      <div style="margin-top:10px;font-size:9px;color:var(--text-dim);text-align:center;">
        <a href="https://lownet.org/pro" style="color:var(--accent);text-decoration:none;">Get a PRO license → lownet.org/pro</a>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg></div><div><div class="card-title">Protocol</div><div class="card-subtitle">Anti-spam settings</div></div></div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:8px;">Server-enforced limits</div>
      <div style="font-size:11px;color:var(--text-secondary);line-height:1.6;margin-bottom:12px;padding:10px;background:var(--bg);border-radius:var(--radius-sm);">
        <div style="display:flex;justify-content:space-between;"><span>New identity</span><span style="color:var(--accent);font-family:ui-monospace,monospace;">2M rounds</span></div>
        <div style="display:flex;justify-content:space-between;"><span>Established</span><span style="color:var(--accent);font-family:ui-monospace,monospace;">500k rounds</span></div>
        <div style="display:flex;justify-content:space-between;"><span>Rate limit</span><span style="color:var(--accent);font-family:ui-monospace,monospace;">60s</span></div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:8px;">Envelope Privacy</div>
      <div style="display:flex;gap:8px;"><button class="btn btn-primary" id="btn-privacy-public" style="flex:1;padding:8px;font-size:12px;">Public</button><button class="btn btn-secondary" id="btn-privacy-private" style="flex:1;padding:8px;font-size:12px;">Private</button></div>
      <div style="font-size:9px;color:var(--text-muted);margin-top:6px;" id="privacy-desc">Public: Name visible to recipient</div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div><div><div class="card-title">Data</div><div class="card-subtitle">Backup & storage</div></div></div>
      <div class="btn-row" style="margin-bottom:12px;"><button class="btn btn-secondary" id="btn-full-backup" style="flex:1;">Export Backup</button><button class="btn btn-secondary" id="btn-restore-backup" style="flex:1;">Restore</button></div>
      <input type="file" id="file-backup" accept=".json" class="hide">
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:8px;">Integrity</div>
      <div id="toolkit-hash" style="font-family:ui-monospace,monospace;font-size:9px;background:var(--bg);padding:8px;border-radius:var(--radius-sm);word-break:break-all;color:var(--text-muted);margin-bottom:12px;">Calculating...</div>
      <button class="btn btn-secondary" id="btn-clear-all" style="width:100%;background:transparent;border-color:var(--error);color:var(--error);">Clear All Local Data</button>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg></div><div><div class="card-title">About</div><div class="card-subtitle">Version & credits</div></div></div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);"><span>Version</span><span style="font-family:ui-monospace,monospace;">1.1.2</span></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);gap:8px;"><span style="white-space:nowrap;">Protocols</span><span style="font-family:ui-monospace,monospace;font-size:10px;text-align:right;">CNP-1 · ENV-1.2 · SCP-1 · PoW-v2 · ENV-F-1 (PRO)</span></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0;"><span>Crypto</span><span style="font-family:ui-monospace,monospace;font-size:11px;">Ed25519 · P-256 · AES-GCM</span></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
        <a href="https://lownet.org" class="btn btn-secondary" style="font-size:11px;padding:6px 12px;width:auto;">Website</a>
        <a href="https://lownet.org/public/" class="btn btn-secondary" style="font-size:11px;padding:6px 12px;width:auto;">Public Board</a>
        <a href="https://github.com/lownetjs" class="btn btn-secondary" style="font-size:11px;padding:6px 12px;width:auto;">GitHub</a>
      </div>
      <div style="font-size:10px;color:var(--text-muted);line-height:1.5;padding-top:10px;border-top:1px solid var(--border);">© 2024-2026 LOWNET Contributors · MIT License</div>
    </div>
  </div>

  <div id="premium-modal" class="hide" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;">
    <div style="background:var(--surface);border:1px solid var(--accent);border-radius:var(--radius);max-width:400px;width:100%;padding:24px;text-align:center;">
      <div style="margin-bottom:8px;"><svg viewBox="0 0 24 24" fill="var(--accent)" width="32" height="32"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm0 7V3.5L18.5 9H14zM12 11l-4 4h2.5v4h3v-4H16l-4-4z"/></svg></div>
      <div style="font-size:16px;font-weight:700;margin-bottom:4px;">LOWNET PRO</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:16px;">This feature requires a PRO license · €20 one-time</div>
      <div style="font-size:11px;color:var(--text-secondary);line-height:1.6;margin-bottom:16px;text-align:left;padding:12px;background:var(--bg);border-radius:var(--radius-sm);">
        <div style="margin-bottom:4px;font-weight:600;">PRO includes:</div>
        <div>End-to-end encrypted file envelope (50 MB)</div>
        <div>Forward secrecy (ephemeral ECDH per file)</div>
        <div>Private & public sender modes</div>
        <div>Multi-recipient encryption</div>
        <div>Batch encrypt (multiple files)</div>
        <div>File padding (size obfuscation)</div>
        <div>Custom PoW (configurable rounds)</div>
        <div style="margin-top:6px;color:var(--accent);">Native share — AirDrop, Drive, Email, WhatsApp, etc.</div>
      </div>
      <div class="btn-row" style="justify-content:center;">
        <a href="https://lownet.org/pro" class="btn btn-primary" style="text-decoration:none;" target="_blank">Get PRO License</a>
        <button class="btn btn-secondary" id="btn-premium-modal-settings">Enter Key</button>
        <button class="btn btn-secondary" id="btn-premium-modal-close">Close</button>
      </div>
    </div>
  </div>

  <div id="unlock-modal" class="hide" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);max-width:400px;width:100%;padding:20px;">
      <div style="font-size:14px;font-weight:600;margin-bottom:4px;">Unlock Identity</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:16px;" id="unlock-modal-name"></div>
      <div class="field"><label class="field-label">Passphrase</label><input type="password" id="unlock-modal-pass" placeholder="Enter passphrase"></div>
      <div class="btn-row"><button class="btn btn-secondary" id="btn-unlock-cancel">Cancel</button><button class="btn btn-primary" id="btn-unlock-confirm">Unlock</button></div>
    </div>
  </div>

  <div id="clear-modal" class="hide" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;">
    <div style="background:var(--surface);border:1px solid var(--error);border-radius:var(--radius);max-width:400px;width:100%;padding:20px;">
      <div style="font-size:14px;font-weight:600;margin-bottom:4px;color:var(--error);">Delete All Local Data</div>
      <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;line-height:1.6;">
        This will permanently remove:
        <ul style="margin:8px 0 0 16px;color:var(--text-muted);font-size:11px;">
          <li>All identities and keys</li>
          <li>All vault items</li>
          <li>All settings</li>
        </ul>
      </div>
      <div class="field"><label class="field-label">Type <span style="color:var(--error);font-family:ui-monospace,monospace;">DELETE</span> to confirm</label><input type="text" id="clear-modal-confirm" placeholder="DELETE" autocomplete="off"></div>
      <div class="btn-row"><button class="btn btn-secondary" id="btn-clear-cancel">Cancel</button><button class="btn btn-secondary" id="btn-clear-confirm" style="background:var(--error);border-color:var(--error);color:white;">Delete Everything</button></div>
    </div>
  </div>

  <div id="contact-delete-modal" class="hide" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);max-width:400px;width:100%;padding:20px;">
      <div style="font-size:14px;font-weight:600;margin-bottom:4px;">Delete Contact</div>
      <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;line-height:1.6;">
        Are you sure you want to delete this contact?
        <div id="contact-delete-item-info" style="margin-top:8px;padding:8px;background:var(--bg);border-radius:var(--radius-sm);font-size:11px;color:var(--text-muted);"></div>
      </div>
      <div class="btn-row"><button class="btn btn-secondary" id="btn-contact-delete-cancel">Cancel</button><button class="btn btn-secondary" id="btn-contact-delete-confirm" style="background:var(--error);border-color:var(--error);color:white;">Delete</button></div>
    </div>
  </div>

  <div id="contacts-picker-modal" class="hide" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);max-width:400px;width:100%;padding:20px;max-height:80vh;overflow-y:auto;">
      <div style="font-size:14px;font-weight:600;margin-bottom:12px;">Select Contact</div>
      <div id="contacts-picker-list"></div>
      <div class="btn-row" style="margin-top:12px;"><button class="btn btn-secondary" id="btn-contacts-picker-cancel">Cancel</button></div>
    </div>
  </div>

  <!-- Link Notice Picker Modal -->
  <div id="link-notice-modal" class="hide" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);max-width:500px;width:100%;padding:20px;max-height:80vh;overflow-y:auto;">
      <div style="font-size:14px;font-weight:600;margin-bottom:4px;">Link Previous Notice</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:12px;">Select a notice from your vault to create a hash-link reference</div>
      <div id="link-notice-list" style="max-height:300px;overflow-y:auto;"></div>
      <div class="btn-row" style="margin-top:12px;"><button class="btn btn-secondary" id="btn-link-notice-cancel">Cancel</button></div>
    </div>
  </div>

  <!-- Generic Confirm Modal -->
  <div id="confirm-modal" class="hide" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1001;display:flex;align-items:center;justify-content:center;padding:16px;">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);max-width:400px;width:100%;padding:20px;">
      <div id="confirm-title" style="font-size:14px;font-weight:600;margin-bottom:4px;">Confirm</div>
      <div id="confirm-message" style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;line-height:1.6;"></div>
      <div id="confirm-detail" style="margin-bottom:16px;padding:10px;background:var(--bg);border-radius:var(--radius-sm);font-size:11px;color:var(--text-muted);display:none;"></div>
      <div class="btn-row">
        <button class="btn btn-secondary" id="btn-confirm-cancel">Cancel</button>
        <button class="btn btn-secondary" id="btn-confirm-ok" style="background:var(--error);border-color:var(--error);color:white;">Confirm</button>
      </div>
    </div>
  </div>

  <!-- PUBLIC TAB -->
  <div class="tab-content" id="tab-public">
    <div class="card">
      <div class="card-header"><div class="card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div><div><div class="card-title">Public Proofs</div><div class="card-subtitle">Official relay · lownet.org</div></div></div>
      <div class="btn-row" style="margin-top:8px;"><button class="btn btn-secondary" id="btn-connect-public" style="flex:1;">Connect</button><button class="btn btn-secondary" id="btn-refresh-public" style="padding:10px 14px;flex:0;"><svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button></div>
      <div style="margin-top:10px;padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:10px;color:var(--text-muted);line-height:1.5;">
        <span style="color:var(--text-secondary);font-weight:500;">Enterprise</span> — Self-hosted relay on your own infrastructure. <a href="mailto:mail@lownet.org" style="color:var(--accent);text-decoration:none;">Contact us →</a>
      </div>
    </div>
    <div id="public-status" style="font-size:10px;color:var(--text-muted);text-align:center;margin-bottom:14px;"></div>
    <div id="public-list"></div>
  </div>

  <footer class="footer" style="flex-direction:column;gap:12px;">
    <div class="footer-badges"><span class="footer-badge">Ed25519</span><span class="footer-badge">·</span><span class="footer-badge">Sequential PoW</span><span class="footer-badge">·</span><span class="footer-badge">Offline</span><span class="footer-badge">·</span><a href="/verify/" class="footer-badge" style="color:var(--accent);text-decoration:none;">Verify integrity</a></div>
    <div style="font-size:9px;color:var(--text-muted);text-align:center;line-height:1.6;opacity:0.6;font-style:italic;letter-spacing:0.3px;">If you don't need cryptography, you don't need LOWNET.<br>If you suddenly do — you're already too late.</div>
  </footer>

  <div class="status hide" id="global-status"></div>
</div>

<!-- Help Modal -->
<div class="modal-overlay hide" id="help-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">LOWNET Toolkit Help</div>
      <button class="modal-close" id="help-close">&times;</button>
    </div>
    <div class="modal-body">
      <h2>What is LOWNET?</h2>
      <p>LOWNET creates <strong>verifiable digital artifacts</strong> — signed statements, encrypted messages, and encrypted files that exist independently of any platform.</p>
      <p>Prove <em>who</em> said <em>what</em> and <em>when</em>, without relying on a central authority. Encrypt what matters — no server in the crypto path.</p>
      
      <h2>Protocols</h2>
      
      <h3>CNP-1 — Commitment Notice</h3>
      <p>A signed, timestamped statement with sequential Proof of Work.</p>
      <table>
        <tr><th>Field</th><th>Purpose</th></tr>
        <tr><td><code>ln_payload</code></td><td>What was said</td></tr>
        <tr><td><code>ln_signer</code></td><td>Who said it (Ed25519 public key)</td></tr>
        <tr><td><code>ln_timestamp</code></td><td>When (ISO 8601)</td></tr>
        <tr><td><code>ln_signature</code></td><td>Ed25519 signature</td></tr>
        <tr><td><code>ln_pow</code></td><td>Sequential hash-chain proof</td></tr>
      </table>
      
      <h3>ENV-1.2 — Encrypted Envelope</h3>
      <p>End-to-end encrypted messages with forward secrecy:</p>
      <ul>
        <li>Ephemeral ECDH key exchange per message — keys never reused</li>
        <li>AES-256-GCM with HKDF-derived keys</li>
        <li><strong>Public mode:</strong> Sender identity visible in header</li>
        <li><strong>Private mode:</strong> Sender identity encrypted inside envelope</li>
      </ul>
      <p style="font-size:10px;color:var(--text-muted);margin-top:6px;">Note: Private mode is pseudonymous, not anonymous. Same sender key = correlation possible.</p>
      
      <h3>ENV-F-1 — Encrypted File Envelope <span class="pro-badge">PRO</span></h3>
      <p>Binary file encryption up to 50 MB:</p>
      <ul>
        <li>Dual HKDF keys — separate keys for metadata and file content</li>
        <li>AAD binding — header integrity verified during decryption</li>
        <li>Forward secrecy — ephemeral ECDH per file</li>
        <li>Output: <code>.lownet.enc</code> binary blob — offline-decryptable</li>
        <li>Format: <code>[JSON header][0x00][AES-GCM ciphertext]</code></li>
        <li>Share via native OS share sheet (AirDrop, Drive, Email, etc.)</li>
      </ul>
      
      <h3>SCP-1 — Short Commitment Packet</h3>
      <p>110-byte binary format for constrained channels:</p>
      <ul>
        <li>Fits in a single LoRa frame (max ~200 bytes)</li>
        <li>Encodable as 147 characters Base64 or a QR code</li>
        <li>Contains: version, public key hash, payload hash, timestamp, signature</li>
      </ul>
      
      <h2>Identity</h2>
      <p>A cryptographic keypair representing you:</p>
      <table>
        <tr><th>Component</th><th>Purpose</th></tr>
        <tr><td>Ed25519</td><td>Signing (proves authorship)</td></tr>
        <tr><td>P-256 ECDH</td><td>Key exchange (encryption)</td></tr>
        <tr><td>Fingerprint</td><td>SHA-256(pubkey)[0:6] as hex, e.g. <code>AC:2E:09:7A:EF:FF</code></td></tr>
      </table>
      <p>Private keys are encrypted with your passphrase (PBKDF2 + AES-256-GCM) and never leave your device unencrypted.</p>
      
      <h2>Sequential PoW</h2>
      <p>Anti-spam proof that grows with each post:</p>
      <table>
        <tr><th>Property</th><th>Detail</th></tr>
        <tr><td>New identity</td><td>2,000,000 rounds</td></tr>
        <tr><td>Established</td><td>500,000 base + 20,000 per sequence</td></tr>
        <tr><td>Rate limit</td><td>60 seconds between signs</td></tr>
        <tr><td>Non-parallelizable</td><td>Each hash depends on the previous</td></tr>
        <tr><td>Payload-bound</td><td>PoW tied to content hash</td></tr>
      </table>
      
      <h2>Quick Start</h2>
      <ol>
        <li><strong>Create Identity</strong> — Keys tab → name + passphrase</li>
        <li><strong>Backup</strong> — Download the .json key file securely</li>
        <li><strong>Unlock</strong> — Enter passphrase to sign or encrypt</li>
        <li><strong>Create</strong> — Select template (Notice, Envelope, File, Attestation, LoRa)</li>
        <li><strong>Sign / Encrypt</strong> — PoW runs for notices; instant for envelopes and files</li>
        <li><strong>Share</strong> — Download, copy, save to vault, or share via OS share sheet</li>
      </ol>
      
      <h2>Security</h2>
      <table>
        <tr><th>Component</th><th>Algorithm</th></tr>
        <tr><td>Signing</td><td>Ed25519</td></tr>
        <tr><td>Key Exchange</td><td>P-256 ECDH (ephemeral)</td></tr>
        <tr><td>Encryption</td><td>AES-256-GCM</td></tr>
        <tr><td>Key Derivation</td><td>HKDF-SHA-256 (dual keys for files)</td></tr>
        <tr><td>Key Storage</td><td>PBKDF2 + AES-256-GCM</td></tr>
        <tr><td>Canonicalization</td><td>JCS / RFC 8785</td></tr>
        <tr><td>Integrity</td><td>SHA-256 + AAD binding</td></tr>
        <tr><td>Runtime</td><td>WebCrypto API (browser-native)</td></tr>
      </table>
      
      <h3>Hardening</h3>
      <ul>
        <li><strong>Auto-Lock</strong> — Keys cleared after 5 min idle</li>
        <li><strong>Rate Limit</strong> — Per-identity cooldown between signs</li>
        <li><strong>CSP Protected</strong> — Hash-based script-src, locked connect-src, no framing</li>
        <li><strong>Worker-based PoW</strong> — Background thread, no UI freeze</li>
        <li><strong>Forward Secrecy</strong> — Ephemeral keys per message and file</li>
        <li><strong>Zero dependencies</strong> — Single HTML file, no external libraries</li>
        <li><strong>Self-Integrity</strong> — SHA-256 hash verification (see below)</li>
      </ul>
      
      <h3>Browser Extensions</h3>
      <p style="color:var(--warning);">Browser extensions can read and modify page content, including keys and plaintext. LOWNET cannot detect or block them.</p>
      <p>For maximum security:</p>
      <ul>
        <li><strong>Install as PWA</strong> — Most browsers disable extensions in standalone app windows. Use the install button in the header.</li>
        <li><strong>Use Incognito / Private mode</strong> — Extensions are disabled by default (unless explicitly allowed).</li>
        <li><strong>Audit your extensions</strong> — Remove any you don't trust. One malicious extension compromises everything.</li>
      </ul>

      <h3>File Integrity</h3>
      <p>This toolkit computes its own SHA-256 hash on load. Compare it against the published release hash to detect tampering (MITM, CDN injection, silent updates).</p>
      <div style="margin:10px 0;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:ui-monospace,monospace;">
        <div style="font-size:9px;color:var(--text-muted);margin-bottom:4px;">SHA-256 of this file</div>
        <div style="font-size:11px;color:var(--accent);word-break:break-all;line-height:1.5;" id="self-integrity-hash">computing...</div>
      </div>
      <a href="https://lownet.org/verify" style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--accent);text-decoration:none;margin-top:4px;">Verify against published hash →</a>
      <p style="font-size:10px;color:var(--text-muted);margin-top:8px;">Or from terminal: <code style="background:var(--bg);padding:1px 5px;border-radius:3px;font-size:10px;">curl -s https://lownet.org/toolkit.html | sha256sum</code></p>
      
      <h2>Glossary</h2>
      <table>
        <tr><th>Term</th><th>Definition</th></tr>
        <tr><td>CNP-1</td><td>Commitment Notice Protocol v1 — Signed notice with PoW (JSON)</td></tr>
        <tr><td>ENV-1.2</td><td>Encrypted Envelope v1.2 — E2E encrypted messages</td></tr>
        <tr><td>ENV-F-1</td><td>Encrypted File Envelope — Binary file encryption (PRO)</td></tr>
        <tr><td>SCP-1</td><td>Short Commitment Packet — 110-byte binary for LoRa/QR</td></tr>
        <tr><td>Fingerprint</td><td>SHA-256(pubkey)[0:6] as hex pairs</td></tr>
        <tr><td>Forward Secrecy</td><td>Ephemeral keys per message — past comms stay secure</td></tr>
        <tr><td>AAD</td><td>Additional Authenticated Data — header bound to ciphertext</td></tr>
        <tr><td>HKDF</td><td>HMAC-based Key Derivation Function</td></tr>
        <tr><td>LoRa</td><td>Long Range radio — max ~200 bytes per packet</td></tr>
      </table>
      
      <p style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border);color:var(--text-muted);text-align:center;font-size:10px;">
        LOWNET Toolkit v1.1.2 · <a href="https://lownet.org" style="color:var(--accent);text-decoration:none;">lownet.org</a> · MIT License
      </p>
    </div>
  </div>
</div>

<!-- QR Modal (generation only, no scanning) -->
<div class="modal-overlay hide" id="qr-modal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-header">
      <div class="modal-title" id="qr-modal-title">QR Code</div>
      <button class="modal-close" id="qr-close">&times;</button>
    </div>
    <div class="modal-body" style="text-align:center;">
      <canvas id="qr-canvas" style="max-width:100%;border-radius:var(--radius);"></canvas>
      <div id="qr-data" style="font-size:9px;color:var(--text-muted);margin-top:12px;word-break:break-all;max-height:60px;overflow:auto;"></div>
    </div>
  </div>
</div>

<!-- QR Scan Modal (native BarcodeDetector) -->
<div class="modal-overlay hide" id="scan-modal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-header">
      <div class="modal-title">Scan QR Code</div>
      <button class="modal-close" id="scan-close">&times;</button>
    </div>
    <div class="modal-body" style="text-align:center;">
      <video id="scan-video" style="width:100%;max-height:300px;border-radius:var(--radius);background:#000;" playsinline></video>
      <div id="scan-status" style="font-size:11px;color:var(--text-muted);margin-top:8px;">Initializing camera...</div>
    </div>
  </div>
</div>

<!-- Terminal Overlay (Ctrl+K or ` to toggle) -->
<div id="terminal-overlay" class="hide" style="position:fixed;bottom:0;left:0;right:0;height:45%;background:var(--bg);border-top:2px solid var(--accent);z-index:1000;display:flex;flex-direction:column;font-family:ui-monospace,'SF Mono','Cascadia Mono','Segoe UI Mono',Consolas,monospace;">
  <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--surface);border-bottom:1px solid var(--border);">
    <span style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);font-weight:600;">LOWNET Terminal</span>
    <div style="display:flex;gap:8px;align-items:center;">
      <span id="term-status" style="font-size:9px;color:var(--text-muted);"></span>
      <button id="term-close" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:2px 6px;">&times;</button>
    </div>
  </div>
  <div id="term-output" style="flex:1;overflow-y:auto;padding:14px;font-size:11px;line-height:1.7;"></div>
  <div style="display:flex;align-items:center;padding:10px 14px;background:var(--surface);border-top:1px solid var(--border);">
    <span id="term-prompt" style="color:var(--accent);margin-right:10px;font-size:11px;">lownet&gt;</span>
    <input id="term-input" type="text" style="flex:1;background:transparent;border:none;color:var(--text);font-family:inherit;font-size:11px;outline:none;" placeholder="Type 'help' for commands" autocomplete="off" spellcheck="false">
  </div>
</div>

<script>
// LOWNET Toolkit v3 with Sequential PoW
var TOOLKIT_VERSION='1.1.2';
var TOOLKIT_HASH=null; // Computed on load

var $=function(id){return document.getElementById(id)};
var te=new TextEncoder(),td=new TextDecoder();
var identities=[],selectedTemplate=null,selectedIdentityId=null,pageLoadTime=Date.now();
var settings={envPrivacy:'public'};
var session={unlocked:new Map(),activeId:null,biometricEnableId:null};
var lastActivity=Date.now();
var LOCK_TIMEOUT=5*60*1000; // 5 minutes
var linkedNotices=[]; // For cross-notice linking
// Secure context check (fallback for older browsers that don't support window.isSecureContext)
var isSecureContext=window.isSecureContext||(location.protocol==='https:')||(location.hostname==='localhost')||(location.hostname==='127.0.0.1');

// Track activity
document.addEventListener('click',function(){lastActivity=Date.now()});
document.addEventListener('keydown',function(){lastActivity=Date.now()});

// Auto-lock timer
setInterval(function(){
  if(session.unlocked.size>0 && Date.now()-lastActivity>LOCK_TIMEOUT){
    session.unlocked.clear();
    session.activeId=null;
    identities=[];
    // Clear any open passphrase fields
    if($('unlock-modal-pass'))$('unlock-modal-pass').value='';
    if($('new-id-pass'))$('new-id-pass').value='';
    if($('load-id-pass'))$('load-id-pass').value='';
    renderKeys();
    renderLockStatus();
    showStatus('Auto-locked (5 min idle)');
  }
},30000);

// QR CODE GENERATION - qrcode-generator v1.4.4 (MIT License)
var qrcode=function(){var t=function(t,r){var e=t,n=g[r],o=null,i=0,a=null,u=[],f={},c=function(t,r){o=function(t){for(var r=new Array(t),e=0;e<t;e+=1){r[e]=new Array(t);for(var n=0;n<t;n+=1)r[e][n]=null}return r}(i=4*e+17),l(0,0),l(i-7,0),l(0,i-7),s(),h(),d(t,r),e>=7&&v(t),null==a&&(a=p(e,n,u)),w(a,r)},l=function(t,r){for(var e=-1;e<=7;e+=1)if(!(t+e<=-1||i<=t+e))for(var n=-1;n<=7;n+=1)r+n<=-1||i<=r+n||(o[t+e][r+n]=0<=e&&e<=6&&(0==n||6==n)||0<=n&&n<=6&&(0==e||6==e)||2<=e&&e<=4&&2<=n&&n<=4)},h=function(){for(var t=8;t<i-8;t+=1)null==o[t][6]&&(o[t][6]=t%2==0);for(var r=8;r<i-8;r+=1)null==o[6][r]&&(o[6][r]=r%2==0)},s=function(){for(var t=B.getPatternPosition(e),r=0;r<t.length;r+=1)for(var n=0;n<t.length;n+=1){var i=t[r],a=t[n];if(null==o[i][a])for(var u=-2;u<=2;u+=1)for(var f=-2;f<=2;f+=1)o[i+u][a+f]=-2==u||2==u||-2==f||2==f||0==u&&0==f}},v=function(t){for(var r=B.getBCHTypeNumber(e),n=0;n<18;n+=1){var a=!t&&1==(r>>n&1);o[Math.floor(n/3)][n%3+i-8-3]=a}for(n=0;n<18;n+=1){a=!t&&1==(r>>n&1);o[n%3+i-8-3][Math.floor(n/3)]=a}},d=function(t,r){for(var e=n<<3|r,a=B.getBCHTypeInfo(e),u=0;u<15;u+=1){var f=!t&&1==(a>>u&1);u<6?o[u][8]=f:u<8?o[u+1][8]=f:o[i-15+u][8]=f}for(u=0;u<15;u+=1){f=!t&&1==(a>>u&1);u<8?o[8][i-u-1]=f:u<9?o[8][15-u-1+1]=f:o[8][15-u-1]=f}o[i-8][8]=!t},w=function(t,r){for(var e=-1,n=i-1,a=7,u=0,f=B.getMaskFunction(r),c=i-1;c>0;c-=2)for(6==c&&(c-=1);;){for(var g=0;g<2;g+=1)if(null==o[n][c-g]){var l=!1;u<t.length&&(l=1==(t[u]>>>a&1)),f(n,c-g)&&(l=!l),o[n][c-g]=l,-1==(a-=1)&&(u+=1,a=7)}if((n+=e)<0||i<=n){n-=e,e=-e;break}}},p=function(t,r,e){for(var n=A.getRSBlocks(t,r),o=b(),i=0;i<e.length;i+=1){var a=e[i];o.put(a.getMode(),4),o.put(a.getLength(),B.getLengthInBits(a.getMode(),t)),a.write(o)}var u=0;for(i=0;i<n.length;i+=1)u+=n[i].dataCount;if(o.getLengthInBits()>8*u)throw"code length overflow. ("+o.getLengthInBits()+">"+8*u+")";for(o.getLengthInBits()+4<=8*u&&o.put(0,4);o.getLengthInBits()%8!=0;)o.putBit(!1);for(;!(o.getLengthInBits()>=8*u||(o.put(236,8),o.getLengthInBits()>=8*u));)o.put(17,8);return function(t,r){for(var e=0,n=0,o=0,i=new Array(r.length),a=new Array(r.length),u=0;u<r.length;u+=1){var f=r[u].dataCount,c=r[u].totalCount-f;n=Math.max(n,f),o=Math.max(o,c),i[u]=new Array(f);for(var g=0;g<i[u].length;g+=1)i[u][g]=255&t.getBuffer()[g+e];e+=f;var l=B.getErrorCorrectPolynomial(c),h=k(i[u],l.getLength()-1).mod(l);for(a[u]=new Array(l.getLength()-1),g=0;g<a[u].length;g+=1){var s=g+h.getLength()-a[u].length;a[u][g]=s>=0?h.getAt(s):0}}var v=0;for(g=0;g<r.length;g+=1)v+=r[g].totalCount;var d=new Array(v),w=0;for(g=0;g<n;g+=1)for(u=0;u<r.length;u+=1)g<i[u].length&&(d[w]=i[u][g],w+=1);for(g=0;g<o;g+=1)for(u=0;u<r.length;u+=1)g<a[u].length&&(d[w]=a[u][g],w+=1);return d}(o,n)};f.addData=function(t,r){var e=null;switch(r=r||"Byte"){case"Numeric":e=M(t);break;case"Alphanumeric":e=x(t);break;case"Byte":e=m(t);break;case"Kanji":e=L(t);break;default:throw"mode:"+r}u.push(e),a=null},f.isDark=function(t,r){if(t<0||i<=t||r<0||i<=r)throw t+","+r;return o[t][r]},f.getModuleCount=function(){return i},f.make=function(){if(e<1){for(var t=1;t<40;t++){for(var r=A.getRSBlocks(t,n),o=b(),i=0;i<u.length;i++){var a=u[i];o.put(a.getMode(),4),o.put(a.getLength(),B.getLengthInBits(a.getMode(),t)),a.write(o)}var g=0;for(i=0;i<r.length;i++)g+=r[i].dataCount;if(o.getLengthInBits()<=8*g)break}e=t}c(!1,function(){for(var t=0,r=0,e=0;e<8;e+=1){c(!0,e);var n=B.getLostPoint(f);(0==e||t>n)&&(t=n,r=e)}return r}())},f.renderTo2dContext=function(t,r){r=r||2;for(var e=f.getModuleCount(),n=0;n<e;n++)for(var o=0;o<e;o++)t.fillStyle=f.isDark(n,o)?"black":"white",t.fillRect(n*r,o*r,r,r)};return f};t.stringToBytes=(t.stringToBytesFuncs={default:function(t){for(var r=[],e=0;e<t.length;e+=1){var n=t.charCodeAt(e);r.push(255&n)}return r}}).default;var r,e,n,o,i,a=1,u=2,f=4,c=8,g={L:1,M:0,Q:3,H:2},l=0,h=1,s=2,v=3,d=4,w=5,p=6,y=7,B=(r=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],e=1335,n=7973,i=function(t){for(var r=0;0!=t;)r+=1,t>>>=1;return r},(o={}).getBCHTypeInfo=function(t){for(var r=t<<10;i(r)-i(e)>=0;)r^=e<<i(r)-i(e);return 21522^(t<<10|r)},o.getBCHTypeNumber=function(t){for(var r=t<<12;i(r)-i(n)>=0;)r^=n<<i(r)-i(n);return t<<12|r},o.getPatternPosition=function(t){return r[t-1]},o.getMaskFunction=function(t){switch(t){case l:return function(t,r){return(t+r)%2==0};case h:return function(t,r){return t%2==0};case s:return function(t,r){return r%3==0};case v:return function(t,r){return(t+r)%3==0};case d:return function(t,r){return(Math.floor(t/2)+Math.floor(r/3))%2==0};case w:return function(t,r){return t*r%2+t*r%3==0};case p:return function(t,r){return(t*r%2+t*r%3)%2==0};case y:return function(t,r){return(t*r%3+(t+r)%2)%2==0};default:throw"bad maskPattern:"+t}},o.getErrorCorrectPolynomial=function(t){for(var r=k([1],0),e=0;e<t;e+=1)r=r.multiply(k([1,C.gexp(e)],0));return r},o.getLengthInBits=function(t,r){if(1<=r&&r<10)switch(t){case a:return 10;case u:return 9;case f:case c:return 8;default:throw"mode:"+t}else if(r<27)switch(t){case a:return 12;case u:return 11;case f:return 16;case c:return 10;default:throw"mode:"+t}else{if(!(r<41))throw"type:"+r;switch(t){case a:return 14;case u:return 13;case f:return 16;case c:return 12;default:throw"mode:"+t}}},o.getLostPoint=function(t){for(var r=t.getModuleCount(),e=0,n=0;n<r;n+=1)for(var o=0;o<r;o+=1){for(var i=0,a=t.isDark(n,o),u=-1;u<=1;u+=1)if(!(n+u<0||r<=n+u))for(var f=-1;f<=1;f+=1)o+f<0||r<=o+f||0==u&&0==f||a==t.isDark(n+u,o+f)&&(i+=1);i>5&&(e+=3+i-5)}for(n=0;n<r-1;n+=1)for(o=0;o<r-1;o+=1){var c=0;t.isDark(n,o)&&(c+=1),t.isDark(n+1,o)&&(c+=1),t.isDark(n,o+1)&&(c+=1),t.isDark(n+1,o+1)&&(c+=1),0!=c&&4!=c||(e+=3)}for(n=0;n<r;n+=1)for(o=0;o<r-6;o+=1)t.isDark(n,o)&&!t.isDark(n,o+1)&&t.isDark(n,o+2)&&t.isDark(n,o+3)&&t.isDark(n,o+4)&&!t.isDark(n,o+5)&&t.isDark(n,o+6)&&(e+=40);for(o=0;o<r;o+=1)for(n=0;n<r-6;n+=1)t.isDark(n,o)&&!t.isDark(n+1,o)&&t.isDark(n+2,o)&&t.isDark(n+3,o)&&t.isDark(n+4,o)&&!t.isDark(n+5,o)&&t.isDark(n+6,o)&&(e+=40);var g=0;for(o=0;o<r;o+=1)for(n=0;n<r;n+=1)t.isDark(n,o)&&(g+=1);return e+=Math.abs(100*g/r/r-50)/5*10},o),C=function(){for(var t=new Array(256),r=new Array(256),e=0;e<8;e+=1)t[e]=1<<e;for(e=8;e<256;e+=1)t[e]=t[e-4]^t[e-5]^t[e-6]^t[e-8];for(e=0;e<255;e+=1)r[t[e]]=e;var n={glog:function(t){if(t<1)throw"glog("+t+")";return r[t]},gexp:function(r){for(;r<0;)r+=255;for(;r>=256;)r-=255;return t[r]}};return n}();function k(t,r){if(void 0===t.length)throw t.length+"/"+r;var e=function(){for(var e=0;e<t.length&&0==t[e];)e+=1;for(var n=new Array(t.length-e+r),o=0;o<t.length-e;o+=1)n[o]=t[o+e];return n}(),n={getAt:function(t){return e[t]},getLength:function(){return e.length},multiply:function(t){for(var r=new Array(n.getLength()+t.getLength()-1),e=0;e<n.getLength();e+=1)for(var o=0;o<t.getLength();o+=1)r[e+o]^=C.gexp(C.glog(n.getAt(e))+C.glog(t.getAt(o)));return k(r,0)},mod:function(t){if(n.getLength()-t.getLength()<0)return n;for(var r=C.glog(n.getAt(0))-C.glog(t.getAt(0)),e=new Array(n.getLength()),o=0;o<n.getLength();o+=1)e[o]=n.getAt(o);for(o=0;o<t.getLength();o+=1)e[o]^=C.gexp(C.glog(t.getAt(o))+r);return k(e,0).mod(t)}};return n}var A=function(){var t=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12,7,37,13],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],r=function(t,r){var e={};return e.totalCount=t,e.dataCount=r,e},e={};return e.getRSBlocks=function(e,n){var o=function(r,e){switch(e){case g.L:return t[4*(r-1)+0];case g.M:return t[4*(r-1)+1];case g.Q:return t[4*(r-1)+2];case g.H:return t[4*(r-1)+3];default:return}}(e,n);if(void 0===o)throw"bad rs block @ typeNumber:"+e+"/errorCorrectionLevel:"+n;for(var i=o.length/3,a=[],u=0;u<i;u+=1)for(var f=o[3*u+0],c=o[3*u+1],l=o[3*u+2],h=0;h<f;h+=1)a.push(r(c,l));return a},e}(),b=function(){var t=[],r=0,e={getBuffer:function(){return t},getAt:function(r){var e=Math.floor(r/8);return 1==(t[e]>>>7-r%8&1)},put:function(t,r){for(var n=0;n<r;n+=1)e.putBit(1==(t>>>r-n-1&1))},getLengthInBits:function(){return r},putBit:function(e){var n=Math.floor(r/8);t.length<=n&&t.push(0),e&&(t[n]|=128>>>r%8),r+=1}};return e},M=function(t){var r=a,e=t,n={getMode:function(){return r},getLength:function(t){return e.length},write:function(t){for(var r=e,n=0;n+2<r.length;)t.put(o(r.substring(n,n+3)),10),n+=3;n<r.length&&(r.length-n==1?t.put(o(r.substring(n,n+1)),4):r.length-n==2&&t.put(o(r.substring(n,n+2)),7))}},o=function(t){for(var r=0,e=0;e<t.length;e+=1)r=10*r+i(t.charAt(e));return r},i=function(t){if("0"<=t&&t<="9")return t.charCodeAt(0)-"0".charCodeAt(0);throw"illegal char :"+t};return n},x=function(t){var r=u,e=t,n={getMode:function(){return r},getLength:function(t){return e.length},write:function(t){for(var r=e,n=0;n+1<r.length;)t.put(45*o(r.charAt(n))+o(r.charAt(n+1)),11),n+=2;n<r.length&&t.put(o(r.charAt(n)),6)}},o=function(t){if("0"<=t&&t<="9")return t.charCodeAt(0)-"0".charCodeAt(0);if("A"<=t&&t<="Z")return t.charCodeAt(0)-"A".charCodeAt(0)+10;switch(t){case" ":return 36;case"$":return 37;case"%":return 38;case"*":return 39;case"+":return 40;case"-":return 41;case".":return 42;case"/":return 43;case":":return 44;default:throw"illegal char :"+t}};return n},m=function(r){var e=f,n=t.stringToBytes(r),o={getMode:function(){return e},getLength:function(t){return n.length},write:function(t){for(var r=0;r<n.length;r+=1)t.put(n[r],8)}};return o},L=function(r){var e=c,n=t.stringToBytesFuncs.SJIS;if(!n)throw"sjis not supported.";!function(){var t=n("友");if(2!=t.length||38726!=(t[0]<<8|t[1]))throw"sjis not supported."}();var o=n(r),i={getMode:function(){return e},getLength:function(t){return~~(o.length/2)},write:function(t){for(var r=o,e=0;e+1<r.length;){var n=(255&r[e])<<8|255&r[e+1];if(33088<=n&&n<=40956)n-=33088;else{if(!(57408<=n&&n<=60351))throw"illegal char at "+(e+1)+"/"+n;n-=49472}n=192*(n>>>8&255)+(255&n),t.put(n,13),e+=2}if(e<r.length)throw"illegal char at "+(e+1)}};return i};return t}();
qrcode.stringToBytesFuncs["UTF-8"]=function(t){return function(t){for(var r=[],e=0;e<t.length;e++){var n=t.charCodeAt(e);n<128?r.push(n):n<2048?r.push(192|n>>6,128|63&n):n<55296||n>=57344?r.push(224|n>>12,128|n>>6&63,128|63&n):(e++,n=65536+((1023&n)<<10|1023&t.charCodeAt(e)),r.push(240|n>>18,128|n>>12&63,128|n>>6&63,128|63&n))}return r}(t)};


function generateQR(text,canvas,size){
  var ctx=canvas.getContext('2d');
  canvas.width=size;canvas.height=size;
  ctx.fillStyle='#ffffff';
  ctx.fillRect(0,0,size,size);
  try{
    var qr=qrcode(0,'M');
    qr.addData(text);
    qr.make();
    var moduleCount=qr.getModuleCount();
    var cellSize=Math.floor((size-16)/moduleCount);
    var offset=Math.floor((size-cellSize*moduleCount)/2);
    ctx.fillStyle='#000000';
    for(var row=0;row<moduleCount;row++){
      for(var col=0;col<moduleCount;col++){
        if(qr.isDark(row,col)){
          ctx.fillRect(offset+col*cellSize,offset+row*cellSize,cellSize,cellSize);
        }
      }
    }
  }catch(e){
    ctx.fillStyle='#c00';ctx.font='11px sans-serif';ctx.textAlign='center';
    ctx.fillText('QR Error: '+e.message,size/2,size/2);
  }
}

function showQR(title,data){
  $('qr-modal-title').textContent=title;
  $('qr-data').textContent=data.length>100?data.slice(0,100)+'...':data;
  generateQR(data,$('qr-canvas'),280);
  $('qr-modal').classList.remove('hide');
}
$('qr-close').onclick=function(){$('qr-modal').classList.add('hide')};
$('qr-modal').onclick=function(e){if(e.target===this)this.classList.add('hide')};

// QR SCANNING - Native BarcodeDetector API (Chrome/Edge only)
var scanStream=null,scanCallback=null;
function startQRScan(onResult){
  if(!('BarcodeDetector' in window)){
    showStatus('QR scan not supported in this browser (use Chrome/Edge)','error');
    return;
  }
  scanCallback=onResult;
  $('scan-status').textContent='Initializing camera...';
  $('scan-modal').classList.remove('hide');
  var video=$('scan-video');
  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(function(stream){
    scanStream=stream;
    video.srcObject=stream;
    video.play();
    $('scan-status').textContent='Point camera at QR code';
    var detector=new BarcodeDetector({formats:['qr_code']});
    var scanning=true;
    function scan(){
      if(!scanning||video.readyState!==4)return requestAnimationFrame(scan);
      detector.detect(video).then(function(codes){
        if(codes.length>0){
          scanning=false;
          stopQRScan();
          if(scanCallback)scanCallback(codes[0].rawValue);
        }else{
          requestAnimationFrame(scan);
        }
      }).catch(function(){requestAnimationFrame(scan)});
    }
    scan();
  }).catch(function(e){
    $('scan-status').textContent='Camera error: '+e.message;
  });
}
function stopQRScan(){
  if(scanStream){scanStream.getTracks().forEach(function(t){t.stop()});scanStream=null}
  $('scan-video').srcObject=null;
  $('scan-modal').classList.add('hide');
}
$('scan-close').onclick=stopQRScan;
$('scan-modal').onclick=function(e){if(e.target===this)stopQRScan()};

function b64(bytes){var s='';for(var i=0;i<bytes.length;i++)s+=String.fromCharCode(bytes[i]);return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')}
function unb64(s){var p=s.replace(/-/g,'+').replace(/_/g,'/')+'==='.slice((s.length+3)%4);var bin=atob(p),out=new Uint8Array(bin.length);for(var i=0;i<bin.length;i++)out[i]=bin.charCodeAt(i);return out}
function bytesToHex(bytes){return Array.from(bytes).map(function(b){return b.toString(16).padStart(2,'0')}).join('')}
function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}
function sha256(d){return crypto.subtle.digest('SHA-256',typeof d==='string'?te.encode(d):d).then(function(h){return new Uint8Array(h)})}
function canonicalize(v){if(v===null)return'null';if(v===undefined)return undefined;var t=typeof v;if(t==='boolean')return v?'true':'false';if(t==='number')return Object.is(v,-0)?'0':String(v);if(t==='string')return JSON.stringify(v.normalize('NFC'));if(Array.isArray(v))return'['+v.map(canonicalize).join(',')+']';if(t==='object'){var k=Object.keys(v).sort(),p=[];for(var i=0;i<k.length;i++){var c=canonicalize(v[k[i]]);if(c!==undefined)p.push(JSON.stringify(k[i])+':'+c)}return'{'+p.join(',')+'}'}throw new Error('type')}
function showStatus(msg,type){var el=$('global-status');el.textContent=msg;el.className='status '+(type||'success');el.classList.remove('hide');setTimeout(function(){el.classList.add('hide')},3000)}

// Styled confirm dialog
var confirmResolve=null;
function showConfirm(title,message,detail,confirmText){
  return new Promise(function(resolve){
    confirmResolve=resolve;
    $('confirm-title').textContent=title||'Confirm';
    $('confirm-message').textContent=message||'Are you sure?';
    if(detail){
      $('confirm-detail').textContent=detail;
      $('confirm-detail').style.display='block';
    }else{
      $('confirm-detail').style.display='none';
    }
    $('btn-confirm-ok').textContent=confirmText||'Confirm';
    $('confirm-modal').classList.remove('hide');
    $('confirm-modal').style.display='flex';
  });
}
$('btn-confirm-cancel').onclick=function(){
  $('confirm-modal').classList.add('hide');
  $('confirm-modal').style.display='none';
  if(confirmResolve)confirmResolve(false);
  confirmResolve=null;
};
$('btn-confirm-ok').onclick=function(){
  $('confirm-modal').classList.add('hide');
  $('confirm-modal').style.display='none';
  if(confirmResolve)confirmResolve(true);
  confirmResolve=null;
};
$('confirm-modal').onclick=function(e){
  if(e.target===this){
    $('confirm-modal').classList.add('hide');
    $('confirm-modal').style.display='none';
    if(confirmResolve)confirmResolve(false);
    confirmResolve=null;
  }
};

// SEQUENTIAL POW - runs in Web Worker to prevent UI freeze
var powWorkerCode=`
self.onmessage=async function(e){
  var seed=e.data.seed,rounds=e.data.rounds;
  var te=new TextEncoder();
  async function sha256(d){var buf=await crypto.subtle.digest('SHA-256',typeof d==='string'?te.encode(d):d);return new Uint8Array(buf)}
  function bytesToHex(bytes){return Array.from(bytes).map(function(b){return b.toString(16).padStart(2,'0')}).join('')}
  var h=await sha256(seed);
  var start=Date.now(),rep=Math.max(1,Math.floor(rounds/50));
  for(var i=0;i<rounds;){
    var batch=Math.min(rep,rounds-i);
    for(var j=0;j<batch;j++)h=await sha256(h);
    i+=batch;
    self.postMessage({type:'progress',i:i,rounds:rounds,elapsed:Date.now()-start});
  }
  self.postMessage({type:'done',result:bytesToHex(h),rounds:rounds,time_ms:Date.now()-start});
};
`;
var powWorkerBlob=new Blob([powWorkerCode],{type:'application/javascript'});
var powWorkerUrl=URL.createObjectURL(powWorkerBlob);
var activePowWorker=null;

function sequentialPoW(seed,rounds,onProgress){
  return new Promise(function(resolve,reject){
    if(activePowWorker){activePowWorker.terminate();activePowWorker=null}
    var worker=new Worker(powWorkerUrl);
    activePowWorker=worker;
    worker.onmessage=function(e){
      if(e.data.type==='progress'){
        if(onProgress)onProgress(e.data.i,e.data.rounds,e.data.elapsed);
      }else if(e.data.type==='done'){
        activePowWorker=null;
        worker.terminate();
        resolve({result:e.data.result,rounds:e.data.rounds,time_ms:e.data.time_ms});
      }
    };
    worker.onerror=function(err){
      activePowWorker=null;
      worker.terminate();
      reject(new Error('PoW Worker error'));
    };
    worker.postMessage({seed:seed,rounds:rounds});
  });
}

function cancelPoW(){
  if(activePowWorker){activePowWorker.terminate();activePowWorker=null;return true}
  return false;
}

function buildPoWSeed(fp,seq,prev,payloadHash){return fp+'|'+seq+'|'+(prev||'null')+'|'+payloadHash}
function getDayEpoch(){return Math.floor(Date.now()/86400000)}
function getElapsed(){return Math.floor((Date.now()-pageLoadTime)/1000)}
function getMinWait(){return 60}
function getBaseRounds(seq){return (seq||1)<=5?2000000:500000}
function getStepRounds(){return 20000}
function requiredRounds(seq){return getBaseRounds(seq)+getStepRounds()*(seq-1)}

function fingerprint(pub){var bytes=pub instanceof Uint8Array?pub:unb64(pub.indexOf&&pub.indexOf('ed25519:')===0?pub.slice(8):pub);return sha256(bytes).then(function(h){return Array.from(h.slice(0,6)).map(function(b){return b.toString(16).padStart(2,'0').toUpperCase()}).join(':')})}

// SCP-1: Signed Commitment Packet for LoRa (~110 bytes)
// Format: V(1) + T(1) + TS(4) + FP(6) + SEQ(2) + HASH(32) + SIG(64) = 110 bytes
var SCP1_VERSION=0x01;
var SCP1_TYPES={statement:0x01,commitment:0x02,attestation:0x03,disclosure:0x04};

function encodeSCP1(identity,type,payloadHash){
  // payloadHash is Uint8Array(32)
  var ts=Math.floor(Date.now()/1000);
  var fpBytes=identity.fp.split(':').map(function(x){return parseInt(x,16)});
  var seq=identity.seq||0;
  var typeCode=SCP1_TYPES[type]||0x01;
  
  // Build data to sign: V|T|TS|FP|SEQ|HASH (46 bytes)
  var dataToSign=new Uint8Array(46);
  dataToSign[0]=SCP1_VERSION;
  dataToSign[1]=typeCode;
  dataToSign[2]=(ts>>24)&0xff;
  dataToSign[3]=(ts>>16)&0xff;
  dataToSign[4]=(ts>>8)&0xff;
  dataToSign[5]=ts&0xff;
  for(var i=0;i<6;i++)dataToSign[6+i]=fpBytes[i];
  dataToSign[12]=(seq>>8)&0xff;
  dataToSign[13]=seq&0xff;
  for(var i=0;i<32;i++)dataToSign[14+i]=payloadHash[i];
  
  return crypto.subtle.sign('Ed25519',identity._keys.sign.privateKey,dataToSign).then(function(sig){
    var sigBytes=new Uint8Array(sig);
    var packet=new Uint8Array(110);
    packet.set(dataToSign,0);
    packet.set(sigBytes,46);
    return{
      packet:packet,
      hex:Array.from(packet).map(function(b){return b.toString(16).padStart(2,'0')}).join(''),
      b64:b64(packet),
      ts:ts,
      fp:identity.fp,
      seq:seq,
      hash:bytesToHex(payloadHash),
      size:110
    };
  });
}

function decodeSCP1(data){
  var bytes;
  if(typeof data==='string'){
    if(data.length===220)bytes=new Uint8Array(data.match(/.{2}/g).map(function(x){return parseInt(x,16)}));
    else bytes=unb64(data);
  }else bytes=data;
  if(bytes.length!==110)return{valid:false,error:'Invalid SCP-1 length'};
  var v=bytes[0];
  if(v!==SCP1_VERSION)return{valid:false,error:'Unknown SCP-1 version'};
  var typeCode=bytes[1];
  var typeName=Object.keys(SCP1_TYPES).find(function(k){return SCP1_TYPES[k]===typeCode})||'unknown';
  var ts=(bytes[2]<<24)|(bytes[3]<<16)|(bytes[4]<<8)|bytes[5];
  var fp=Array.from(bytes.slice(6,12)).map(function(b){return b.toString(16).padStart(2,'0').toUpperCase()}).join(':');
  var seq=(bytes[12]<<8)|bytes[13];
  var hash=bytesToHex(bytes.slice(14,46));
  var sig=bytes.slice(46,110);
  var dataToVerify=bytes.slice(0,46);
  return{
    valid:true,
    version:v,
    type:typeName,
    ts:ts,
    timestamp:new Date(ts*1000).toISOString(),
    fp:fp,
    seq:seq,
    hash:hash,
    sig:sig,
    dataToVerify:dataToVerify
  };
}

function verifySCP1(data,pubKeyBytes){
  var decoded=decodeSCP1(data);
  if(!decoded.valid)return Promise.resolve(decoded);
  return crypto.subtle.importKey('raw',pubKeyBytes,'Ed25519',false,['verify']).then(function(pubKey){
    return crypto.subtle.verify('Ed25519',pubKey,decoded.sig,decoded.dataToVerify).then(function(valid){
      decoded.signatureValid=valid;
      if(!valid)decoded.error='Invalid signature';
      return decoded;
    });
  }).catch(function(e){
    decoded.valid=false;
    decoded.error=e.message;
    return decoded;
  });
}

// IDENTITY
function genIdentity(name){
  return crypto.subtle.generateKey('Ed25519',true,['sign','verify']).then(function(sign){
    return Promise.all([crypto.subtle.exportKey('raw',sign.publicKey),crypto.subtle.exportKey('pkcs8',sign.privateKey)]).then(function(keys){
      var signPub=new Uint8Array(keys[0]),signPriv=new Uint8Array(keys[1]);
      return crypto.subtle.generateKey({name:'ECDH',namedCurve:'P-256'},true,['deriveBits']).then(function(dh){
        return Promise.all([crypto.subtle.exportKey('jwk',dh.publicKey),crypto.subtle.exportKey('jwk',dh.privateKey)]).then(function(dhKeys){
          return fingerprint(signPub).then(function(fp){
            return{id:fp,name:name,sign:{pub:b64(signPub),priv:b64(signPriv)},dh:{pub:dhKeys[0],priv:dhKeys[1]},fp:fp,created:new Date().toISOString(),seq:0,prevHash:null}
          })
        })
      })
    })
  })
}

function pubBundle(id){return{name:id.name,sign:'ed25519:'+id.sign.pub,dh:{kty:id.dh.pub.kty,crv:id.dh.pub.crv,x:id.dh.pub.x,y:id.dh.pub.y},fp:id.fp}}

function encryptIdentity(id,pass){
  var salt=crypto.getRandomValues(new Uint8Array(16)),iv=crypto.getRandomValues(new Uint8Array(12));
  return crypto.subtle.importKey('raw',te.encode(pass),'PBKDF2',false,['deriveKey']).then(function(key){
    return crypto.subtle.deriveKey({name:'PBKDF2',salt:salt,iterations:600000,hash:'SHA-256'},key,{name:'AES-GCM',length:256},false,['encrypt']).then(function(aes){
      var plain=JSON.stringify({id:id.id,name:id.name,sign:id.sign,dh:id.dh,fp:id.fp,created:id.created,seq:id.seq||0,prevHash:id.prevHash||null});
      return crypto.subtle.encrypt({name:'AES-GCM',iv:iv},aes,te.encode(plain)).then(function(ct){
        return{t:'LOWNET_ID',v:4,s:b64(salt),i:b64(iv),c:b64(new Uint8Array(ct)),iter:600000}
      })
    })
  })
}

function decryptIdentity(data,pass){
  // Backward-compatible: v4 stores iter, v3 used 200000, v2/v1 used 100000
  var iterations=data.iter||((data.v>=3)?200000:100000);
  return crypto.subtle.importKey('raw',te.encode(pass),'PBKDF2',false,['deriveKey']).then(function(key){
    return crypto.subtle.deriveKey({name:'PBKDF2',salt:unb64(data.s),iterations:iterations,hash:'SHA-256'},key,{name:'AES-GCM',length:256},false,['decrypt']).then(function(aes){
      return crypto.subtle.decrypt({name:'AES-GCM',iv:unb64(data.i)},aes,unb64(data.c)).then(function(pt){return JSON.parse(td.decode(pt))})
    })
  })
}

function loadIdentityKeys(data){
  return Promise.all([
    crypto.subtle.importKey('pkcs8',unb64(data.sign.priv),'Ed25519',true,['sign']),
    crypto.subtle.importKey('raw',unb64(data.sign.pub),'Ed25519',true,['verify']),
    crypto.subtle.importKey('jwk',data.dh.priv,{name:'ECDH',namedCurve:'P-256'},true,['deriveBits']),
    crypto.subtle.importKey('jwk',data.dh.pub,{name:'ECDH',namedCurve:'P-256'},true,[])
  ]).then(function(keys){
    return Object.assign({},data,{_keys:{sign:{privateKey:keys[0],publicKey:keys[1]},dh:{privateKey:keys[2],publicKey:keys[3]}}})
  })
}

// WHITELIST-BASED UNSIGNED BUILDER (more robust than delete)
function buildUnsignedForCanon(n){
  return {
    ln_version:n.ln_version,
    ln_type:n.ln_type,
    ln_id:n.ln_id,
    ln_timestamp:n.ln_timestamp,
    ln_signer:{name:n.ln_signer&&n.ln_signer.name,publicKey:n.ln_signer&&n.ln_signer.publicKey},
    ln_payload:n.ln_payload
  };
}

// PRE-PARSE VALIDATION
var HEX64=/^[a-f0-9]{64}$/i;
var FP_FORMAT=/^([A-F0-9]{2}:){5}[A-F0-9]{2}$/;
var B64_CHARS=/^[A-Za-z0-9+/=_-]+$/;

function validateNoticeStructure(data){
  if(!data||typeof data!=='object')return'Not an object';
  if(data.ln_version!=='CNP-1')return'Invalid version';
  if(!data.ln_type||typeof data.ln_type!=='string')return'Missing type';
  if(!data.ln_id||typeof data.ln_id!=='string')return'Missing id';
  if(!data.ln_timestamp)return'Missing timestamp';
  if(!data.ln_signer||!data.ln_signer.publicKey)return'Missing signer';
  if(data.ln_signer.publicKey.indexOf('ed25519:')!==0)return'Invalid key prefix';
  if(!data.ln_signature||!B64_CHARS.test(data.ln_signature))return'Invalid signature format';
  try{var sigBytes=unb64(data.ln_signature);if(sigBytes.length!==64)return'Signature wrong length';}catch(e){return'Signature decode failed';}
  if(!data.ln_payload)return'Missing payload';
  // Reject notices with timestamps >5min in future
  if(data.ln_timestamp){var tsTime=new Date(data.ln_timestamp).getTime();if(!isNaN(tsTime)&&tsTime>Date.now()+300000)return'Timestamp is in the future';}
  // Validate PoW structure if present
  if(data.ln_pow){
    var p=data.ln_pow;
    if(p.type==='sequential-v2'){
      if(!p.fp||!FP_FORMAT.test(p.fp))return'Invalid PoW fingerprint';
      if(typeof p.seq!=='number'||p.seq<1||!Number.isInteger(p.seq))return'Invalid PoW seq';
      if(p.prev!==null&&!HEX64.test(p.prev))return'Invalid PoW prev';
      if(!HEX64.test(p.ph))return'Invalid PoW payload hash';
      if(!HEX64.test(p.out))return'Invalid PoW output';
      if(typeof p.r!=='number'||p.r<1)return'Invalid PoW rounds';
    }
  }
  return null; // valid
}

// MAX ROUNDS PROTECTION (anti verifier-DoS)
var MAX_ROUNDS_OVER=5000000;
var ABS_MAX_ROUNDS=50000000;
var VERIFY_SKIP_ROUNDS=400000; // Skip client-side PoW recomputation above this (UX only, server still verifies)

// SIGN WITH SEQUENTIAL POW
function signNotice(identity,type,payload,onProgress,links,powMultiplier){
  var now=Date.now();
  var minWait=getMinWait()*1000; // convert to ms
  var seq=(identity.seq||0)+1;
  // For first message (seq=1), use identity creation time as baseline
  // For subsequent messages, use lastSignTime
  var baseTime=identity.lastSignTime||0;
  if(seq===1&&identity.created){
    // Parse created timestamp
    var createdTime=new Date(identity.created).getTime();
    if(!isNaN(createdTime))baseTime=createdTime;
  }
  var elapsed=now-baseTime;
  if(elapsed<minWait)return Promise.reject(new Error('Wait '+Math.ceil((minWait-elapsed)/1000)+' more seconds'));
  var prevHash=identity.prevHash||null;
  var rounds=requiredRounds(seq)*(powMultiplier||1);
  // Compute payload hash first
  return sha256(canonicalize(payload)).then(function(phBytes){
    var ph=bytesToHex(phBytes);
    var seed=buildPoWSeed(identity.fp,seq,prevHash,ph);
    return sequentialPoW(seed,rounds,onProgress).then(function(pow){
      var notice={ln_version:'CNP-1',ln_type:type,ln_id:'ln_'+b64(crypto.getRandomValues(new Uint8Array(12))),ln_timestamp:new Date().toISOString(),ln_signer:{name:identity.name,publicKey:'ed25519:'+identity.sign.pub},ln_payload:payload,ln_pow:{type:'sequential-v2',fp:identity.fp,seq:seq,prev:prevHash,ph:ph,r:rounds,out:pow.result}};
      // Add cross-notice links if provided
      if(links&&links.length>0){
        notice.ln_links=links;
      }
      var unsigned=buildUnsignedForCanon(notice);
      return crypto.subtle.sign('Ed25519',identity._keys.sign.privateKey,te.encode(canonicalize(unsigned))).then(function(sig){
        notice.ln_signature=b64(new Uint8Array(sig));
        return sha256(canonicalize(notice)).then(function(h){
          var noticeHash='sha256:'+bytesToHex(h);
          identity.seq=seq;identity.prevHash=bytesToHex(h);identity.lastSignTime=Date.now();
          // Generate receipt
          var receipt=generateReceipt(identity,noticeHash,rounds,seq);
          return{notice:notice,receipt:receipt,noticeHash:noticeHash}
        })
      })
    })
  })
}

// Generate Identity Receipt (LNR-1)
function generateReceipt(identity,noticeHash,powRounds,seq){
  return{
    receipt_version:'LNR-1',
    identity_fp:identity.fp,
    identity_name:identity.name,
    notice_hash:noticeHash,
    signed_at:new Date().toISOString(),
    toolkit_version:TOOLKIT_VERSION,
    toolkit_hash:TOOLKIT_HASH,
    pow_rounds:powRounds,
    pow_seq:seq,
    security_level:identity._bioEnabled?2:1
  };
}

// VERIFY
function verifyNotice(data){
  // Pre-parse validation
  var structErr=validateNoticeStructure(data);
  if(structErr)return Promise.resolve({valid:false,error:structErr});
  
  var pubKeyStr=data.ln_signer.publicKey;
  var pubBytes=unb64(pubKeyStr.slice(8));
  return crypto.subtle.importKey('raw',pubBytes,'Ed25519',false,['verify']).then(function(pubKey){
    var unsigned=buildUnsignedForCanon(data);
    return crypto.subtle.verify('Ed25519',pubKey,unb64(data.ln_signature),te.encode(canonicalize(unsigned))).then(function(valid){
      if(!valid)return{valid:false,error:'Invalid signature'};
      return fingerprint(pubBytes).then(function(derivedFp){
        // Check PoW v2 format
        if(data.ln_pow&&data.ln_pow.type==='sequential-v2'){
          // Verify fp matches derived
          if(data.ln_pow.fp!==derivedFp)return{valid:false,error:'PoW fingerprint mismatch'};
          // Verify payload hash
          return sha256(canonicalize(data.ln_payload)).then(function(phBytes){
            var computedPh=bytesToHex(phBytes);
            if(data.ln_pow.ph!==computedPh)return{valid:false,error:'Payload hash mismatch'};
            // Absolute max rounds (hard DoS protection)
            if(data.ln_pow.r>ABS_MAX_ROUNDS)return{valid:false,error:'Rounds exceed absolute max ('+ABS_MAX_ROUNDS+')'};
            // Reconstruct seed
            var seed=buildPoWSeed(data.ln_pow.fp,data.ln_pow.seq,data.ln_pow.prev,data.ln_pow.ph);
            // Skip heavy recomputation for high rounds (client UX only - server already verified)
            if(data.ln_pow.r>VERIFY_SKIP_ROUNDS){
              return{valid:true,data:data,derivedFingerprint:derivedFp,pow:{valid:null,unverified:true,reason:'rounds_gt_threshold',r:data.ln_pow.r,seq:data.ln_pow.seq,threshold:VERIFY_SKIP_ROUNDS,error:null,note:'PoW not verified locally ('+data.ln_pow.r.toLocaleString()+' > '+VERIFY_SKIP_ROUNDS.toLocaleString()+' threshold). Signature valid.'}}
            }
            // Verify PoW (only for low rounds)
            showStatus('Verifying PoW...');
            return sequentialPoW(seed,data.ln_pow.r).then(function(recomputed){
              var powValid=recomputed.result===data.ln_pow.out;
              return{valid:true,data:data,derivedFingerprint:derivedFp,pow:{valid:powValid,r:data.ln_pow.r,seq:data.ln_pow.seq,recomputedTime:recomputed.time_ms,error:powValid?null:'PoW mismatch'}}
            })
          })
        }
        // Legacy PoW format (sequential)
        if(data.ln_pow&&data.ln_pow.type==='sequential'){
          // Max rounds protection for legacy too
          if(data.ln_pow.rounds>5000000)return{valid:false,error:'Excessive rounds (verifier DoS protection)'};
          showStatus('Verifying PoW...');
          return sequentialPoW(data.ln_pow.seed,data.ln_pow.rounds).then(function(recomputed){
            var powValid=recomputed.result===data.ln_pow.result;
            return{valid:true,data:data,derivedFingerprint:derivedFp,pow:{valid:powValid,r:data.ln_pow.rounds,seq:data.ln_pow.seq,recomputedTime:recomputed.time_ms,error:powValid?null:'PoW mismatch'}}
          })
        }
        // Classic PoW format (nonce + hash + bits) - used by server
        if(data.ln_pow&&data.ln_pow.nonce&&data.ln_pow.hash){
          return verifyClassicPoW(data).then(function(powResult){
            return{valid:true,data:data,derivedFingerprint:derivedFp,pow:{valid:powResult.valid,bits:data.ln_pow.bits,error:powResult.error||null}}
          })
        }
        return{valid:true,data:data,derivedFingerprint:derivedFp,pow:null}
      })
    })
  }).catch(function(e){return{valid:false,error:e.message}})
}

// ENVELOPE (ENV-1.2)
function encryptEnvelope(identity,recipientPub,content){
  var now=Date.now();
  var minWait=getMinWait()*1000;
  var lastSign=identity.lastSignTime||0;
  var elapsed=now-lastSign;
  if(elapsed<minWait)return Promise.reject(new Error('Wait '+Math.ceil((minWait-elapsed)/1000)+' more seconds'));
  return crypto.subtle.generateKey({name:'ECDH',namedCurve:'P-256'},true,['deriveBits']).then(function(ephKey){
    return crypto.subtle.exportKey('jwk',ephKey.publicKey).then(function(ephPubJwk){
      return crypto.subtle.importKey('jwk',recipientPub.dh,{name:'ECDH',namedCurve:'P-256'},false,[]).then(function(recipientDhPub){
        return crypto.subtle.deriveBits({name:'ECDH',public:recipientDhPub},ephKey.privateKey,256).then(function(shared){
          var env_id='env_'+b64(crypto.getRandomValues(new Uint8Array(12))),iv=crypto.getRandomValues(new Uint8Array(12)),env_timestamp=new Date().toISOString(),mode=settings.envPrivacy||'public';
          var env_dh={kty:'EC',crv:'P-256',x:ephPubJwk.x,y:ephPubJwk.y};
          
          // Build header - NO sender info in private mode
          var header={env_version:'ENV-1.2',env_id:env_id,env_timestamp:env_timestamp,env_ttl_ms:7*24*60*60*1000,env_meta:{mode:mode},env_dh:env_dh};
          if(mode==='public'){
            header.env_sender={name:identity.name,sign:'ed25519:'+identity.sign.pub,fp:identity.fp};
          }
          
          return sha256(te.encode(recipientPub.fp)).then(function(hint){
            if(mode==='private')header.env_recipient_hint=b64(hint.slice(0,8));else header.env_recipient_fp=recipientPub.fp;
            
            // Build inner payload with sender auth (for private mode)
            var innerPayload;
            if(mode==='private'){
              // Sender info goes INSIDE ciphertext
              var senderInfo={name:identity.name,sign:'ed25519:'+identity.sign.pub,fp:identity.fp};
              var sigData=env_id+'|'+env_timestamp+'|'+canonicalize(content);
              return crypto.subtle.sign('Ed25519',identity._keys.sign.privateKey,te.encode(sigData)).then(function(innerSig){
                innerPayload={content:content,sender:senderInfo,sender_sig:b64(new Uint8Array(innerSig))};
                return encryptInner();
              });
            }else{
              innerPayload=content;
              return encryptInner();
            }
            
            function encryptInner(){
              // Add random padding (0-2KB) to resist traffic analysis
              var padding=crypto.getRandomValues(new Uint8Array(new Uint16Array(crypto.getRandomValues(new Uint8Array(2)).buffer)[0]%2048));
              var paddedPayload=mode==='private'?Object.assign({},innerPayload,{_pad:b64(padding)}):innerPayload;
              
              var aad=te.encode(canonicalize(header)),envIdBytes=te.encode(env_id),hkdfSalt=new Uint8Array(envIdBytes.length+iv.length);
              hkdfSalt.set(envIdBytes,0);hkdfSalt.set(iv,envIdBytes.length);
              return crypto.subtle.importKey('raw',shared,'HKDF',false,['deriveKey']).then(function(keyMat){
                return crypto.subtle.deriveKey({name:'HKDF',hash:'SHA-256',salt:hkdfSalt,info:te.encode('LOWNET:ENV-1.2')},keyMat,{name:'AES-GCM',length:256},false,['encrypt']).then(function(aesKey){
                  return crypto.subtle.encrypt({name:'AES-GCM',iv:iv,additionalData:aad},aesKey,te.encode(JSON.stringify(paddedPayload))).then(function(ct){
                    var envelope=Object.assign({},header,{env_encrypted:{iv:b64(iv),ct:b64(new Uint8Array(ct))}});
                    if(mode==='public'){
                      // Public mode: outer signature
                      return crypto.subtle.sign('Ed25519',identity._keys.sign.privateKey,te.encode(canonicalize(envelope))).then(function(sig){
                        envelope.env_signature=b64(new Uint8Array(sig));return envelope
                      })
                    }else{
                      // Private mode: no outer signature (auth is inside)
                      return envelope;
                    }
                  })
                })
              })
            }
          })
        })
      })
    })
  })
}

function decryptEnvelope(identity,data){
  // Support both ENV-1.1 (legacy) and ENV-1.2 (sender-minimized)
  if(data.env_version!=='ENV-1.1'&&data.env_version!=='ENV-1.2')return Promise.resolve({valid:false,error:'Unknown version'});
  var isV12=data.env_version==='ENV-1.2';
  var isPrivate=data.env_meta&&data.env_meta.mode==='private';
  
  var checkRecipient=data.env_recipient_fp?Promise.resolve(data.env_recipient_fp===identity.fp):data.env_recipient_hint?sha256(te.encode(identity.fp)).then(function(h){return b64(h.slice(0,8))===data.env_recipient_hint}):Promise.resolve(false);
  return checkRecipient.then(function(isForMe){
    if(!isForMe)return{valid:false,error:'Not for you'};
    if(data.env_ttl_ms){var expires=new Date(data.env_timestamp).getTime()+data.env_ttl_ms;if(Date.now()>expires)return{valid:false,error:'Expired'}}
    // Reject envelopes with timestamps >5min in future
    var envTime=new Date(data.env_timestamp).getTime();if(!isNaN(envTime)&&envTime>Date.now()+300000)return{valid:false,error:'Timestamp is in the future'};
    
    // For public mode or legacy: verify outer signature first
    var outerSigCheck;
    if(!isPrivate||!isV12){
      if(!data.env_sender||!data.env_sender.sign)return Promise.resolve({valid:false,error:'Missing sender'});
      var senderPub=unb64(data.env_sender.sign.slice(8));
      outerSigCheck=crypto.subtle.importKey('raw',senderPub,'Ed25519',false,['verify']).then(function(senderKey){
        var unsigned=Object.assign({},data);delete unsigned.env_signature;
        return crypto.subtle.verify('Ed25519',senderKey,unb64(data.env_signature),te.encode(canonicalize(unsigned)));
      });
    }else{
      // Private mode ENV-1.2: no outer signature, auth is inside
      outerSigCheck=Promise.resolve(true);
    }
    
    return outerSigCheck.then(function(outerValid){
      if(!outerValid)return{valid:false,error:'Invalid outer signature'};
      
      return crypto.subtle.importKey('jwk',data.env_dh,{name:'ECDH',namedCurve:'P-256'},false,[]).then(function(dhPub){
        return crypto.subtle.deriveBits({name:'ECDH',public:dhPub},identity._keys.dh.privateKey,256).then(function(shared){
          var iv=unb64(data.env_encrypted.iv),envIdBytes=te.encode(data.env_id),hkdfSalt=new Uint8Array(envIdBytes.length+iv.length);
          hkdfSalt.set(envIdBytes,0);hkdfSalt.set(iv,envIdBytes.length);
          
          // Rebuild header for AAD (without sender for private ENV-1.2)
          var header={env_version:data.env_version,env_id:data.env_id,env_timestamp:data.env_timestamp,env_ttl_ms:data.env_ttl_ms,env_meta:data.env_meta,env_dh:data.env_dh};
          if(data.env_sender)header.env_sender=data.env_sender;
          if(data.env_recipient_fp)header.env_recipient_fp=data.env_recipient_fp;
          if(data.env_recipient_hint)header.env_recipient_hint=data.env_recipient_hint;
          var aad=te.encode(canonicalize(header));
          var hkdfInfo=isV12?'LOWNET:ENV-1.2':'LOWNET:ENV-1.1';
          
          return crypto.subtle.importKey('raw',shared,'HKDF',false,['deriveKey']).then(function(keyMat){
            return crypto.subtle.deriveKey({name:'HKDF',hash:'SHA-256',salt:hkdfSalt,info:te.encode(hkdfInfo)},keyMat,{name:'AES-GCM',length:256},false,['decrypt']).then(function(aesKey){
              return crypto.subtle.decrypt({name:'AES-GCM',iv:iv,additionalData:aad},aesKey,unb64(data.env_encrypted.ct)).then(function(pt){
                var decrypted=JSON.parse(td.decode(pt));
                
                // Remove padding if present
                if(decrypted._pad)delete decrypted._pad;
                
                // For private ENV-1.2: verify inner signature
                if(isPrivate&&isV12){
                  if(!decrypted.sender||!decrypted.sender_sig)return{valid:false,error:'Missing inner auth'};
                  var innerSenderPub=unb64(decrypted.sender.sign.slice(8));
                  var sigData=data.env_id+'|'+data.env_timestamp+'|'+canonicalize(decrypted.content);
                  return crypto.subtle.importKey('raw',innerSenderPub,'Ed25519',false,['verify']).then(function(innerKey){
                    return crypto.subtle.verify('Ed25519',innerKey,unb64(decrypted.sender_sig),te.encode(sigData)).then(function(innerValid){
                      if(!innerValid)return{valid:false,error:'Invalid inner signature'};
                      return fingerprint(innerSenderPub).then(function(computedFp){
                        return{valid:true,data:data,payload:decrypted.content,sender:Object.assign({},decrypted.sender,{fp:decrypted.sender.fp||computedFp}),forwardSecrecy:true,privateMode:true,senderMinimized:true}
                      });
                    });
                  });
                }else{
                  // Public mode or legacy: sender was in header
                  var senderPubBytes=unb64(data.env_sender.sign.slice(8));
                  return fingerprint(senderPubBytes).then(function(computedFp){
                    return{valid:true,data:data,payload:decrypted,sender:Object.assign({},data.env_sender,{fp:data.env_sender.fp||computedFp}),forwardSecrecy:true,privateMode:isPrivate}
                  });
                }
              })
            })
          })
        })
      })
    })
  }).catch(function(e){return{valid:false,error:e.message}})
}

// STORAGE
var DB_NAME='lownet-toolkit-v2',DB_VERSION=2,STORE_VAULT='vault',STORE_KEYS='keys',STORE_CONTACTS='contacts';
function openDB(){return new Promise(function(res,rej){var r=indexedDB.open(DB_NAME,DB_VERSION);r.onerror=function(){rej(r.error)};r.onsuccess=function(){res(r.result)};r.onupgradeneeded=function(e){var db=e.target.result;if(!db.objectStoreNames.contains(STORE_VAULT))db.createObjectStore(STORE_VAULT,{keyPath:'id',autoIncrement:true});if(!db.objectStoreNames.contains(STORE_KEYS))db.createObjectStore(STORE_KEYS,{keyPath:'id'});if(!db.objectStoreNames.contains(STORE_CONTACTS))db.createObjectStore(STORE_CONTACTS,{keyPath:'id',autoIncrement:true})}})}
function vaultAdd(item){return openDB().then(function(db){return new Promise(function(res,rej){var r=db.transaction(STORE_VAULT,'readwrite').objectStore(STORE_VAULT).add({data:item,savedAt:new Date().toISOString()});r.onsuccess=function(){res()};r.onerror=function(){rej(r.error)}})})}
function vaultList(){return openDB().then(function(db){return new Promise(function(res,rej){var r=db.transaction(STORE_VAULT,'readonly').objectStore(STORE_VAULT).getAll();r.onsuccess=function(){res(r.result.reverse())};r.onerror=function(){rej(r.error)}})})}
function vaultClear(){return openDB().then(function(db){return new Promise(function(res,rej){var r=db.transaction(STORE_VAULT,'readwrite').objectStore(STORE_VAULT).clear();r.onsuccess=function(){res()};r.onerror=function(){rej(r.error)}})})}
function vaultDelete(id){return openDB().then(function(db){return new Promise(function(res,rej){var r=db.transaction(STORE_VAULT,'readwrite').objectStore(STORE_VAULT).delete(id);r.onsuccess=function(){res()};r.onerror=function(){rej(r.error)}})})}
function keysAdd(record){return openDB().then(function(db){return new Promise(function(res,rej){var r=db.transaction(STORE_KEYS,'readwrite').objectStore(STORE_KEYS).put(record);r.onsuccess=function(){res()};r.onerror=function(){rej(r.error)}})})}
function keysList(){return openDB().then(function(db){return new Promise(function(res,rej){var r=db.transaction(STORE_KEYS,'readonly').objectStore(STORE_KEYS).getAll();r.onsuccess=function(){res(r.result)};r.onerror=function(){rej(r.error)}})})}
function keysDelete(id){return openDB().then(function(db){return new Promise(function(res,rej){var r=db.transaction(STORE_KEYS,'readwrite').objectStore(STORE_KEYS).delete(id);r.onsuccess=function(){res()};r.onerror=function(){rej(r.error)}})})}

// CONTACTS (Address Book)
function contactsAdd(contact){return openDB().then(function(db){return new Promise(function(res,rej){var r=db.transaction(STORE_CONTACTS,'readwrite').objectStore(STORE_CONTACTS).add(Object.assign({addedAt:new Date().toISOString()},contact));r.onsuccess=function(){res(r.result)};r.onerror=function(){rej(r.error)}})})}
function contactsList(){return openDB().then(function(db){return new Promise(function(res,rej){var r=db.transaction(STORE_CONTACTS,'readonly').objectStore(STORE_CONTACTS).getAll();r.onsuccess=function(){res(r.result)};r.onerror=function(){rej(r.error)}})})}
function contactsDelete(id){return openDB().then(function(db){return new Promise(function(res,rej){var r=db.transaction(STORE_CONTACTS,'readwrite').objectStore(STORE_CONTACTS).delete(id);r.onsuccess=function(){res()};r.onerror=function(){rej(r.error)}})})}

// COMPACT FORMAT for Public Keys (Envelope only)
// Format: lownet:e:<dh_x_b64url>:<dh_y_b64url>
// ~95 chars - scannable with QR Version 5
function encodeCompactPubKey(pub){
  return 'lownet:e:'+pub.dh.x+':'+pub.dh.y;
}
function decodeCompactPubKey(str){
  if(str.indexOf('lownet:e:')!==0)return null;
  var parts=str.slice(9).split(':');
  if(parts.length<2)return null;
  return {
    name:null,
    sign:null,
    dh:{kty:'EC',crv:'P-256',x:parts[0],y:parts[1]},
    fp:null // Cannot compute without sign key - will be set when full key arrives
  };
}
function parseRecipientInput(str){
  str=str.trim();
  // Try compact format (lownet:e:x:y)
  if(str.indexOf('lownet:e:')===0){
    var pub=decodeCompactPubKey(str);
    if(pub){
      // No fingerprint available from compact format - that's OK for encryption
      return Promise.resolve(pub);
    }
  }
  // Try JSON
  try{
    var pub=JSON.parse(str);
    if(pub.dh){
      // Has DH key - can be used for encryption
      if(pub.fp)return Promise.resolve(pub);
      if(pub.sign){
        // Can compute fingerprint from sign key
        return fingerprint(pub.sign.indexOf('ed25519:')===0?pub.sign.slice(8):pub.sign).then(function(fp){
          pub.fp=fp;
          return pub;
        });
      }
      // No sign key, no FP - still valid for encryption
      return Promise.resolve(pub);
    }
  }catch(e){}
  return Promise.resolve(null);
}
// ============================================================
// ENV-F-1: Encrypted File Envelope
// ============================================================
var MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
var ENVF_VERSION = 'ENV-F-1';
var pendingFiles = []; // [{buffer, name, type, size}, ...]
var encryptedFiles = []; // [{blob, fileName, totalSize, header}, ...]
var decryptedFileBlob = null;
var decryptedFileName = null;
var encryptedFileBlob = null;
var encryptedFileName = null;

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1048576).toFixed(1) + ' MB';
}

async function encryptFileEnvelope(identity, recipients, fileBuffer, fileName, fileType) {
  // Normalize recipients: accept single object or array
  if (!Array.isArray(recipients)) recipients = [recipients];
  var isMulti = recipients.length > 1;
  
  // Rate limit check
  var now = Date.now();
  var minWait = getMinWait() * 1000;
  var lastSign = identity.lastSignTime || 0;
  var elapsed = now - lastSign;
  if (elapsed < minWait) throw new Error('Wait ' + Math.ceil((minWait - elapsed) / 1000) + ' more seconds');
  
  // Build envelope header
  var env_id = 'envf_' + b64(crypto.getRandomValues(new Uint8Array(12)));
  var env_timestamp = new Date().toISOString();
  var mode = settings.envPrivacy || 'public';
  
  var header = {
    env_version: ENVF_VERSION,
    env_id: env_id,
    env_timestamp: env_timestamp,
    env_meta: { mode: mode }
  };
  
  if (mode === 'public') {
    header.env_sender = { name: identity.name, sign: 'ed25519:' + identity.sign.pub, fp: identity.fp };
  }
  
  var keyMaterial; // raw bytes used for HKDF (shared secret for single, DEK for multi)
  
  if (!isMulti) {
    // === SINGLE RECIPIENT: existing ECDH-direct flow (backward compatible) ===
    var recipientPub = recipients[0];
    var ephKey = await crypto.subtle.generateKey(
      { name: 'ECDH', namedCurve: 'P-256' }, true, ['deriveBits']
    );
    var ephPubJwk = await crypto.subtle.exportKey('jwk', ephKey.publicKey);
    var recipientDhPub = await crypto.subtle.importKey(
      'jwk', recipientPub.dh, { name: 'ECDH', namedCurve: 'P-256' }, false, []
    );
    keyMaterial = await crypto.subtle.deriveBits(
      { name: 'ECDH', public: recipientDhPub }, ephKey.privateKey, 256
    );
    
    header.env_dh = { kty: 'EC', crv: 'P-256', x: ephPubJwk.x, y: ephPubJwk.y };
    if (recipientPub.fp) {
      if (mode === 'private') {
        var hint = await sha256(te.encode(recipientPub.fp));
        header.env_recipient_hint = b64(hint.slice(0, 8));
      } else {
        header.env_recipient_fp = recipientPub.fp;
      }
    }
  } else {
    // === MULTI RECIPIENT: wrapped DEK approach ===
    // Generate random Data Encryption Key
    var dek = crypto.getRandomValues(new Uint8Array(32));
    keyMaterial = dek.buffer;
    
    var envRecipients = [];
    for (var ri = 0; ri < recipients.length; ri++) {
      var rp = recipients[ri];
      // Ephemeral ECDH per recipient
      var rEph = await crypto.subtle.generateKey(
        { name: 'ECDH', namedCurve: 'P-256' }, true, ['deriveBits']
      );
      var rEphPub = await crypto.subtle.exportKey('jwk', rEph.publicKey);
      var rDhPub = await crypto.subtle.importKey(
        'jwk', rp.dh, { name: 'ECDH', namedCurve: 'P-256' }, false, []
      );
      var rShared = await crypto.subtle.deriveBits(
        { name: 'ECDH', public: rDhPub }, rEph.privateKey, 256
      );
      // Derive KEK from shared secret
      var kekMat = await crypto.subtle.importKey('raw', rShared, 'HKDF', false, ['deriveKey']);
      var kek = await crypto.subtle.deriveKey(
        { name: 'HKDF', hash: 'SHA-256', salt: te.encode(env_id), info: te.encode('LOWNET:ENVF:KEK') },
        kekMat, { name: 'AES-GCM', length: 256 }, false, ['encrypt']
      );
      // Wrap DEK with KEK
      var wrapIv = crypto.getRandomValues(new Uint8Array(12));
      var wrappedDek = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv: wrapIv }, kek, dek
      );
      envRecipients.push({
        ephemeral: { kty: 'EC', crv: 'P-256', x: rEphPub.x, y: rEphPub.y },
        wrapped_key: { iv: b64(wrapIv), ct: b64(new Uint8Array(wrappedDek)) },
        fp_hint: rp.fp ? rp.fp.slice(0, 8) : null
      });
    }
    header.env_recipients = envRecipients;
  }
  
  // License proof (shareware): include signed license for recipient verification
  if (licenseState.valid) {
    var rawKey = localStorage.getItem('lownet_license');
    if (rawKey && rawKey.startsWith('LN-PRO-')) {
      header.env_license = rawKey.slice(7); // payload.sig (Ed25519 verifiable)
    }
  }
  
  // Derive keys via HKDF from key material (shared secret or DEK)
  // Key 1: file metadata encryption
  // Key 2: file content encryption
  var keyMat = await crypto.subtle.importKey('raw', keyMaterial, 'HKDF', false, ['deriveKey']);
  var envIdBytes = te.encode(env_id);
  
  // --- Encrypt file metadata ---
  var metaIv = crypto.getRandomValues(new Uint8Array(12));
  var metaSalt = new Uint8Array(envIdBytes.length + metaIv.length);
  metaSalt.set(envIdBytes, 0); metaSalt.set(metaIv, envIdBytes.length);
  
  var metaKey = await crypto.subtle.deriveKey(
    { name: 'HKDF', hash: 'SHA-256', salt: metaSalt, info: te.encode('LOWNET:ENVF:META') },
    keyMat, { name: 'AES-GCM', length: 256 }, false, ['encrypt']
  );
  
  var fileMeta = {
    name: fileName,
    type: fileType || 'application/octet-stream',
    size: fileBuffer.byteLength
  };
  
  // Mark as padded if PRO (actual padding happens after meta encryption)
  var willPad = isPremium();
  if (willPad) fileMeta._padded = true;
  
  // In private mode, include sender info in metadata
  if (mode === 'private') {
    fileMeta._sender = { name: identity.name, sign: 'ed25519:' + identity.sign.pub, fp: identity.fp };
    // Inner signature over env_id + timestamp + file hash
    var fileHash = await sha256(new Uint8Array(fileBuffer));
    var sigData = env_id + '|' + env_timestamp + '|' + bytesToHex(fileHash);
    var innerSig = await crypto.subtle.sign('Ed25519', identity._keys.sign.privateKey, te.encode(sigData));
    fileMeta._sender_sig = b64(new Uint8Array(innerSig));
    fileMeta._file_hash = bytesToHex(fileHash);
  }
  
  // AAD for metadata: header hash
  var headerCanon = canonicalize(header);
  var metaAad = te.encode(headerCanon);
  
  var metaCt = await crypto.subtle.encrypt(
    { name: 'AES-GCM', iv: metaIv, additionalData: metaAad },
    metaKey, te.encode(JSON.stringify(fileMeta))
  );
  
  header.env_file_meta = { iv: b64(metaIv), ct: b64(new Uint8Array(metaCt)) };
  
  // --- File Padding (PRO) — obfuscate file size ---
  var encryptBuffer = fileBuffer;
  if (willPad) {
    var origSize = fileBuffer.byteLength;
    var blockSize = origSize < 1024 ? 1024 : origSize < 65536 ? 4096 : 65536;
    var paddedSize = Math.ceil(origSize / blockSize) * blockSize;
    if (paddedSize === origSize) paddedSize += blockSize; // always add at least one block
    var padded = new Uint8Array(paddedSize);
    padded.set(new Uint8Array(fileBuffer), 0);
    crypto.getRandomValues(padded.subarray(origSize)); // random padding bytes
    encryptBuffer = padded.buffer;
  }
  
  // --- Encrypt file content ---
  var fileIv = crypto.getRandomValues(new Uint8Array(12));
  var fileSalt = new Uint8Array(envIdBytes.length + fileIv.length);
  fileSalt.set(envIdBytes, 0); fileSalt.set(fileIv, envIdBytes.length);
  
  var fileKey = await crypto.subtle.deriveKey(
    { name: 'HKDF', hash: 'SHA-256', salt: fileSalt, info: te.encode('LOWNET:ENVF:FILE') },
    keyMat, { name: 'AES-GCM', length: 256 }, false, ['encrypt']
  );
  
  // AAD for file: header + meta hash (binds everything together)
  var fullHeaderCanon = canonicalize(header);
  var fileAad = te.encode(fullHeaderCanon);
  
  var fileCt = await crypto.subtle.encrypt(
    { name: 'AES-GCM', iv: fileIv, additionalData: fileAad },
    fileKey, encryptBuffer
  );
  
  header.env_file = { iv: b64(fileIv), size: fileCt.byteLength };
  
  // --- Outer signature (public mode only) ---
  if (mode === 'public') {
    var sigCanon = canonicalize(header);
    var outerSig = await crypto.subtle.sign('Ed25519', identity._keys.sign.privateKey, te.encode(sigCanon));
    header.env_signature = b64(new Uint8Array(outerSig));
  }
  
  // --- Build binary output ---
  // Format: [header JSON UTF-8] [0x00] [AES-GCM ciphertext]
  var headerBytes = te.encode(JSON.stringify(header));
  var delimiter = new Uint8Array([0x00]);
  var ctBytes = new Uint8Array(fileCt);
  
  var output = new Uint8Array(headerBytes.length + 1 + ctBytes.length);
  output.set(headerBytes, 0);
  output.set(delimiter, headerBytes.length);
  output.set(ctBytes, headerBytes.length + 1);
  
  // Update identity state
  identity.lastSignTime = Date.now();
  
  return {
    blob: new Blob([output], { type: 'application/octet-stream' }),
    header: header,
    totalSize: output.length,
    fileName: fileName.replace(/\.[^.]+$/, '') + '.lownet.enc'
  };
}

async function decryptFileEnvelope(identity, fileBuffer) {
  // Parse binary format: [header JSON] [0x00] [ciphertext]
  var bytes = new Uint8Array(fileBuffer);
  var delimIdx = -1;
  for (var i = 0; i < Math.min(bytes.length, 65536); i++) {
    if (bytes[i] === 0x00) { delimIdx = i; break; }
  }
  if (delimIdx < 0) {
    // Try JSON format fallback
    try {
      var jsonStr = td.decode(bytes);
      var header = JSON.parse(jsonStr);
      if (header.env_version === ENVF_VERSION) {
        throw new Error('JSON-only ENV-F not supported (missing file ciphertext)');
      }
    } catch(e) {}
    throw new Error('Invalid .lownet.enc format (no header delimiter found)');
  }
  
  var headerBytes = bytes.slice(0, delimIdx);
  var ctBytes = bytes.slice(delimIdx + 1);
  
  var header;
  try {
    header = JSON.parse(td.decode(headerBytes));
  } catch(e) {
    throw new Error('Invalid header JSON');
  }
  
  if (header.env_version !== ENVF_VERSION) {
    throw new Error('Unknown version: ' + header.env_version);
  }
  
  // Check recipient and establish key material
  var keyMaterial; // raw bytes for HKDF
  
  if (header.env_recipients && Array.isArray(header.env_recipients)) {
    // === MULTI-RECIPIENT: try each slot ===
    var foundSlot = false;
    for (var si = 0; si < header.env_recipients.length; si++) {
      var slot = header.env_recipients[si];
      try {
        var slotDhPub = await crypto.subtle.importKey(
          'jwk', slot.ephemeral, { name: 'ECDH', namedCurve: 'P-256' }, false, []
        );
        var slotShared = await crypto.subtle.deriveBits(
          { name: 'ECDH', public: slotDhPub }, identity._keys.dh.privateKey, 256
        );
        // Derive KEK and unwrap DEK
        var slotKekMat = await crypto.subtle.importKey('raw', slotShared, 'HKDF', false, ['deriveKey']);
        var slotKek = await crypto.subtle.deriveKey(
          { name: 'HKDF', hash: 'SHA-256', salt: te.encode(header.env_id), info: te.encode('LOWNET:ENVF:KEK') },
          slotKekMat, { name: 'AES-GCM', length: 256 }, false, ['decrypt']
        );
        var unwrapped = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv: unb64(slot.wrapped_key.iv) },
          slotKek, unb64(slot.wrapped_key.ct)
        );
        keyMaterial = unwrapped;
        foundSlot = true;
        break;
      } catch(e) {
        continue; // not our slot
      }
    }
    if (!foundSlot) throw new Error('This file is not encrypted for your identity (' + identity.fp + ')');
  } else {
    // === SINGLE RECIPIENT: existing ECDH-direct flow ===
    var isForMe = false;
    if (header.env_recipient_fp) {
      isForMe = (header.env_recipient_fp === identity.fp);
    } else if (header.env_recipient_hint) {
      var h = await sha256(te.encode(identity.fp));
      isForMe = (b64(h.slice(0, 8)) === header.env_recipient_hint);
    }
    if (!isForMe) throw new Error('This file is not encrypted for your identity (' + identity.fp + ')');
    
    var dhPub = await crypto.subtle.importKey(
      'jwk', header.env_dh, { name: 'ECDH', namedCurve: 'P-256' }, false, []
    );
    keyMaterial = await crypto.subtle.deriveBits(
      { name: 'ECDH', public: dhPub }, identity._keys.dh.privateKey, 256
    );
  }
  
  // Timestamp check
  var envTime = new Date(header.env_timestamp).getTime();
  if (!isNaN(envTime) && envTime > Date.now() + 300000) {
    throw new Error('Timestamp is in the future');
  }
  
  var isPrivate = header.env_meta && header.env_meta.mode === 'private';
  
  // Verify outer signature (public mode)
  if (!isPrivate && header.env_signature && header.env_sender) {
    var senderPub = unb64(header.env_sender.sign.slice(8));
    var senderKey = await crypto.subtle.importKey('raw', senderPub, 'Ed25519', false, ['verify']);
    var sigHeader = Object.assign({}, header);
    delete sigHeader.env_signature;
    var sigValid = await crypto.subtle.verify(
      'Ed25519', senderKey, unb64(header.env_signature), te.encode(canonicalize(sigHeader))
    );
    if (!sigValid) throw new Error('Invalid outer signature');
  }
  
  // ECDH key agreement → already done above
  
  var keyMat = await crypto.subtle.importKey('raw', keyMaterial, 'HKDF', false, ['deriveKey']);
  var envIdBytes = te.encode(header.env_id);
  
  // --- Reconstruct header for AAD (without signature, without env_file) ---
  // We need the header as it was BEFORE env_file was added
  // Actually, we need the header WITH env_file_meta but before env_file and env_signature
  var headerForMetaAad = {
    env_version: header.env_version,
    env_id: header.env_id,
    env_timestamp: header.env_timestamp,
    env_meta: header.env_meta
  };
  if (header.env_sender) headerForMetaAad.env_sender = header.env_sender;
  if (header.env_recipient_fp) headerForMetaAad.env_recipient_fp = header.env_recipient_fp;
  if (header.env_recipient_hint) headerForMetaAad.env_recipient_hint = header.env_recipient_hint;
  if (header.env_dh) headerForMetaAad.env_dh = header.env_dh;
  if (header.env_recipients) headerForMetaAad.env_recipients = header.env_recipients;
  if (header.env_license) headerForMetaAad.env_license = header.env_license;
  
  // --- Decrypt file metadata ---
  var metaIv = unb64(header.env_file_meta.iv);
  var metaSalt = new Uint8Array(envIdBytes.length + metaIv.length);
  metaSalt.set(envIdBytes, 0); metaSalt.set(metaIv, envIdBytes.length);
  
  var metaKey = await crypto.subtle.deriveKey(
    { name: 'HKDF', hash: 'SHA-256', salt: metaSalt, info: te.encode('LOWNET:ENVF:META') },
    keyMat, { name: 'AES-GCM', length: 256 }, false, ['decrypt']
  );
  
  var metaAad = te.encode(canonicalize(headerForMetaAad));
  var metaPt;
  try {
    metaPt = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: metaIv, additionalData: metaAad },
      metaKey, unb64(header.env_file_meta.ct)
    );
  } catch(e) {
    throw new Error('Metadata decryption failed (wrong key or tampered header)');
  }
  
  var fileMeta = JSON.parse(td.decode(metaPt));
  
  // Now reconstruct header WITH env_file_meta for file AAD
  // Note: env_file was NOT in the header when file was encrypted (added after encryption)
  headerForMetaAad.env_file_meta = header.env_file_meta;
  
  // --- Decrypt file content ---
  var fileIv = unb64(header.env_file.iv);
  var fileSalt = new Uint8Array(envIdBytes.length + fileIv.length);
  fileSalt.set(envIdBytes, 0); fileSalt.set(fileIv, envIdBytes.length);
  
  var fileKey = await crypto.subtle.deriveKey(
    { name: 'HKDF', hash: 'SHA-256', salt: fileSalt, info: te.encode('LOWNET:ENVF:FILE') },
    keyMat, { name: 'AES-GCM', length: 256 }, false, ['decrypt']
  );
  
  var fileAad = te.encode(canonicalize(headerForMetaAad));
  var filePt;
  try {
    filePt = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: fileIv, additionalData: fileAad },
      fileKey, ctBytes
    );
  } catch(e) {
    throw new Error('File decryption failed (wrong key or corrupted data)');
  }
  
  // --- Remove padding if present ---
  if (fileMeta._padded && fileMeta.size && filePt.byteLength > fileMeta.size) {
    filePt = filePt.slice(0, fileMeta.size);
  }
  
  // Verify inner signature (private mode)
  var sender = null;
  if (isPrivate && fileMeta._sender) {
    sender = fileMeta._sender;
    if (fileMeta._sender_sig && fileMeta._file_hash) {
      var fileHash = await sha256(new Uint8Array(filePt));
      var computedHash = bytesToHex(fileHash);
      if (computedHash !== fileMeta._file_hash) {
        throw new Error('File hash mismatch (content may be corrupted)');
      }
      var innerPub = unb64(fileMeta._sender.sign.slice(8));
      var innerKey = await crypto.subtle.importKey('raw', innerPub, 'Ed25519', false, ['verify']);
      var sigData = header.env_id + '|' + header.env_timestamp + '|' + fileMeta._file_hash;
      var innerValid = await crypto.subtle.verify('Ed25519', innerKey, unb64(fileMeta._sender_sig), te.encode(sigData));
      if (!innerValid) throw new Error('Invalid inner signature (sender auth failed)');
    }
  } else if (header.env_sender) {
    sender = header.env_sender;
  }
  
  // Compute sender fingerprint if not present
  if (sender && sender.sign && !sender.fp) {
    var senderPubBytes = unb64(sender.sign.slice(8));
    sender.fp = await fingerprint(senderPubBytes);
  }
  
  // Verify sender license (shareware check)
  var senderLicensed = false;
  if (header.env_license) {
    try {
      var licResult = await verifyLicense('LN-PRO-' + header.env_license);
      senderLicensed = licResult.valid;
    } catch(e) { /* invalid = unlicensed */ }
  }
  
  return {
    valid: true,
    fileName: fileMeta.name,
    fileType: fileMeta.type || 'application/octet-stream',
    fileSize: filePt.byteLength,
    fileBuffer: filePt,
    sender: sender,
    privateMode: isPrivate,
    timestamp: header.env_timestamp,
    envId: header.env_id,
    senderLicensed: senderLicensed
  };
}


// ============================================================
// PREMIUM LICENSE SYSTEM
// ============================================================
var LICENSE_PUB_B64 = 'P4/Ygqa7kCV7xazP1ZH8Pw7bEA00I8uVA+xfPGWsaZU=';
var licenseState = { valid: false, payload: null };

async function verifyLicense(keyStr) {
  try {
    if (!keyStr || !keyStr.startsWith('LN-PRO-')) return { valid: false, error: 'Invalid format' };
    var body = keyStr.slice(7); // strip "LN-PRO-"
    var dotIdx = body.lastIndexOf('.');
    if (dotIdx < 0) return { valid: false, error: 'Missing signature' };
    var payloadB64 = body.slice(0, dotIdx);
    var sigB64 = body.slice(dotIdx + 1);
    var payloadJson = td.decode(unb64(payloadB64));
    var payload = JSON.parse(payloadJson);
    if (payload.type !== 'pro') return { valid: false, error: 'Invalid type' };
    // Verify Ed25519 signature
    var pubBytes = unb64(LICENSE_PUB_B64);
    var pubKey = await crypto.subtle.importKey('raw', pubBytes, 'Ed25519', false, ['verify']);
    var sigBytes = unb64(sigB64);
    var valid = await crypto.subtle.verify('Ed25519', pubKey, sigBytes, te.encode(payloadJson));
    if (!valid) return { valid: false, error: 'Invalid signature' };
    return { valid: true, payload: payload };
  } catch (e) {
    return { valid: false, error: e.message };
  }
}

function isPremium() {
  return licenseState.valid;
}

async function loadLicense() {
  var stored = localStorage.getItem('lownet_license');
  if (stored) {
    var result = await verifyLicense(stored);
    licenseState = result;
    updateLicenseUI();
  } else {
    licenseState = { valid: false, payload: null };
    updateLicenseUI();
  }
}

function updateLicenseUI() {
  var status = $('license-status');
  var icon = $('license-status-icon');
  var text = $('license-status-text');
  var detail = $('license-detail');
  var input = $('license-key-input');
  var btnRemove = $('btn-remove-license');
  var fileBadge = $('file-pro-badge');
  var decryptBadge = $('decrypt-pro-badge');
  var fileTemplate = document.querySelector('.template-item[data-template="file"]');
  if (licenseState.valid) {
    status.className = 'active';
    status.id = 'license-status';
    icon.textContent = '●';
    text.textContent = 'PRO — All features unlocked';
    input.value = localStorage.getItem('lownet_license') || '';
    input.disabled = true;
    btnRemove.classList.remove('hide');
    $('btn-activate-license').textContent = 'Active';
    $('btn-activate-license').disabled = true;
    detail.classList.remove('hide');
    var p = licenseState.payload;
    detail.innerHTML = '';
    if (p.email) addInfoRow(detail, 'Email', p.email);
    if (p.id) addInfoRow(detail, 'License', p.id);
    if (p.issued) addInfoRow(detail, 'Issued', new Date(p.issued).toLocaleDateString());
    if (p.features) addInfoRow(detail, 'Features', p.features.join(', '));
    $('license-free-info').style.display = 'none';
    fileBadge.className = 'pro-badge pro-badge-active';
    fileBadge.textContent = 'PRO ✓';
    decryptBadge.className = 'pro-badge pro-badge-active';
    decryptBadge.textContent = 'PRO ✓';
    if (fileTemplate) fileTemplate.classList.add('pro-unlocked');
  } else {
    status.className = 'inactive';
    status.id = 'license-status';
    icon.textContent = '○';
    text.textContent = 'Free — Text features only';
    input.value = '';
    input.disabled = false;
    btnRemove.classList.add('hide');
    $('btn-activate-license').textContent = 'Activate';
    $('btn-activate-license').disabled = false;
    detail.classList.add('hide');
    $('license-free-info').style.display = '';
    fileBadge.className = 'pro-badge';
    fileBadge.textContent = 'PRO';
    decryptBadge.className = 'pro-badge';
    decryptBadge.textContent = 'PRO';
    if (fileTemplate) fileTemplate.classList.remove('pro-unlocked');
  }
}

function showPremiumModal() {
  $('premium-modal').classList.remove('hide');
  $('premium-modal').style.display = 'flex';
}

function hidePremiumModal() {
  $('premium-modal').classList.add('hide');
  $('premium-modal').style.display = 'none';
}

// RENDER FUNCTIONS
function renderVault(){
  vaultList().then(function(items){
    var list=$('vault-list');
    if(items.length===0){list.innerHTML='<div class="list-empty">No items</div>';return}
    list.innerHTML=items.map(function(item){
      var d=item.data,isEnv=d.env_version==='ENV-1.1'||d.env_version==='ENV-1.2',isScp=d.scp1_version;
      // Type labels: statement, commitment, attestation, envelope, lora
      var type;
      if(isScp)type='lora';
      else if(isEnv)type='envelope';
      else if(d.ln_type==='statement')type='statement';
      else if(d.ln_type==='commitment')type='commitment';
      else if(d.ln_type==='attestation')type='attest';
      else if(d.ln_type==='disclosure')type='disclosure';
      else type='notice';
      var title=isScp?'Hash: '+(d.payload_hash||'').slice(0,16)+'...':isEnv?'To: '+(d.env_recipient_fp||d.env_recipient_hint||'private').slice(0,11):(d.ln_payload&&d.ln_payload.title?d.ln_payload.title:(d.ln_payload&&d.ln_payload.content?d.ln_payload.content.slice(0,40):'Untitled'));
      var time=(isScp?d.timestamp:isEnv?d.env_timestamp:d.ln_timestamp||item.savedAt||'').slice(0,16).replace('T',' ');
      var hasPow=d.ln_pow&&(d.ln_pow.type==='sequential-v2'||d.ln_pow.type==='sequential');
      return'<div class="list-item" data-id="'+item.id+'" style="display:flex;align-items:center;"><div style="flex:1;display:flex;align-items:center;gap:12px;cursor:pointer;" class="vault-item-click"><div class="list-type">'+escapeHtml(type)+'</div><div class="list-info"><div class="list-title">'+escapeHtml(title)+'</div><div class="list-meta">'+escapeHtml(time)+(hasPow?' · PoW':'')+(isScp?' · 110B':'')+'</div></div></div><button class="vault-delete" data-id="'+item.id+'" style="width:20px;height:20px;padding:0;margin-left:8px;font-size:11px;background:transparent;border:none;color:var(--text-muted);cursor:pointer;opacity:0.5;border-radius:4px;" title="Delete">✕</button></div>';
    }).join('');
    list.querySelectorAll('.vault-item-click').forEach(function(el){
      el.onclick=function(){
        var id=el.parentElement.dataset.id;
        vaultList().then(function(all){
          var item=all.find(function(i){return i.id===parseInt(id)});
          if(item){$('verify-input').value=JSON.stringify(item.data,null,2);showTab('verify')}
        });
      };
    });
    list.querySelectorAll('.vault-delete').forEach(function(btn){
      btn.onclick=function(e){
        e.stopPropagation();
        var id=parseInt(btn.dataset.id);
        showConfirm('Delete Item','Delete this item from vault?',null,'Delete').then(function(ok){
          if(ok){
            vaultDelete(id).then(function(){
              renderVault();
              showStatus('Deleted');
            });
          }
        });
      };
    });
  });
}

function renderKeys(){
  keysList().then(function(keys){
    var list=$('keys-list');
    if(keys.length===0){list.innerHTML='<div class="list-empty">No identities</div>';identities=[];return}
    identities=[];
    session.unlocked.forEach(function(loaded){identities.push(loaded)});
    list.innerHTML=keys.map(function(record){
      var isUnlocked=session.unlocked.has(record.id);
      var statusClass=isUnlocked?'unlocked':'locked';
      var statusText=isUnlocked?'Unlocked':'Locked';
      var hasBiometric=record.biometricCredId;
      var canUseBio=isSecureContext&&window.PublicKeyCredential;
      var rid=escapeHtml(record.id);
      var biometricBtn='';
      if(hasBiometric&&!isUnlocked){
        biometricBtn='<button class="btn btn-secondary" data-action="bio-unlock" data-id="'+rid+'" title="Biometric unlock">Bio</button>';
      }
      if(hasBiometric&&isUnlocked){
        biometricBtn='<button class="btn btn-secondary" data-action="bio-reset" data-id="'+rid+'" title="Remove biometric" style="color:var(--warning);">-Bio</button>';
      }
      if(!hasBiometric&&isUnlocked&&canUseBio){
        biometricBtn='<button class="btn btn-secondary" data-action="bio-enable" data-id="'+rid+'" title="Enable biometric">+Bio</button>';
      }
      var actionBtn=isUnlocked
        ?'<button class="btn btn-secondary" data-action="lock" data-id="'+rid+'">Lock</button>'
        :'<button class="btn btn-accent" data-action="unlock" data-id="'+rid+'">Unlock</button>';
      return'<div class="key-card"><div class="key-card-header"><div class="key-card-name">'+escapeHtml(record.name)+'</div><div class="key-card-fp">'+escapeHtml(record.fp)+'</div></div><div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0;"><span style="font-size:9px;color:var(--text-muted);">Seq: '+(record.seq||0)+(hasBiometric?' · Bio':'')+'</span><span class="key-status '+statusClass+'">'+statusText+'</span></div><div class="key-card-actions">'+actionBtn+biometricBtn+'<button class="btn btn-secondary" data-action="copy" data-id="'+rid+'">Copy Pub</button><button class="btn btn-secondary" data-action="qr" data-id="'+rid+'">QR</button><button class="btn btn-secondary" data-action="delete" data-id="'+rid+'">Delete</button></div></div>';
    }).join('');
    // Event delegation for key actions
    list.querySelectorAll('button[data-action]').forEach(function(btn){
      btn.addEventListener('click',function(e){
        e.preventDefault();
        var action=btn.dataset.action;
        var id=btn.dataset.id;
        if(action==='unlock')promptUnlock(id);
        else if(action==='lock')lockIdentity(id);
        else if(action==='copy')copyPubKey(id);
        else if(action==='qr')showPubQR(id);
        else if(action==='delete')deleteIdentity(id);
        else if(action==='bio-unlock')unlockWithBiometric(id);
        else if(action==='bio-enable')enableBiometric(id);
        else if(action==='bio-reset')resetBiometric(id);
      });
    });
    renderLockStatus();
  });
}

function renderIdentityList(){
  identities=[];
  session.unlocked.forEach(function(loaded){identities.push(loaded)});
  var list=$('identity-list');
  if(identities.length===0){
    list.innerHTML='<div class="list-empty" style="padding:20px;"><div>No unlocked identities</div><button class="btn btn-accent btn-small" id="btn-goto-keys" style="margin-top:10px;">Go to Keys</button></div>';
    var gk=$('btn-goto-keys');if(gk)gk.onclick=function(){showTab('keys')};
    $('security-level').classList.add('hide');
    return;
  }
  list.innerHTML=identities.map(function(id){
    return'<div class="identity-row '+(selectedIdentityId===id.id?'selected':'')+'" data-id="'+id.id+'"><div class="identity-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div class="identity-info"><div class="identity-name">'+escapeHtml(id.name)+'</div><div class="identity-fp">'+escapeHtml(id.fp)+' · Seq: '+(id.seq||0)+'</div></div></div>';
  }).join('');
  list.querySelectorAll('.identity-row').forEach(function(el){
    el.onclick=function(){
      selectedIdentityId=el.dataset.id;
      renderIdentityList();
      updateWaitTimer();
    };
  });
  updateWaitTimer();
  updateSecurityLevel();
}

function updateSecurityLevel(){
  var el=$('security-level');
  if(!selectedIdentityId){el.classList.add('hide');return}
  keysList().then(function(keys){
    var record=keys.find(function(k){return k.id===selectedIdentityId});
    if(!record){el.classList.add('hide');return}
    el.classList.remove('hide');
    el.style.display='flex';
    if(record.biometricCredId){
      // Level 2: Biometric enabled
      el.style.background='var(--accent-subtle)';
      el.style.border='1px solid var(--accent)';
      $('security-level-icon').innerHTML='<svg viewBox="0 0 24 24" fill="var(--accent)" width="14" height="14"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>';
      $('security-level-text').innerHTML='<span style="color:var(--accent);font-weight:500;">Level 2</span> <span style="color:var(--text-muted);">Biometric required for signing</span>';
    }else{
      // Level 1: No biometric
      el.style.background='var(--warning-subtle,rgba(255,152,0,0.1))';
      el.style.border='1px solid var(--warning)';
      $('security-level-icon').innerHTML='<svg viewBox="0 0 24 24" fill="var(--warning)" width="14" height="14"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>';
      $('security-level-text').innerHTML='<span style="color:var(--warning);font-weight:500;">Level 1</span> <span style="color:var(--text-muted);">Enable biometric in Keys for stronger security</span>';
    }
  });
}

function renderContacts(){
  contactsList().then(function(contacts){
    var list=$('contacts-list');
    if(contacts.length===0){
      list.innerHTML='<div class="list-empty" style="padding:20px;font-size:11px;">No contacts saved</div>';
      return;
    }
    list.innerHTML=contacts.map(function(c){
      return'<div class="list-item" data-id="'+c.id+'"><div class="list-type">CONTACT</div><div class="list-info"><div class="list-title">'+escapeHtml(c.name||'Unnamed')+'</div><div class="list-meta">'+escapeHtml(c.fp||'-')+'</div></div><button class="contact-delete" data-id="'+c.id+'" style="width:20px;height:20px;padding:0;margin-left:8px;font-size:11px;background:transparent;border:none;color:var(--text-muted);cursor:pointer;opacity:0.5;border-radius:4px;" title="Delete">✕</button></div>';
    }).join('');
    list.querySelectorAll('.list-item').forEach(function(el){
      el.onclick=function(e){
        if(e.target.classList.contains('contact-delete'))return;
        var c=contacts.find(function(x){return x.id===parseInt(el.dataset.id)});
        if(c){
          // Show contact details or copy to clipboard
          navigator.clipboard.writeText(JSON.stringify({name:c.name,sign:c.sign,dh:c.dh,fp:c.fp},null,2));
          showStatus('Copied to clipboard');
        }
      };
    });
    list.querySelectorAll('.contact-delete').forEach(function(btn){
      btn.onclick=function(e){
        e.stopPropagation();
        var id=parseInt(btn.dataset.id);
        pendingContactDeleteId=id;
        var c=contacts.find(function(x){return x.id===id});
        $('contact-delete-item-info').textContent=(c?c.name:'Contact')+' ('+((c&&c.fp)||'-')+')';
        $('contact-delete-modal').classList.remove('hide');
        $('contact-delete-modal').style.display='flex';
      };
    });
  });
}

var pendingContactDeleteId=null;

// IDENTITY MANAGEMENT
var pendingUnlockId=null;

function promptUnlock(id){
  console.log('promptUnlock called with id:', id);
  keysList().then(function(keys){
    console.log('keysList returned:', keys.length, 'keys');
    var record=keys.find(function(k){return k.id===id});
    console.log('Found record:', record ? record.name : 'NOT FOUND');
    if(!record||!record.enc){showStatus('No encrypted data','error');return}
    pendingUnlockId=id;
    $('unlock-modal-name').textContent=record.name+' ('+record.fp+')';
    $('unlock-modal-pass').value='';
    $('unlock-modal').classList.remove('hide');
    $('unlock-modal').style.display='flex';
    setTimeout(function(){$('unlock-modal-pass').focus()},100);
  }).catch(function(e){console.error('promptUnlock error:', e)});
}

$('btn-unlock-cancel').onclick=function(){
  $('unlock-modal').classList.add('hide');
  $('unlock-modal').style.display='none';
  pendingUnlockId=null;
};

$('btn-unlock-confirm').onclick=function(){
  if(!pendingUnlockId)return;
  var pass=$('unlock-modal-pass').value;
  $('unlock-modal-pass').value=''; // Clear passphrase from DOM immediately
  if(!pass){showStatus('Enter passphrase','error');return}
  
  // Check if we're in biometric enable mode
  if(session.biometricEnableId===pendingUnlockId){
    confirmBiometricEnable(pendingUnlockId,pass);
    session.biometricEnableId=null;
    $('unlock-modal').classList.add('hide');
    $('unlock-modal').style.display='none';
    pendingUnlockId=null;
    return;
  }
  
  keysList().then(function(keys){
    var record=keys.find(function(k){return k.id===pendingUnlockId});
    if(!record||!record.enc)return;
    decryptIdentity(record.enc,pass).then(function(data){
      return loadIdentityKeys(data).then(function(loaded){
        loaded.seq=record.seq||0;
        loaded.prevHash=record.prevHash||null;
        loaded.lastSignTime=record.lastSignTime||0;
        loaded.created=loaded.created||record.created||new Date().toISOString();
        session.unlocked.set(record.id,loaded);
        session.activeId=record.id;
        $('unlock-modal').classList.add('hide');
        $('unlock-modal').style.display='none';
        pendingUnlockId=null;
        renderKeys();
        renderLockStatus();
        showStatus('Unlocked');
      });
    }).catch(function(){showStatus('Wrong passphrase','error')});
  });
};

$('unlock-modal-pass').onkeydown=function(e){if(e.key==='Enter')$('btn-unlock-confirm').click()};

function lockIdentity(id){
  session.unlocked.delete(id);
  if(session.activeId===id)session.activeId=null;
  identities=[];
  session.unlocked.forEach(function(l){identities.push(l)});
  renderKeys();
  renderLockStatus();
  showStatus('Locked');
}

function copyPubKey(id){
  var loaded=session.unlocked.get(id);
  if(loaded){
    navigator.clipboard.writeText(JSON.stringify(pubBundle(loaded),null,2));
    showStatus('Copied');
  }else{
    showStatus('Unlock first','error');
  }
}

function showPubQR(id){
  var loaded=session.unlocked.get(id);
  if(loaded){
    var pub=pubBundle(loaded);
    var compact=encodeCompactPubKey(pub);
    showQR('Public Key: '+loaded.name,compact);
  }else{
    showStatus('Unlock first','error');
  }
}

function deleteIdentity(id){
  keysList().then(function(keys){
    var record=keys.find(function(k){return k.id===id});
    var detail=record?record.name+' ('+record.fp+')':'ID: '+id;
    showConfirm('Delete Identity','This will permanently delete this identity and all associated data.',detail,'Delete').then(function(ok){
      if(ok){
        keysDelete(id).then(function(){
          session.unlocked.delete(id);
          renderKeys();
          renderLockStatus();
          showStatus('Deleted');
        });
      }
    });
  });
}

async function enableBiometric(id){
  var loaded=session.unlocked.get(id);
  if(!loaded){showStatus('Unlock first','error');return}
  
  // Use the unlock modal to get passphrase (not prompt - shows cleartext)
  var keys=await keysList();
  var record=keys.find(function(k){return k.id===id});
  if(!record){showStatus('No record','error');return}
  
  $('unlock-modal-name').textContent='Enable Biometric: '+record.name+' ('+record.fp+')';
  $('unlock-modal-pass').value='';
  $('unlock-modal').classList.remove('hide');
  $('unlock-modal').style.display='flex';
  setTimeout(function(){$('unlock-modal-pass').focus()},100);
  
  // Store that we're in biometric enable mode
  pendingUnlockId=id;
  session.biometricEnableId=id;
}

async function confirmBiometricEnable(id,pass){
  // Verify passphrase is correct
  var keys=await keysList();
  var record=keys.find(function(k){return k.id===id});
  if(!record||!record.enc){showStatus('No record','error');return}
  
  try{
    await decryptIdentity(record.enc,pass);
  }catch(e){
    showStatus('Wrong passphrase','error');
    return;
  }
  
  showStatus('Touch sensor to enable...');
  var result=await setupBiometric(id);
  if(result.success){
    // Encrypt passphrase with AES-256-GCM (gated by biometric)
    try{
      var bioIv=crypto.getRandomValues(new Uint8Array(12));
      var bioKey=await crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt']);
      var bioKeyRaw=new Uint8Array(await crypto.subtle.exportKey('raw',bioKey));
      var bioEncPass=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv:bioIv},bioKey,te.encode(pass)));
      record.biometricCredId=result.credentialId;
      record.biometricEncPass={i:b64(bioIv),c:b64(bioEncPass),k:b64(bioKeyRaw)};
      delete record.biometricPass; // Remove legacy plaintext
      await keysAdd(record);
      renderKeys();
      showStatus('Biometric enabled ✓');
    }catch(e){
      showStatus('Biometric key setup failed: '+e.message,'error');
    }
  }else{
    showStatus('Biometric failed: '+result.error,'error');
  }
}

async function unlockWithBiometric(id){
  var keys=await keysList();
  var record=keys.find(function(k){return k.id===id});
  if(!record||!record.biometricCredId){
    showStatus('No biometric setup','error');
    return;
  }
  
  showStatus('Touch sensor...');
  var result=await biometricUnlock(id,record.biometricCredId);
  if(result.success){
    // Biometric verified - decrypt passphrase
    var pass;
    if(record.biometricEncPass){
      // v3.2+: AES-GCM encrypted passphrase
      try{
        var bioKey=await crypto.subtle.importKey('raw',unb64(record.biometricEncPass.k),{name:'AES-GCM',length:256},false,['decrypt']);
        var passBuf=await crypto.subtle.decrypt({name:'AES-GCM',iv:unb64(record.biometricEncPass.i)},bioKey,unb64(record.biometricEncPass.c));
        pass=td.decode(passBuf);
      }catch(e){
        showStatus('Passphrase decrypt failed - re-enable biometric','error');
        return;
      }
    }else if(record.biometricPass){
      // Legacy v3.1: btoa-encoded — Auto-migrate to AES-GCM
      pass=atob(record.biometricPass);
      try{
        var migIv=crypto.getRandomValues(new Uint8Array(12));
        var migKey=await crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt']);
        var migKeyRaw=new Uint8Array(await crypto.subtle.exportKey('raw',migKey));
        var migEncPass=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv:migIv},migKey,te.encode(pass)));
        record.biometricEncPass={i:b64(migIv),c:b64(migEncPass),k:b64(migKeyRaw)};
        delete record.biometricPass;
        await keysAdd(record);
      }catch(e){/* migration failed, legacy still works next time */}
    }else{
      showStatus('No stored passphrase - please re-enable biometric','error');
      return;
    }
    try{
      var data=await decryptIdentity(record.enc,pass);
      var loaded=await loadIdentityKeys(data);
      loaded.seq=record.seq||0;
      loaded.prevHash=record.prevHash||null;
      loaded.lastSignTime=record.lastSignTime||0;
      loaded.created=loaded.created||record.created||new Date().toISOString();
      session.unlocked.set(record.id,loaded);
      session.activeId=record.id;
      renderKeys();
      renderLockStatus();
      showStatus('Unlocked with biometric ✓');
    }catch(e){
      showStatus('Decrypt failed - re-enable biometric','error');
    }
  }else{
    showStatus('Biometric failed: '+result.error,'error');
  }
}

async function resetBiometric(id){
  var keys=await keysList();
  var record=keys.find(function(k){return k.id===id});
  var detail=record?record.name+' ('+record.fp+')':'ID: '+id;
  var ok=await showConfirm('Remove Biometric','Remove biometric unlock for this identity? You can re-enable it later.',detail,'Remove');
  if(!ok)return;
  if(record&&record.biometricCredId){
    delete record.biometricCredId;
    await keysAdd(record);
    renderKeys();
    showStatus('Biometric removed');
  }
}

function resetCreateForm(){
  selectedTemplate=null;
  selectedIdentityId=null;
  $('notice-title').value='';
  $('notice-content').value='';
  $('recipient-key').value='';
  $('recipient-fp').textContent='No recipient';
  if($('att-subject'))$('att-subject').value='';
  if($('att-scope'))$('att-scope').value='';
  if($('att-control'))$('att-control').value='';
  if($('att-evidence'))$('att-evidence').value='';
  if($('att-valid-from'))$('att-valid-from').value='';
  if($('att-valid-until'))$('att-valid-until').value='';
  if($('att-statement'))$('att-statement').value='';
  document.querySelectorAll('.template-item').forEach(function(x){x.classList.remove('selected')});
  $('btn-step1-next').disabled=true;
  $('btn-step3-sign').disabled=true;
  $('pow-status').classList.add('hide');
  $('publish-status-card').classList.add('hide');
  $('envelope-recipient').classList.add('hide');
  $('attestation-fields').classList.add('hide');
  $('default-fields').classList.remove('hide');
  $('lora-fields').classList.add('hide');
  if($('lora-payload'))$('lora-payload').value='';
  $('btn-copy-packet').classList.add('hide');
  $('btn-qr-packet').classList.add('hide');
  $('btn-export-receipt').classList.add('hide');
  // File encryption state reset
  pendingFiles=[];encryptedFiles=[];fileRecipients=[];
  encryptedFileBlob=null;encryptedFileName=null;
  $('file-fields').classList.add('hide');
  $('file-info-display').classList.add('hide');
  $('file-drop-zone').style.display='';
  $('file-output-card').classList.add('hide');
  $('file-recipient-key').value='';
  $('file-recipient-fp').textContent='No recipient';
  $('file-recipients-list').innerHTML='';
  $('btn-add-file-recipient').classList.add('hide');
  delete $('file-recipient-key').dataset.parsed;
  if($('signed-output').parentElement)$('signed-output').parentElement.classList.remove('hide');
  linkedNotices=[];
  updateLinkedNoticesUI();
  // Reset publish toggle visual state but keep publishEnabled
  var toggle=$('publish-toggle');
  var row=$('publish-toggle-row');
  if(publishEnabled&&publicServerUrl){
    toggle.style.background='var(--accent)';
    toggle.querySelector('div').style.left='20px';
    row.style.borderColor='var(--accent)';
    row.style.background='var(--accent-subtle)';
    $('publish-server-info').textContent=RELAY_URL;
    $('publish-server-info').classList.remove('hide');
  }
  setCreateStep(1);
  pageLoadTime=Date.now();
}

// UI HELPERS
function renderLockStatus(){var badge=$('lock-status');var icon=$('lock-icon');if(session.unlocked.size>0){icon.innerHTML='<path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"/>';badge.style.color='var(--accent)';badge.title='Unlocked · Click to lock all'}else{icon.innerHTML='<path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9z"/>';badge.style.color='var(--text-muted)';badge.title='Locked · Click to manage keys'}}

$('lock-status').onclick=function(){
  if(session.unlocked.size>0){
    // Lock all identities
    session.unlocked.clear();
    session.activeId=null;
    identities=[];
    renderKeys();
    renderLockStatus();
    renderIdentityList();
    showStatus('All identities locked');
  }else{
    // Go to Keys tab to unlock
    showTab('keys');
  }
};
function showTab(tabId){document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.tab-content').forEach(function(c){c.classList.remove('active')});var tabEl=document.querySelector('[data-tab="'+tabId+'"]');if(tabEl)tabEl.classList.add('active');var contentEl=$('tab-'+tabId);if(contentEl)contentEl.classList.add('active');if(tabId==='vault')renderVault();if(tabId==='keys'){renderKeys();renderContacts()}if(tabId==='create')renderIdentityList()}
function setCreateStep(step){var steps=document.querySelectorAll('.step');steps.forEach(function(s,i){s.classList.remove('active','done');if(i+1<step)s.classList.add('done');if(i+1===step)s.classList.add('active')});for(var i=1;i<=4;i++){var el=$('create-step-'+i);if(el)el.classList.toggle('hide',i!==step)}if(step===3)startWaitTimer();else stopWaitTimer()}
var waitTimerInterval=null;
function startWaitTimer(){stopWaitTimer();updateWaitTimer();waitTimerInterval=setInterval(updateWaitTimer,1000)}
function stopWaitTimer(){if(waitTimerInterval){clearInterval(waitTimerInterval);waitTimerInterval=null}}
function updateWaitTimer(){
  var identity=identities.find(function(i){return i.id===selectedIdentityId});
  var btn=$('btn-step3-sign');
  if(!identity){$('pow-wait').classList.add('hide');btn.textContent=selectedTemplate==='file'?'Encrypt':'Sign with PoW';return}
  var now=Date.now();
  var minWait=getMinWait()*1000;
  // For first message use created time, otherwise lastSignTime
  var seq=(identity.seq||0)+1;
  var baseTime=identity.lastSignTime||0;
  if(seq===1&&identity.created){
    var createdTime=new Date(identity.created).getTime();
    if(!isNaN(createdTime))baseTime=createdTime;
  }
  var elapsed=now-baseTime;
  var remaining=Math.ceil((minWait-elapsed)/1000);
  if(remaining>0){
    $('pow-wait').classList.remove('hide');
    $('pow-wait-time').textContent=remaining;
    btn.disabled=true;
    btn.textContent='Wait '+remaining+'s';
  }else{
    $('pow-wait').classList.add('hide');
    btn.textContent=selectedTemplate==='file'?'Encrypt':'Sign with PoW';
    if(selectedIdentityId)btn.disabled=false;
  }
}

// EVENT HANDLERS
document.querySelectorAll('.tab').forEach(function(t){t.onclick=function(){showTab(t.dataset.tab)}});

document.querySelectorAll('.template-item').forEach(function(t){
  t.onclick=function(){
    document.querySelectorAll('.template-item').forEach(function(x){x.classList.remove('selected')});
    t.classList.add('selected');
    selectedTemplate=t.dataset.template;
    // Premium gate for file encryption
    if(selectedTemplate==='file'&&!isPremium()){
      t.classList.remove('selected');
      selectedTemplate=null;
      $('btn-step1-next').disabled=true;
      showPremiumModal();
      return;
    }
    $('btn-step1-next').disabled=false;
    $('envelope-recipient').classList.toggle('hide',selectedTemplate!=='envelope');
    $('attestation-fields').classList.toggle('hide',selectedTemplate!=='attestation');
    $('lora-fields').classList.toggle('hide',selectedTemplate!=='lora');
    $('default-fields').classList.toggle('hide',selectedTemplate==='attestation'||selectedTemplate==='lora'||selectedTemplate==='file');
    $('file-fields').classList.toggle('hide',selectedTemplate!=='file');
    if(selectedTemplate==='file'){$('envelope-recipient').classList.add('hide');$('details-subtitle').textContent='Encrypted File (ENV-F-1)';$('publish-divider').classList.add('hide');$('publish-toggle-row').classList.add('hide')}
    else{$('publish-divider').classList.remove('hide');$('publish-toggle-row').classList.remove('hide');if(selectedTemplate==='envelope')$('details-subtitle').textContent='Encrypted (ENV-1.2)';else if(selectedTemplate==='attestation')$('details-subtitle').textContent='ISO format';else if(selectedTemplate==='lora')$('details-subtitle').textContent='SCP-1 Packet (~110 bytes)';else $('details-subtitle').textContent='Enter content'}
  };
});

$('btn-step1-next').onclick=function(){if(selectedTemplate)setCreateStep(2)};
$('btn-step2-back').onclick=function(){setCreateStep(1)};
$('btn-step2-next').onclick=function(){if(selectedTemplate==='file'){if(pendingFiles.length===0){showStatus('Select a file','error');return}if(!$('file-recipient-key').dataset.parsed&&fileRecipients.length===0){showStatus('Set recipient key','error');return}}else if(selectedTemplate==='attestation'){var subject=$('att-subject').value.trim(),statement=$('att-statement').value.trim();if(!subject){showStatus('Enter subject','error');return}if(!statement){showStatus('Enter statement','error');return}}else if(selectedTemplate==='lora'){var payload=$('lora-payload').value.trim();if(!payload){showStatus('Enter payload','error');return}}else{var content=$('notice-content').value.trim();if(!content){showStatus('Enter content','error');return}if(selectedTemplate==='envelope'){if(!$('recipient-key').dataset.parsed){showStatus('Invalid recipient','error');return}}}setCreateStep(3);renderIdentityList();var showPow=selectedTemplate!=='file'&&selectedTemplate!=='envelope'&&isPremium();$('pow-custom-row').classList.toggle('hide',!showPow);if(showPow)updatePowInfo()};
function updatePowInfo(){var m=parseInt($('pow-multiplier').value)||1;var identity=identities.find(function(i){return i.id===selectedIdentityId});var seq=identity?(identity.seq||0)+1:1;var base=requiredRounds(seq);var total=base*m;$('pow-custom-info').textContent=total.toLocaleString()+' rounds'+(m>1?' ('+m+'× base)':'')}
$('pow-multiplier').onchange=updatePowInfo;
$('btn-step3-back').onclick=function(){setCreateStep(2)};

$('btn-step3-sign').onclick=async function(){
  var identity=identities.find(function(i){return i.id===selectedIdentityId});
  if(!identity){showStatus('Select identity','error');return}
  
  // Level 2 Security: Require biometric verification before signing
  var authResult=await requireSigningAuth(identity.id);
  if(!authResult.success){
    showStatus(authResult.error,'error');
    return;
  }
  // Set security level on identity for receipt generation
  identity._bioEnabled=(authResult.level===2);
  if(authResult.level===1){
    // Level 1: No biometric - show subtle warning
    console.log('[Security] Signing at Level 1 (no biometric)');
  }else{
    // Level 2: Biometric verified
    console.log('[Security] Signing at Level 2 (biometric verified)');
  }
  
  // LoRa/SCP-1 - no PoW, direct signing
  if(selectedTemplate==='lora'){
    $('btn-step3-sign').disabled=true;
    var payloadText=$('lora-payload').value.trim();
    sha256(payloadText).then(function(payloadHash){
      return encodeSCP1(identity,'statement',payloadHash).then(function(scp1){
        // Store full payload locally in vault too (include publicKey for verification)
        var vaultEntry={
          scp1_version:1,
          scp1_packet:scp1.b64,
          scp1_hex:scp1.hex,
          publicKey:'ed25519:'+identity.sign.pub,
          payload:payloadText,
          payload_hash:scp1.hash,
          fp:scp1.fp,
          seq:scp1.seq,
          timestamp:new Date(scp1.ts*1000).toISOString(),
          size:scp1.size
        };
        $('signed-output').value=JSON.stringify(vaultEntry,null,2);
        $('output-subtitle').textContent='SCP-1 LoRa Packet';
        $('sign-result-sub').textContent=scp1.size+' bytes · Hash: '+scp1.hash.slice(0,16)+'...';
        $('btn-copy-packet').classList.remove('hide');
        $('btn-qr-packet').classList.remove('hide');
        setCreateStep(4);
        $('btn-step3-sign').disabled=false;$('btn-step3-sign').textContent='Sign with PoW';
      });
    }).catch(function(e){showStatus('Error: '+e.message,'error');$('btn-step3-sign').disabled=false;$('btn-step3-sign').textContent='Sign with PoW';updateWaitTimer()});
    return;
  }
  
  // File encryption - no PoW, direct ECDH + AES-GCM (supports batch)
  if(selectedTemplate==='file'){
    if(pendingFiles.length===0){showStatus('Select a file first','error');return}
    // Collect all recipients (list + current input)
    var allRecipients = fileRecipients.map(function(r) { return r.pub; });
    var currentParsed = $('file-recipient-key').dataset.parsed;
    if (currentParsed) {
      var cp = JSON.parse(currentParsed);
      if (!allRecipients.some(function(r) { return r.fp === cp.fp; })) allRecipients.push(cp);
    }
    if (allRecipients.length === 0) { showStatus('Invalid recipient', 'error'); return; }
    var fileRecipient = allRecipients[0]; // for display
    $('btn-step3-sign').disabled=true;
    var total=pendingFiles.length;
    $('btn-step3-sign').textContent='Encrypting'+(total>1?' 1/'+total:'')+'...';
    encryptedFiles=[];
    var idx=0;
    function encryptNext(){
      if(idx>=pendingFiles.length){
        // All done — show results
        var firstResult=encryptedFiles[0];
        encryptedFileBlob=firstResult.blob;encryptedFileName=firstResult.fileName;
        $('file-output-card').classList.remove('hide');
        if($('btn-share-file').dataset.supported && encryptedFiles.length===1)$('btn-share-file').classList.remove('hide');
        else $('btn-share-file').classList.add('hide');
        $('signed-output').parentElement.classList.add('hide');
        var totalBytes=encryptedFiles.reduce(function(s,f){return s+f.totalSize},0);
        $('sign-result-sub').textContent=(total>1?total+' files':' File')+' encrypted \u00b7 '+formatFileSize(totalBytes);
        var info=$('file-output-info');info.textContent='';
        if(total===1){
          addInfoRow(info,'Original',firstResult.origName);
          addInfoRow(info,'Size',formatFileSize(firstResult.origSize)+' \u2192 '+formatFileSize(firstResult.totalSize));
        }else{
          addInfoRow(info,'Files',total+' files encrypted');
          addInfoRow(info,'Total Size',formatFileSize(totalBytes));
        }
        addInfoRow(info,'Recipient'+(allRecipients.length>1?'s':''),allRecipients.length>1?allRecipients.length+' recipients':fileRecipient.fp||'Set');
        addInfoRow(info,'Mode',(settings.envPrivacy||'public'));
        addInfoRow(info,'Forward Secrecy','Yes (ephemeral ECDH per file)');
        addInfoRow(info,'License',licenseState.valid?'PRO \u2713':'Unlicensed \u2014 recipient will see a notice');
        if(total===1)addInfoRow(info,'ID',firstResult.header.env_id);
        // Batch file list
        if(total>1){
          var listEl=document.createElement('div');listEl.style.cssText='margin-top:8px;border-top:1px solid var(--border);padding-top:8px;';
          encryptedFiles.forEach(function(ef,i){
            var row=document.createElement('div');row.style.cssText='display:flex;align-items:center;justify-content:space-between;padding:4px 0;font-size:10px;';
            row.innerHTML='<span style="color:var(--text-secondary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+escapeHtml(ef.origName)+' \u2192 '+escapeHtml(ef.fileName)+'</span>';
            var dl=document.createElement('button');dl.className='btn btn-secondary btn-small';dl.style.cssText='font-size:9px;padding:2px 8px;margin-left:8px;';dl.textContent='Download';
            dl.onclick=function(){var a=document.createElement('a');a.href=URL.createObjectURL(ef.blob);a.download=ef.fileName;a.click();URL.revokeObjectURL(a.href)};
            row.appendChild(dl);listEl.appendChild(row);
          });
          info.appendChild(listEl);
        }
        $('file-output-subtitle').textContent=total>1?total+' files \u2192 .lownet.enc':firstResult.origName+' \u2192 '+firstResult.fileName;
        keysList().then(function(keys){var record=keys.find(function(k){return k.id===identity.id});if(record){record.lastSignTime=identity.lastSignTime;keysAdd(record)}});
        $('output-subtitle').textContent='ENV-F-1 Encrypted File'+(total>1?'s':'');
        $('signed-output').value=total===1?JSON.stringify(firstResult.header,null,2):JSON.stringify(encryptedFiles.map(function(f){return{file:f.origName,id:f.header.env_id,size:f.totalSize}}),null,2);
        setCreateStep(4);$('btn-step3-sign').disabled=false;$('btn-step3-sign').textContent='Encrypt';
        return;
      }
      var pf=pendingFiles[idx];
      if(total>1)$('btn-step3-sign').textContent='Encrypting '+(idx+1)+'/'+total+'...';
      encryptFileEnvelope(identity,allRecipients,pf.buffer,pf.name,pf.type).then(function(result){
        encryptedFiles.push({blob:result.blob,fileName:result.fileName,totalSize:result.totalSize,header:result.header,origName:pf.name,origSize:pf.size});
        idx++;encryptNext();
      }).catch(function(e){showStatus('Error encrypting '+pf.name+': '+e.message,'error');$('btn-step3-sign').disabled=false;$('btn-step3-sign').textContent='Encrypt';updateWaitTimer()});
    }
    encryptNext();
    return;
  }
  
  $('pow-status').classList.remove('hide');$('btn-step3-sign').disabled=true;$('pow-value').textContent='0%';$('pow-progress').style.width='0%';$('pow-detail').textContent='';function onProgress(i,total,elapsed){var pct=Math.round(i/total*100);$('pow-value').textContent=pct+'%';$('pow-progress').style.width=pct+'%';$('pow-detail').textContent=i.toLocaleString()+' / '+total.toLocaleString()+' · '+(elapsed/1000).toFixed(1)+'s'}
  var powMult=isPremium()?parseInt($('pow-multiplier').value)||1:1;
  var links=linkedNotices.length>0?linkedNotices.slice():null;
  var promise;if(selectedTemplate==='envelope'){var recipient=$('recipient-key').dataset.parsed?JSON.parse($('recipient-key').dataset.parsed):null;if(!recipient){showStatus('Invalid recipient','error');$('btn-step3-sign').disabled=false;$('btn-step3-sign').textContent='Sign with PoW';return}var content={title:$('notice-title').value.trim()||null,content:$('notice-content').value.trim()};promise=encryptEnvelope(identity,recipient,content).then(function(env){return{notice:env,receipt:null}});$('output-subtitle').textContent='ENV-1.2 Envelope'}else if(selectedTemplate==='attestation'){var payload={subject:$('att-subject').value.trim(),scope:$('att-scope').value.trim()||null,control_ref:$('att-control').value.trim()||null,evidence_ref:$('att-evidence').value.trim()||null,valid_from:$('att-valid-from').value||null,valid_until:$('att-valid-until').value||null,statement:$('att-statement').value.trim()};promise=signNotice(identity,'attestation',payload,onProgress,links,powMult);$('output-subtitle').textContent='CNP-1 Attestation'}else{var payload={title:$('notice-title').value.trim()||null,content:$('notice-content').value.trim()};promise=signNotice(identity,selectedTemplate,payload,onProgress,links,powMult);$('output-subtitle').textContent='CNP-1 Notice'}
  promise.then(function(result){
    var output=result.notice;
    var receipt=result.receipt;
    $('signed-output').value=JSON.stringify(output,null,2);
    var powInfo=output.ln_pow?(output.ln_pow.r||output.ln_pow.rounds).toLocaleString()+' rounds (seq #'+(output.ln_pow.seq)+')':'Envelope encrypted';
    if(receipt){powInfo+=' · Receipt: LNR-1'}
    if(output.ln_links&&output.ln_links.length>0){powInfo+=' · '+output.ln_links.length+' link(s)'}
    $('sign-result-sub').textContent=powInfo;
    // Store receipt in session for export
    if(receipt){
      session.lastReceipt=receipt;
      $('btn-export-receipt').classList.remove('hide');
    }
    linkedNotices=[];
    // Update lastSignTime for all types (including envelope)
    if(output.env_version){identity.lastSignTime=Date.now()}
    keysList().then(function(keys){var record=keys.find(function(k){return k.id===identity.id});if(record){record.seq=identity.seq;record.prevHash=identity.prevHash;record.lastSignTime=identity.lastSignTime;keysAdd(record)}});$('btn-qr-packet').classList.remove('hide');setCreateStep(4);if(publishEnabled&&publicServerUrl&&!output.env_version){autoPublish(output)}}).catch(function(e){showStatus('Error: '+e.message,'error');$('pow-status').classList.add('hide');$('btn-step3-sign').disabled=false;$('btn-step3-sign').textContent='Sign with PoW';updateWaitTimer()})};

async function autoPublish(notice){
  $('publish-status-card').classList.remove('hide');
  $('publish-status-title').textContent='Publishing...';
  $('publish-status-detail').textContent=RELAY_URL;
  $('publish-status-icon').innerHTML='<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20" style="animation:spin 1s linear infinite;"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>';
  try{
    var result=await publishToServer(notice);
    $('publish-status-icon').innerHTML='<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
    $('publish-status-title').textContent='Published';
    $('publish-status-detail').textContent='ID: '+(result.id||notice.ln_id);
  }catch(e){
    $('publish-status-icon').innerHTML='<svg viewBox="0 0 24 24" fill="var(--error)" width="20" height="20"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';
    $('publish-status-title').textContent='Publish failed';
    var msg=e.message;
    if(msg==='Failed to fetch')msg='CORS blocked (server needs OPTIONS support)';
    $('publish-status-detail').textContent=msg;
  }
}

$('btn-copy-output').onclick=function(){navigator.clipboard.writeText($('signed-output').value);showStatus('Copied JSON')};
$('btn-copy-packet').onclick=function(){
  try{
    var data=JSON.parse($('signed-output').value);
    if(data.scp1_hex){
      navigator.clipboard.writeText(data.scp1_hex);
      showStatus('Copied 110 byte packet (hex)');
    }
  }catch(e){showStatus('No packet data','error')}
};
$('btn-qr-packet').onclick=function(){
  try{
    var data=JSON.parse($('signed-output').value);
    if(data.scp1_hex){
      showQR('SCP-1 LoRa Packet (110B)',data.scp1_hex);
    }else if(data.env_version){
      showQR('ENV-1.2 Envelope',JSON.stringify(data));
    }else if(data.ln_version){
      showQR('CNP-1 Notice',JSON.stringify(data));
    }
  }catch(e){showStatus('No data','error')}
};
$('btn-download-output').onclick=function(){var data=$('signed-output').value;var parsed=JSON.parse(data);var prefix=parsed.scp1_version?'lownet-scp1':parsed.env_version?'lownet-envelope':'lownet-notice';var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type:'application/json'}));a.download=prefix+'-'+Date.now()+'.json';a.click()};
$('btn-save-vault').onclick=function(){vaultAdd(JSON.parse($('signed-output').value)).then(function(){showStatus('Saved')})};
$('btn-create-new').onclick=function(){resetCreateForm()};

$('recipient-key').oninput=function(){
  var val=$('recipient-key').value.trim();
  if(!val){$('recipient-fp').textContent='No recipient';$('recipient-fp').style.color='var(--text-muted)';return}
  parseRecipientInput(val).then(function(pub){
    if(pub&&pub.dh){
      // Valid recipient - show FP if available, otherwise show "Ready"
      if(pub.fp){
        $('recipient-fp').textContent='Recipient: '+pub.fp;
      }else{
        $('recipient-fp').textContent='Recipient: Ready (Recipient set)';
      }
      $('recipient-fp').style.color='var(--accent)';
      // Store parsed pub for use
      $('recipient-key').dataset.parsed=JSON.stringify(pub);
    }else{
      $('recipient-fp').textContent='Invalid format';
      $('recipient-fp').style.color='var(--error)';
      delete $('recipient-key').dataset.parsed;
    }
  });
};

// VERIFY
$('btn-load-verify').onclick=function(){$('file-verify').click()};
$('file-verify').onchange=function(e){if(e.target.files&&e.target.files[0])e.target.files[0].text().then(function(t){$('verify-input').value=t});e.target.value=''};

// DOM-BASED VERIFY DETAILS (no innerHTML for user data)
function addInfoRow(parent,label,value){
  var row=document.createElement('div');row.className='info-row';
  var l=document.createElement('span');l.className='info-label';l.textContent=label;
  var v=document.createElement('span');v.className='info-value';v.textContent=value;
  row.append(l,v);parent.append(row);
}

function renderVerifyDetails(box,data,result){
  box.textContent='';
  if(result.payload){
    addInfoRow(box,'Type','Envelope');
    addInfoRow(box,'From',(result.sender&&result.sender.name)||'Anonymous');
    addInfoRow(box,'FP',(result.sender&&result.sender.fp)||'-');
  }else{
    addInfoRow(box,'Type',data.ln_type||'-');
    addInfoRow(box,'Signer',(data.ln_signer&&data.ln_signer.name)||'Anonymous');
    addInfoRow(box,'FP',result.derivedFingerprint);
    addInfoRow(box,'Time',data.ln_timestamp);
    if(result.pow){
      addInfoRow(box,'PoW Rounds',result.pow.r.toLocaleString()+(result.pow.expectedR?' (min '+result.pow.expectedR.toLocaleString()+')':''));
      if(result.pow.unverified){
        addInfoRow(box,'PoW Status','⚠ Not verified locally ('+result.pow.r.toLocaleString()+' rounds > '+(result.pow.threshold||VERIFY_SKIP_ROUNDS).toLocaleString()+' threshold)');
      }else if(result.pow.recomputedTime){
        addInfoRow(box,'Verify Time',(result.pow.recomputedTime/1000).toFixed(1)+'s (local)');
      }
      if(result.pow.seq)addInfoRow(box,'Seq','#'+result.pow.seq);
    }
  }
}

$('btn-verify').onclick=function(){var input=$('verify-input').value.trim();if(!input){showStatus('Paste JSON','error');return}var data;try{data=JSON.parse(input)}catch(e){showStatus('Invalid JSON','error');return}var badge=$('verify-badge'),checkSvg='<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',xSvg='<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',warnSvg='<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',promise;

// SCP-1 LoRa Packet verification
if(data.scp1_version){
  if(!data.publicKey){badge.classList.add('error');badge.querySelector('.result-badge-icon').innerHTML=xSvg;badge.querySelector('.result-badge-title').textContent='Missing Key';badge.querySelector('.result-badge-sub').textContent='No publicKey in SCP-1 data';$('verify-details').textContent='';$('verify-content').textContent='';$('verify-result').classList.remove('hide');return}
  var pubB64=data.publicKey.indexOf('ed25519:')===0?data.publicKey.slice(8):data.publicKey;
  var packetData=data.scp1_hex||data.scp1_packet;
  verifySCP1(packetData,unb64(pubB64)).then(function(result){
    var box=$('verify-details');
    if(result.signatureValid){
      badge.classList.remove('error');
      badge.querySelector('.result-badge-icon').innerHTML=checkSvg;
      badge.querySelector('.result-badge-title').textContent='Valid SCP-1';
      badge.querySelector('.result-badge-sub').textContent='Signature OK · 110 bytes';
      // Check payload hash match if payload present
      var hashMatch='';
      if(data.payload){
        sha256(data.payload).then(function(h){
          var computed=bytesToHex(h);
          hashMatch=computed===data.payload_hash?' · Payload ✓':' · Payload hash mismatch!';
          badge.querySelector('.result-badge-sub').textContent='Signature OK · 110 bytes'+hashMatch;
        });
      }
      box.textContent='';
      addInfoRow(box,'Type','SCP-1 LoRa Commitment');
      addInfoRow(box,'Fingerprint',result.fp||data.fp);
      addInfoRow(box,'Timestamp',result.timestamp||data.timestamp);
      addInfoRow(box,'Sequence',String(result.seq||data.seq));
      addInfoRow(box,'Payload Hash',(result.hash||data.payload_hash||'').slice(0,32)+'...');
      $('verify-content').textContent=data.payload||'(payload not included)';
    }else{
      badge.classList.add('error');
      badge.querySelector('.result-badge-icon').innerHTML=xSvg;
      badge.querySelector('.result-badge-title').textContent='Invalid';
      badge.querySelector('.result-badge-sub').textContent=result.error||'Signature verification failed';
      box.textContent='';
      $('verify-content').textContent='';
    }
    $('verify-result').classList.remove('hide');
  }).catch(function(e){
    badge.classList.add('error');
    badge.querySelector('.result-badge-icon').innerHTML=xSvg;
    badge.querySelector('.result-badge-title').textContent='Error';
    badge.querySelector('.result-badge-sub').textContent=e.message;
    $('verify-details').textContent='';
    $('verify-content').textContent='';
    $('verify-result').classList.remove('hide');
  });
  return;
}

if(data.env_version==='ENV-1.1'||data.env_version==='ENV-1.2'){var myIdentity=null;session.unlocked.forEach(function(id){if(!myIdentity)myIdentity=id});if(!myIdentity){badge.classList.add('error');badge.querySelector('.result-badge-icon').innerHTML=warnSvg;badge.querySelector('.result-badge-title').textContent='Unlock Required';badge.querySelector('.result-badge-sub').textContent='Unlock identity first';$('verify-details').textContent='';$('verify-content').textContent='';$('verify-result').classList.remove('hide');return}promise=decryptEnvelope(myIdentity,data)}else{promise=verifyNotice(data)}promise.then(function(result){var box=$('verify-details');if(result.valid){badge.classList.remove('error');badge.querySelector('.result-badge-icon').innerHTML=checkSvg;if(result.payload&&result.sender){var features=[];if(result.forwardSecrecy)features.push('Forward Secrecy');if(result.senderMinimized)features.push('Sender Hidden');badge.querySelector('.result-badge-title').textContent='Decrypted';badge.querySelector('.result-badge-sub').textContent='Valid'+(features.length?' · '+features.join(' · '):'');renderVerifyDetails(box,data,result);$('verify-content').textContent=(result.payload.title?result.payload.title+'\n\n':'')+result.payload.content}else{var powStatus='No PoW';if(result.pow){if(result.pow.unverified){powStatus='PoW: '+result.pow.r.toLocaleString()+' rounds (not verified locally)'}else if(result.pow.valid===true){powStatus='PoW OK'}else if(result.pow.valid===false){powStatus='PoW: '+result.pow.error}else{powStatus='PoW: unknown'}}badge.querySelector('.result-badge-title').textContent='Valid';badge.querySelector('.result-badge-sub').textContent='Signature OK · '+powStatus;renderVerifyDetails(box,data,result);if(data.ln_type==='attestation'&&data.ln_payload){var p=data.ln_payload;$('verify-content').textContent='Subject: '+(p.subject||'-')+'\nScope: '+(p.scope||'-')+'\nControl: '+(p.control_ref||'-')+'\nEvidence: '+(p.evidence_ref||'-')+'\nValid: '+(p.valid_from||'?')+' to '+(p.valid_until||'?')+'\n\nStatement:\n'+(p.statement||'-')}else{$('verify-content').textContent=((data.ln_payload&&data.ln_payload.title)?data.ln_payload.title+'\n\n':'')+((data.ln_payload&&data.ln_payload.content)||JSON.stringify(data.ln_payload,null,2))}}}else{badge.classList.add('error');badge.querySelector('.result-badge-icon').innerHTML=xSvg;badge.querySelector('.result-badge-title').textContent='Invalid';badge.querySelector('.result-badge-sub').textContent=result.error;box.textContent='';$('verify-content').textContent=''}$('verify-result').classList.remove('hide')})};
$('btn-verify-save').onclick=function(){vaultAdd(JSON.parse($('verify-input').value)).then(function(){showStatus('Saved')})};

// VAULT
$('btn-vault-export').onclick=function(){vaultList().then(function(items){var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify({vault:'LOWNET',version:2,exported:new Date().toISOString(),items:items.map(function(i){return i.data})},null,2)],{type:'application/json'}));a.download='lownet-vault-'+Date.now()+'.json';a.click()})};
$('btn-vault-import').onclick=function(){$('file-vault').click()};
$('file-vault').onchange=function(e){if(e.target.files&&e.target.files[0]){e.target.files[0].text().then(function(t){var data=JSON.parse(t);if(data.vault!=='LOWNET')throw new Error('Invalid');Promise.all(data.items.map(vaultAdd)).then(function(){renderVault();showStatus('Imported '+data.items.length)})}).catch(function(e){showStatus('Error: '+e.message,'error')})}e.target.value=''};
$('btn-vault-clear').onclick=function(){
  showConfirm('Clear Vault','Delete all items from vault? This cannot be undone.',null,'Clear All').then(function(ok){
    if(ok){vaultClear().then(function(){renderVault();showStatus('Cleared')})}
  });
};

// KEYS
$('btn-new-identity').onclick=function(){$('new-identity-form').classList.remove('hide');$('load-identity-form').classList.add('hide')};
$('btn-load-identity').onclick=function(){$('load-identity-form').classList.remove('hide');$('new-identity-form').classList.add('hide')};
$('btn-cancel-identity').onclick=function(){$('new-identity-form').classList.add('hide')};
$('btn-create-identity').onclick=function(){var name=$('new-id-name').value.trim(),pass=$('new-id-pass').value;if(!name){showStatus('Enter name','error');return}if(!pass||pass.length<4){showStatus('Passphrase too short','error');return}genIdentity(name).then(function(id){return encryptIdentity(id,pass).then(function(enc){var record={id:id.id,name:id.name,fp:id.fp,created:id.created,enc:enc,seq:0,prevHash:null};return keysAdd(record).then(function(){var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(enc,null,2)],{type:'application/json'}));a.download='lownet-identity-'+id.fp.replace(/:/g,'')+'.json';a.click();setTimeout(function(){var b=document.createElement('a');b.href=URL.createObjectURL(new Blob([JSON.stringify(pubBundle(id),null,2)],{type:'application/json'}));b.download='lownet-pubkey-'+id.fp.replace(/:/g,'')+'.json';b.click()},500);return loadIdentityKeys(id).then(function(loaded){session.unlocked.set(id.id,loaded);session.activeId=id.id;$('new-id-name').value='';$('new-id-pass').value='';$('new-identity-form').classList.add('hide');renderKeys();renderLockStatus();showStatus('Created & downloaded')})})})}).catch(function(e){showStatus('Error: '+e.message,'error')})};
$('btn-select-id-file').onclick=function(){$('file-identity').click()};
$('file-identity').onchange=function(e){var file=e.target.files&&e.target.files[0];if(!file)return;var pass=$('load-id-pass').value;if(!pass){showStatus('Enter passphrase','error');return}file.text().then(function(t){var enc=JSON.parse(t);return decryptIdentity(enc,pass).then(function(data){var record={id:data.id||data.fp,name:data.name,fp:data.fp,created:data.created,enc:enc,seq:data.seq||0,prevHash:data.prevHash||null,lastSignTime:data.lastSignTime||0};return keysAdd(record).then(function(){return loadIdentityKeys(data).then(function(loaded){loaded.seq=record.seq;loaded.prevHash=record.prevHash;loaded.lastSignTime=record.lastSignTime;loaded.created=loaded.created||record.created||new Date().toISOString();session.unlocked.set(record.id,loaded);session.activeId=record.id;$('load-id-pass').value='';$('load-identity-form').classList.add('hide');renderKeys();renderLockStatus();showStatus('Loaded & unlocked')})})})}).catch(function(){showStatus('Wrong passphrase','error')});e.target.value=''};

// SETTINGS
$('btn-privacy-public').onclick=function(){settings.envPrivacy='public';$('btn-privacy-public').classList.remove('btn-secondary');$('btn-privacy-public').classList.add('btn-primary');$('btn-privacy-private').classList.remove('btn-primary');$('btn-privacy-private').classList.add('btn-secondary');$('privacy-desc').textContent='Public: Name visible'};
$('btn-privacy-private').onclick=function(){settings.envPrivacy='private';$('btn-privacy-private').classList.remove('btn-secondary');$('btn-privacy-private').classList.add('btn-primary');$('btn-privacy-public').classList.remove('btn-primary');$('btn-privacy-public').classList.add('btn-secondary');$('privacy-desc').textContent='Private: Only pubkey visible'};
$('btn-full-backup').onclick=function(){Promise.all([keysList(),vaultList()]).then(function(results){var keys=results[0],vault=results[1];var backup={backup:'LOWNET_FULL',version:2,exported:new Date().toISOString(),keys:keys,vault:vault.map(function(i){return i.data})};var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(backup,null,2)],{type:'application/json'}));a.download='lownet-backup-'+Date.now()+'.json';a.click()})};
$('btn-restore-backup').onclick=function(){$('file-backup').click()};
$('file-backup').onchange=function(e){var file=e.target.files&&e.target.files[0];if(!file)return;file.text().then(function(t){var backup=JSON.parse(t);if(backup.backup!=='LOWNET_FULL')throw new Error('Invalid');var promises=[];for(var i=0;i<backup.keys.length;i++){promises.push(keysAdd(backup.keys[i]))}for(var j=0;j<backup.vault.length;j++){promises.push(vaultAdd(backup.vault[j]))}Promise.all(promises).then(function(){renderKeys();renderVault();showStatus('Restored '+backup.keys.length+' keys, '+backup.vault.length+' items')})}).catch(function(e){showStatus('Error: '+e.message,'error')});e.target.value=''};
$('btn-clear-all').onclick=function(){$('clear-modal-confirm').value='';$('clear-modal').classList.remove('hide');$('clear-modal').style.display='flex';setTimeout(function(){$('clear-modal-confirm').focus()},100)};
$('btn-clear-cancel').onclick=function(){$('clear-modal').classList.add('hide');$('clear-modal').style.display='none'};
$('btn-clear-confirm').onclick=function(){if($('clear-modal-confirm').value!=='DELETE'){showStatus('Type DELETE to confirm','error');$('clear-modal-confirm').focus();return}$('clear-modal').classList.add('hide');showStatus('Clearing...');openDB().then(function(db){var tx=db.transaction([STORE_VAULT,STORE_KEYS,STORE_CONTACTS],'readwrite');tx.objectStore(STORE_VAULT).clear();tx.objectStore(STORE_KEYS).clear();tx.objectStore(STORE_CONTACTS).clear();tx.oncomplete=function(){localStorage.clear();session.unlocked.clear();session.activeId=null;showStatus('All data cleared');setTimeout(function(){location.reload()},500)};tx.onerror=function(){showStatus('Error: '+tx.error,'error')}}).catch(function(e){showStatus('Error: '+e.message,'error')})};
$('clear-modal-confirm').onkeydown=function(e){if(e.key==='Enter')$('btn-clear-confirm').click();if(e.key==='Escape')$('btn-clear-cancel').click()};
$('clear-modal').onclick=function(e){if(e.target===$('clear-modal'))$('btn-clear-cancel').click()};

// CONTACTS HANDLERS
$('btn-add-contact').onclick=function(){$('add-contact-form').classList.remove('hide');$('new-contact-name').focus()};
$('btn-cancel-contact').onclick=function(){$('add-contact-form').classList.add('hide');$('new-contact-name').value='';$('new-contact-key').value='';$('new-contact-fp').textContent=''};
$('new-contact-key').oninput=function(){
  parseRecipientInput($('new-contact-key').value).then(function(pub){
    if(pub&&pub.dh){
      if(pub.fp){
        $('new-contact-fp').textContent='FP: '+pub.fp;
      }else{
        $('new-contact-fp').textContent='Valid (compact format)';
      }
      $('new-contact-fp').style.color='var(--accent)';
      $('new-contact-key').dataset.parsed=JSON.stringify(pub);
      if(!$('new-contact-name').value&&pub.name)$('new-contact-name').value=pub.name;
    }else{
      $('new-contact-fp').textContent='Invalid format';
      $('new-contact-fp').style.color='var(--error)';
      delete $('new-contact-key').dataset.parsed;
    }
  });
};
$('btn-save-contact').onclick=function(){
  if(!$('new-contact-key').dataset.parsed){showStatus('Invalid public key','error');return}
  var pub=JSON.parse($('new-contact-key').dataset.parsed);
  var name=$('new-contact-name').value.trim()||pub.name||'Unnamed';
  contactsAdd({name:name,sign:pub.sign,dh:pub.dh,fp:pub.fp}).then(function(){
    $('add-contact-form').classList.add('hide');$('new-contact-name').value='';$('new-contact-key').value='';$('new-contact-fp').textContent='';
    renderContacts();showStatus('Contact saved');
  }).catch(function(e){showStatus('Error: '+e.message,'error')});
};
$('btn-contact-delete-cancel').onclick=function(){$('contact-delete-modal').classList.add('hide');$('contact-delete-modal').style.display='none';pendingContactDeleteId=null};
$('btn-contact-delete-confirm').onclick=function(){if(pendingContactDeleteId===null)return;contactsDelete(pendingContactDeleteId).then(function(){$('contact-delete-modal').classList.add('hide');$('contact-delete-modal').style.display='none';pendingContactDeleteId=null;renderContacts();showStatus('Deleted')})};
$('contact-delete-modal').onclick=function(e){if(e.target===$('contact-delete-modal'))$('btn-contact-delete-cancel').click()};

// SCAN QR FOR RECIPIENT
$('btn-scan-recipient').onclick=function(){
  startQRScan(function(data){
    $('recipient-key').value=data;
    $('recipient-key').dispatchEvent(new Event('input'));
    showStatus('QR scanned');
  });
};

// CONTACTS PICKER FOR ENVELOPE
$('btn-pick-contact').onclick=function(){
  contactsList().then(function(contacts){
    if(contacts.length===0){showStatus('No contacts saved','error');return}
    var list=$('contacts-picker-list');
    list.innerHTML=contacts.map(function(c){
      return'<div class="identity-row" data-id="'+c.id+'" style="cursor:pointer;"><div class="identity-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div class="identity-info"><div class="identity-name">'+escapeHtml(c.name||'Unnamed')+'</div><div class="identity-fp">'+escapeHtml(c.fp||'-')+'</div></div></div>';
    }).join('');
    list.querySelectorAll('.identity-row').forEach(function(el){
      el.onclick=function(){
        var c=contacts.find(function(x){return x.id===parseInt(el.dataset.id)});
        if(c){
          $('recipient-key').value=JSON.stringify({name:c.name,sign:c.sign,dh:c.dh,fp:c.fp});
          $('recipient-key').dispatchEvent(new Event('input'));
          $('contacts-picker-modal').classList.add('hide');
          $('contacts-picker-modal').style.display='none';
        }
      };
    });
    $('contacts-picker-modal').classList.remove('hide');
    $('contacts-picker-modal').style.display='flex';
  });
};
$('btn-contacts-picker-cancel').onclick=function(){$('contacts-picker-modal').classList.add('hide');$('contacts-picker-modal').style.display='none'};
$('contacts-picker-modal').onclick=function(e){if(e.target===$('contacts-picker-modal'))$('btn-contacts-picker-cancel').click()};

// LINK NOTICE PICKER
$('btn-link-notice').onclick=async function(){
  var items=await vaultList();
  // Filter to only notices with hashes (CNP-1)
  var notices=items.filter(function(item){
    var d=item.data;
    return d.ln_version==='CNP-1'&&d.ln_signature;
  });
  if(notices.length===0){
    showStatus('No signed notices in vault to link','warn');
    return;
  }
  var list=$('link-notice-list');
  list.innerHTML=notices.map(function(item){
    var d=item.data;
    var title=d.ln_payload?.title||d.ln_payload?.content?.slice(0,40)||d.ln_id||'Untitled';
    var type=d.ln_type||'notice';
    var ts=d.ln_timestamp?new Date(d.ln_timestamp).toLocaleDateString():'?';
    var alreadyLinked=linkedNotices.some(function(l){return l.id===item.id});
    return '<div class="list-item '+(alreadyLinked?'disabled':'')+'" data-id="'+item.id+'" style="'+(alreadyLinked?'opacity:0.5;pointer-events:none;':'')+'"><div class="list-type">'+escapeHtml(type.toUpperCase())+'</div><div class="list-info"><div class="list-title">'+escapeHtml(title)+'</div><div class="list-meta">'+escapeHtml(ts)+' · '+escapeHtml(d.ln_id||'-')+'</div></div></div>';
  }).join('');
  list.querySelectorAll('.list-item:not(.disabled)').forEach(function(el){
    el.onclick=async function(){
      var item=notices.find(function(n){return n.id===parseInt(el.dataset.id)});
      if(item){
        // Compute hash of the notice
        var hash=await sha256(canonicalize(item.data));
        var hashStr='sha256:'+bytesToHex(hash);
        linkedNotices.push({id:item.id,hash:hashStr,title:item.data.ln_payload?.title||item.data.ln_id});
        updateLinkedNoticesUI();
        $('link-notice-modal').classList.add('hide');
        $('link-notice-modal').style.display='none';
        showStatus('Linked notice added');
      }
    };
  });
  $('link-notice-modal').classList.remove('hide');
  $('link-notice-modal').style.display='flex';
};
$('btn-link-notice-cancel').onclick=function(){$('link-notice-modal').classList.add('hide');$('link-notice-modal').style.display='none'};
$('link-notice-modal').onclick=function(e){if(e.target===$('link-notice-modal'))$('btn-link-notice-cancel').click()};

function updateLinkedNoticesUI(){
  var list=$('linked-notices-list');
  if(linkedNotices.length===0){
    list.innerHTML='<span style="color:var(--text-muted);font-size:10px;">No links (optional)</span>';
    return;
  }
  list.innerHTML=linkedNotices.map(function(link,idx){
    return '<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:4px;"><span style="flex:1;font-family:ui-monospace,monospace;font-size:10px;overflow:hidden;text-overflow:ellipsis;">'+escapeHtml(link.title||link.hash.slice(0,24)+'...')+'</span><button class="btn-link-remove" data-idx="'+idx+'" style="background:none;border:none;color:var(--error);cursor:pointer;font-size:12px;padding:2px 6px;">✕</button></div>';
  }).join('');
  list.querySelectorAll('.btn-link-remove').forEach(function(btn){
    btn.onclick=function(e){
      e.stopPropagation();
      linkedNotices.splice(parseInt(btn.dataset.idx),1);
      updateLinkedNoticesUI();
    };
  });
}

// EXPORT RECEIPT
$('btn-export-receipt').onclick=function(){
  if(!session.lastReceipt){
    showStatus('No receipt available','error');
    return;
  }
  var json=JSON.stringify(session.lastReceipt,null,2);
  var blob=new Blob([json],{type:'application/json'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=url;
  a.download='receipt-'+session.lastReceipt.notice_hash.slice(7,19)+'.json';
  a.click();
  URL.revokeObjectURL(url);
  showStatus('Receipt downloaded');
};

// PUBLIC SERVER — Official relay only
var RELAY_URL='https://lownet.org';
var publicServerUrl='';
var publicProofs=[];
var publishEnabled=false;
var MAX_PUBLISH_SIZE=128*1024; // 128KB max payload


async function publishToServer(notice){
  // Server requires sequential-v2 PoW (already computed by signNotice)
  if(!notice.ln_pow || notice.ln_pow.type !== 'sequential-v2'){
    throw new Error('Notice must have sequential-v2 PoW');
  }
  
  // Payload size limit
  var payload=JSON.stringify(notice);
  if(payload.length>MAX_PUBLISH_SIZE){
    throw new Error('Payload too large ('+Math.round(payload.length/1024)+'KB > '+Math.round(MAX_PUBLISH_SIZE/1024)+'KB)');
  }
  
  var url=RELAY_URL+'/submit';
  var res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:payload});
  if(!res.ok){var err=await res.json().catch(function(){return{}});throw new Error(err.error||'Failed');}
  return await res.json();
}

// LEGACY: Classic PoW - only kept for verification of old notices
// New notices use Sequential PoW v2 (computePow function above)
async function computeClassicPoW(notice, bits) {
  var unsigned = buildUnsignedForCanon(notice);
  var canon = canonicalize(unsigned);
  var dataBytes = te.encode(canon);
  
  var attempt = 0;
  var startTime = Date.now();
  
  while (attempt < 50000000) {
    attempt++;
    if (attempt % 5000 === 0) {
      showStatus('Mining PoW... ' + attempt.toLocaleString() + ' hashes');
      await new Promise(function(r) { setTimeout(r, 0); });
    }
    
    var nonce = crypto.getRandomValues(new Uint8Array(16));
    var combined = new Uint8Array(dataBytes.length + nonce.length);
    combined.set(dataBytes, 0);
    combined.set(nonce, dataBytes.length);
    
    var hash = new Uint8Array(await crypto.subtle.digest('SHA-256', combined));
    
    var zeroBits = 0;
    for (var j = 0; j < hash.length; j++) {
      if (hash[j] === 0) {
        zeroBits += 8;
      } else {
        for (var k = 7; k >= 0; k--) {
          if ((hash[j] >> k) & 1) break;
          zeroBits++;
        }
        break;
      }
    }
    
    if (zeroBits >= bits) {
      return {
        nonce: b64(nonce),
        hash: b64(hash),
        bits: zeroBits,
        attempts: attempt,
        time_ms: Date.now() - startTime
      };
    }
  }
  throw new Error('PoW timeout');
}

// Verify classic PoW (nonce/hash/bits format)
async function verifyClassicPoW(notice) {
  try {
    var unsigned = buildUnsignedForCanon(notice);
    var canon = canonicalize(unsigned);
    var dataBytes = te.encode(canon);
    
    var nonceBytes = unb64(notice.ln_pow.nonce);
    var providedHash = unb64(notice.ln_pow.hash);
    var bits = notice.ln_pow.bits;
    
    // Recompute hash
    var combined = new Uint8Array(dataBytes.length + nonceBytes.length);
    combined.set(dataBytes, 0);
    combined.set(nonceBytes, dataBytes.length);
    
    var computed = new Uint8Array(await crypto.subtle.digest('SHA-256', combined));
    
    // Check hash matches
    if (computed.length !== providedHash.length) return {valid: false, error: 'Hash length mismatch'};
    for (var i = 0; i < computed.length; i++) {
      if (computed[i] !== providedHash[i]) return {valid: false, error: 'Hash mismatch'};
    }
    
    // Count leading zero bits
    var zeroBits = 0;
    for (var j = 0; j < computed.length; j++) {
      if (computed[j] === 0) {
        zeroBits += 8;
      } else {
        for (var k = 7; k >= 0; k--) {
          if ((computed[j] >> k) & 1) break;
          zeroBits++;
        }
        break;
      }
    }
    
    if (zeroBits < bits) return {valid: false, error: 'Insufficient zero bits'};
    return {valid: true, bits: zeroBits};
  } catch(e) {
    return {valid: false, error: e.message};
  }
}

$('publish-toggle-row').onclick=async function(){
  var toggle=$('publish-toggle');
  var row=$('publish-toggle-row');
  
  // Turning ON
  if(!publishEnabled){
    if(!publicServerUrl){showStatus('Connect to relay in Public tab first','error');return}
    
    publishEnabled=true;
    toggle.style.background='var(--accent)';
    toggle.querySelector('div').style.left='20px';
    row.style.borderColor='var(--accent)';
    row.style.background='var(--accent-subtle)';
    $('publish-server-info').textContent=RELAY_URL;
    $('publish-server-info').classList.remove('hide');
  }else{
    // Turning OFF
    publishEnabled=false;
    toggle.style.background='var(--surface-hover)';
    toggle.querySelector('div').style.left='2px';
    row.style.borderColor='var(--border)';
    row.style.background='var(--bg)';
    $('publish-server-info').classList.add('hide');
  }
};

function timeAgo(ts){
  var d=new Date(ts),now=new Date(),diff=Math.floor((now-d)/1000);
  if(diff<60)return diff+'s ago';
  if(diff<3600)return Math.floor(diff/60)+'m ago';
  if(diff<86400)return Math.floor(diff/3600)+'h ago';
  return Math.floor(diff/86400)+'d ago';
}

function renderPublicProofs(){
  var list=$('public-list');
  if(publicProofs.length===0){list.innerHTML='<div class="list-empty">No proofs yet</div>';return}
  list.innerHTML=publicProofs.map(function(proof){
    var payload=proof.ln_payload||{};
    var title=payload.title?escapeHtml(payload.title):'';
    var content=payload.content?escapeHtml(payload.content).slice(0,150):'';
    var author=proof.ln_signer?escapeHtml(proof.ln_signer.name||'Anonymous'):'Unknown';
    var fp=proof._derivedFp||'';
    var fpShort=escapeHtml(fp.split(':').slice(0,3).join(':'));
    var displayTime=proof.server_received_at||proof.ln_timestamp;
    var time=escapeHtml(timeAgo(displayTime));
    var verifiedIcon;
    if(proof._verified){
      verifiedIcon='<svg viewBox="0 0 24 24" fill="var(--accent)" width="12" height="12"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Valid';
    }else{
      verifiedIcon='<svg viewBox="0 0 24 24" fill="var(--error)" width="12" height="12"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> Invalid';
    }
    var type=escapeHtml(proof.ln_type||'notice');
    var hasPow=proof.ln_pow&&(proof.ln_pow.type==='sequential'||proof.ln_pow.type==='sequential-v2');
    return'<div style="border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:10px;background:var(--input-bg);overflow:hidden;'+(proof._verified?'':'opacity:0.6;')+'"><div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;font-size:11px;"><span><span style="color:var(--accent);font-weight:500;">'+author+'</span><span style="color:var(--text-muted);margin-left:6px;font-family:ui-monospace,monospace;font-size:9px;">'+fpShort+'</span></span><span style="color:var(--text-muted);font-size:10px;">'+time+'</span></div><div style="padding:12px 14px;"><span style="font-size:9px;font-weight:600;color:var(--bg);padding:2px 8px;border-radius:2px;text-transform:uppercase;background:var(--accent);margin-right:6px;">'+type+'</span>'+(hasPow?'<span style="font-size:9px;color:var(--text-muted);">PoW</span>':'')+(title?'<div style="font-size:12px;font-weight:600;margin:8px 0 4px;">'+title+'</div>':'')+'<div style="font-size:11px;color:var(--text-secondary);margin-top:6px;">'+content+(content.length>=150?'...':'')+'</div></div><div style="padding:8px 14px;border-top:1px solid var(--border);font-size:10px;color:var(--text-muted);display:flex;justify-content:space-between;align-items:center;"><span style="display:flex;align-items:center;gap:4px;">'+verifiedIcon+'</span><span style="font-family:ui-monospace,monospace;font-size:9px;">'+escapeHtml((proof.ln_id||'').slice(0,16))+'</span></div></div>';
  }).join('');
}

async function loadPublicProofs(){
  if(!publicServerUrl){$('public-status').textContent='Not connected';return}
  $('public-status').textContent='Connecting...';
  $('public-list').innerHTML='<div style="text-align:center;color:var(--text-muted);padding:30px;"><svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24" style="animation:spin 1s linear infinite;"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg></div>';
  try{
    var indexUrl=RELAY_URL+'/posts/index.json';
    var response=await fetch(indexUrl,{mode:'cors'});
    if(!response.ok)throw new Error('HTTP '+response.status);
    var index=await response.json();
    var entries=Array.isArray(index)?index:(index.posts||index.items||[]);
    if(typeof entries[0]==='string')entries=entries.map(function(f){return{id:f.replace('.json','')}});
    if(!entries||entries.length===0){
      $('public-list').innerHTML='<div class="list-empty">No proofs yet</div>';
      $('public-status').textContent='Connected · 0 proofs';
      return;
    }
    publicProofs=[];
    for(var i=0;i<entries.length;i++){
      try{
        var proofUrl=RELAY_URL+'/posts/'+entries[i].id+'.json';
        var proofRes=await fetch(proofUrl);
        if(proofRes.ok){
          var proof=await proofRes.json();
          var verifyResult=await verifyNotice(proof).catch(function(){return{valid:false}});
          proof._verified=verifyResult.valid;
          proof._powUnverified=verifyResult.pow&&verifyResult.pow.unverified;
          proof._derivedFp=verifyResult.derivedFingerprint||'';
          proof.server_received_at=entries[i].server_received_at||null;
          publicProofs.push(proof);
        }
      }catch(e){console.log('Failed:',entries[i].id)}
    }
    publicProofs.sort(function(a,b){
      var aTime=a.server_received_at||a.ln_timestamp;
      var bTime=b.server_received_at||b.ln_timestamp;
      return new Date(bTime)-new Date(aTime);
    });
    renderPublicProofs();
    $('public-status').textContent='Connected · '+publicProofs.length+' proofs';
  }catch(e){
    $('public-status').textContent='Error: '+(e.message==='Failed to fetch'?'Server unreachable (CORS or offline)':e.message);
    $('public-list').innerHTML='<div style="text-align:center;color:var(--error);padding:30px;">Could not connect</div>';
  }
}

// Official relay — no custom servers
$('btn-connect-public').onclick=function(){
  publicServerUrl=RELAY_URL;
  loadPublicProofs();
};

$('btn-refresh-public').onclick=function(){
  if(!publicServerUrl){showStatus('Connect first','error');return}
  loadPublicProofs();
};


// THEME
var isLightMode=localStorage.getItem('lownet_theme')==='light';
if(isLightMode)document.documentElement.classList.add('light');
$('theme-toggle').onclick=function(){isLightMode=!isLightMode;document.documentElement.classList.toggle('light',isLightMode);localStorage.setItem('lownet_theme',isLightMode?'light':'dark');$('theme-icon').innerHTML=isLightMode?'<path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>':'<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>'};;

// TIMER
setInterval(updateWaitTimer,1000);

// SELF HASH (integrity check - hashes script content only for reproducibility)
(async function computeSelfHash(){
  try{
    var scripts=document.querySelectorAll('script');
    var scriptContent='';
    scripts.forEach(function(s){scriptContent+=s.textContent});
    var hash=await sha256(scriptContent);
    $('toolkit-hash').textContent='sha256:'+bytesToHex(hash).slice(0,16)+'...';
    $('toolkit-hash').title='sha256:'+bytesToHex(hash);
  }catch(e){
    $('toolkit-hash').textContent='Error: '+e.message;
  }
})();

// LORA PAYLOAD SIZE DISPLAY
$('lora-payload').addEventListener('input',function(){
  var len=new TextEncoder().encode(this.value).length;
  $('lora-size').textContent='Payload: '+len+' bytes (local) · SCP-1 packet: 110 bytes (transmitted)';
});

// HELP MODAL
$('btn-help').onclick=function(){$('help-modal').classList.remove('hide')};
$('help-close').onclick=function(){$('help-modal').classList.add('hide')};
$('help-modal').onclick=function(e){if(e.target===this)this.classList.add('hide')};

// PWA INSTALL PROMPT
var deferredInstallPrompt=null;
window.addEventListener('beforeinstallprompt',function(e){
  e.preventDefault();
  deferredInstallPrompt=e;
  $('btn-install').classList.remove('hide');
});
$('btn-install').onclick=function(){
  if(deferredInstallPrompt){
    deferredInstallPrompt.prompt();
    deferredInstallPrompt.userChoice.then(function(choice){
      if(choice.outcome==='accepted')$('btn-install').classList.add('hide');
      deferredInstallPrompt=null;
    });
  }
};
window.addEventListener('appinstalled',function(){$('btn-install').classList.add('hide')});

// BIOMETRIC UNLOCK (WebAuthn)
var webauthnAvailable=window.PublicKeyCredential&&typeof PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable==='function';

async function setupBiometric(identityId){
  if(!webauthnAvailable)return{error:'WebAuthn not available'};
  if(!isSecureContext)return{error:'Biometric requires HTTPS or localhost (file:// not supported)'};
  try{
    var available=await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
    if(!available)return{error:'No biometric authenticator'};
    
    var challenge=crypto.getRandomValues(new Uint8Array(32));
    var userId=te.encode(identityId);
    
    // Build rp config - only set id if we have a valid hostname (not file://)
    var rpConfig={name:'LOWNET Toolkit'};
    if(location.hostname&&location.hostname!==''){
      rpConfig.id=location.hostname;
    }
    // Note: file:// URLs won't work with WebAuthn - needs localhost or HTTPS
    
    var credential=await navigator.credentials.create({
      publicKey:{
        challenge:challenge,
        rp:rpConfig,
        user:{id:userId,name:identityId,displayName:'LOWNET Identity'},
        pubKeyCredParams:[{type:'public-key',alg:-7},{type:'public-key',alg:-257}],
        authenticatorSelection:{authenticatorAttachment:'platform',userVerification:'required'},
        timeout:60000
      }
    });
    
    if(credential){
      // Store credential ID for this identity
      var credId=b64(new Uint8Array(credential.rawId));
      return{success:true,credentialId:credId};
    }
    return{error:'No credential created'};
  }catch(e){
    return{error:e.message};
  }
}

async function biometricUnlock(identityId,credentialId){
  if(!webauthnAvailable)return{error:'WebAuthn not available'};
  if(!isSecureContext)return{error:'Biometric requires HTTPS or localhost'};
  try{
    var challenge=crypto.getRandomValues(new Uint8Array(32));
    var credId=unb64(credentialId);
    
    var assertion=await navigator.credentials.get({
      publicKey:{
        challenge:challenge,
        allowCredentials:[{type:'public-key',id:credId,transports:['internal']}],
        userVerification:'required',
        timeout:60000
      }
    });
    
    if(assertion){
      return{success:true};
    }
    return{error:'Biometric verification failed'};
  }catch(e){
    return{error:e.message};
  }
}

// WebAuthn-gated Signing (Level 2 Security)
// Every sign operation requires biometric/PIN verification if enabled
async function requireSigningAuth(identityId){
  // Get identity record to check for biometric credential
  var keys=await keysList();
  var record=keys.find(function(k){return k.id===identityId});
  
  if(!record||!record.biometricCredId){
    // No biometric set up - Level 1 security (warn but proceed)
    return{success:true,level:1,message:'No biometric - signing without verification'};
  }
  
  if(!webauthnAvailable||!isSecureContext){
    return{error:'WebAuthn requires HTTPS or localhost'};
  }
  
  // Level 2: Require biometric verification for signing
  try{
    var challenge=crypto.getRandomValues(new Uint8Array(32));
    var credId=unb64(record.biometricCredId);
    
    var assertion=await navigator.credentials.get({
      publicKey:{
        challenge:challenge,
        allowCredentials:[{type:'public-key',id:credId,transports:['internal']}],
        userVerification:'required',
        timeout:60000
      }
    });
    
    if(assertion){
      return{success:true,level:2,message:'Biometric verified'};
    }
    return{error:'Signing authorization failed'};
  }catch(e){
    if(e.name==='NotAllowedError'){
      return{error:'Signing cancelled by user'};
    }
    return{error:'Auth error: '+e.message};
  }
}

// ============================================================
// FILE ENCRYPTION UI HANDLERS
// ============================================================

// File recipient key input
var fileRecipients = []; // [{pub, fp, name}, ...] for multi-recipient

$('file-recipient-key').oninput = function() {
  var val = this.value.trim();
  if (!val) { $('file-recipient-fp').textContent = 'No recipient'; $('file-recipient-fp').style.color = 'var(--text-muted)'; delete this.dataset.parsed; return; }
  parseRecipientInput(val).then(function(pub) {
    if (pub && pub.dh) {
      $('file-recipient-fp').textContent = pub.fp ? 'Recipient: ' + pub.fp : 'Recipient: Ready';
      $('file-recipient-fp').style.color = 'var(--accent)';
      $('file-recipient-key').dataset.parsed = JSON.stringify(pub);
      // Show + button if PRO
      if (isPremium()) $('btn-add-file-recipient').classList.remove('hide');
    } else {
      $('file-recipient-fp').textContent = 'Invalid format';
      $('file-recipient-fp').style.color = 'var(--error)';
      delete $('file-recipient-key').dataset.parsed;
      $('btn-add-file-recipient').classList.add('hide');
    }
  });
};

$('btn-add-file-recipient').onclick = function() {
  var parsed = $('file-recipient-key').dataset.parsed;
  if (!parsed) return;
  var pub = JSON.parse(parsed);
  // Avoid duplicates
  if (fileRecipients.some(function(r) { return r.fp === pub.fp; })) { showStatus('Recipient already added', 'error'); return; }
  fileRecipients.push({ pub: pub, fp: pub.fp || 'Unknown', name: pub.name || '' });
  $('file-recipient-key').value = '';
  delete $('file-recipient-key').dataset.parsed;
  $('file-recipient-fp').textContent = 'No recipient';
  $('file-recipient-fp').style.color = 'var(--text-muted)';
  $('btn-add-file-recipient').classList.add('hide');
  renderFileRecipients();
};

function renderFileRecipients() {
  var list = $('file-recipients-list');
  if (fileRecipients.length === 0) { list.innerHTML = ''; return; }
  list.innerHTML = fileRecipients.map(function(r, i) {
    return '<div style="display:flex;align-items:center;justify-content:space-between;padding:4px 8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:4px;">' +
      '<span style="color:var(--accent);font-family:ui-monospace,monospace;">' + escapeHtml(r.name ? r.name + ' · ' + r.fp : r.fp) + '</span>' +
      '<span class="file-recipient-remove" data-idx="' + i + '" style="cursor:pointer;color:var(--text-muted);padding:2px 6px;">\u2715</span></div>';
  }).join('');
  list.querySelectorAll('.file-recipient-remove').forEach(function(el) {
    el.onclick = function() { fileRecipients.splice(parseInt(el.dataset.idx), 1); renderFileRecipients(); };
  });
}

// Scan QR for file recipient
$('btn-scan-file-recipient').onclick = function() {
  startQRScan(function(data) {
    $('file-recipient-key').value = data;
    $('file-recipient-key').dispatchEvent(new Event('input'));
    showStatus('QR scanned');
  });
};

// Pick contact for file recipient
$('btn-pick-file-contact').onclick = function() {
  contactsList().then(function(contacts) {
    if (contacts.length === 0) { showStatus('No contacts saved', 'error'); return; }
    var list = $('contacts-picker-list');
    list.innerHTML = contacts.map(function(c) {
      return '<div class="identity-row" data-id="' + c.id + '" style="cursor:pointer;"><div class="identity-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div class="identity-info"><div class="identity-name">' + escapeHtml(c.name || 'Unnamed') + '</div><div class="identity-fp">' + escapeHtml(c.fp || '-') + '</div></div></div>';
    }).join('');
    list.querySelectorAll('.identity-row').forEach(function(el) {
      el.onclick = function() {
        var c = contacts.find(function(x) { return x.id === parseInt(el.dataset.id); });
        if (c) {
          $('file-recipient-key').value = JSON.stringify({ name: c.name, sign: c.sign, dh: c.dh, fp: c.fp });
          $('file-recipient-key').dispatchEvent(new Event('input'));
          $('contacts-picker-modal').classList.add('hide');
          $('contacts-picker-modal').style.display = 'none';
        }
      };
    });
    $('contacts-picker-modal').classList.remove('hide');
    $('contacts-picker-modal').style.display = 'flex';
  });
};

// File drop zone
(function() {
  var dropZone = $('file-drop-zone');
  var fileInput = $('file-encrypt-input');
  
  // Enable multiple file selection for PRO
  function updateFileInputMultiple(){ if(isPremium()) fileInput.setAttribute('multiple',''); else fileInput.removeAttribute('multiple'); }
  updateFileInputMultiple();
  
  dropZone.onclick = function() { updateFileInputMultiple(); fileInput.click(); };
  
  dropZone.ondragover = function(e) {
    e.preventDefault();
    dropZone.style.borderColor = 'var(--accent)';
    dropZone.style.background = 'var(--accent-subtle)';
  };
  dropZone.ondragleave = function(e) {
    e.preventDefault();
    dropZone.style.borderColor = 'var(--border)';
    dropZone.style.background = 'var(--input-bg)';
  };
  dropZone.ondrop = function(e) {
    e.preventDefault();
    dropZone.style.borderColor = 'var(--border)';
    dropZone.style.background = 'var(--input-bg)';
    if (e.dataTransfer.files && e.dataTransfer.files.length) {
      handleFilesSelect(e.dataTransfer.files);
    }
  };
  
  fileInput.onchange = function(e) {
    if (e.target.files && e.target.files.length) {
      handleFilesSelect(e.target.files);
    }
    e.target.value = '';
  };
})();

function handleFilesSelect(fileList) {
  var files = Array.from(fileList);
  // Non-PRO: only first file
  if (!isPremium()) files = files.slice(0, 1);
  pendingFiles = [];
  var validCount = 0;
  var readCount = 0;
  files.forEach(function(file) {
    if (file.size > MAX_FILE_SIZE) {
      showStatus(file.name + ' too large (max ' + formatFileSize(MAX_FILE_SIZE) + ')', 'error');
      return;
    }
    if (file.size === 0) return;
    validCount++;
    var reader = new FileReader();
    reader.onload = function(e) {
      pendingFiles.push({ buffer: e.target.result, name: file.name, type: file.type || 'application/octet-stream', size: file.size });
      readCount++;
      if (readCount === validCount) renderPendingFiles();
    };
    reader.readAsArrayBuffer(file);
  });
  if (validCount === 0) renderPendingFiles(); // clear display if no valid files
}

function renderPendingFiles() {
  if (pendingFiles.length === 0) {
    $('file-info-display').classList.add('hide');
    $('file-drop-zone').style.display = '';
    return;
  }
  $('file-drop-zone').style.display = 'none';
  $('file-info-display').classList.remove('hide');
  if (pendingFiles.length === 1) {
    $('file-info-name').textContent = pendingFiles[0].name;
    $('file-info-meta').textContent = formatFileSize(pendingFiles[0].size) + ' \u00b7 ' + pendingFiles[0].type;
  } else {
    var totalSize = pendingFiles.reduce(function(s, f) { return s + f.size; }, 0);
    $('file-info-name').textContent = pendingFiles.length + ' files selected';
    $('file-info-meta').textContent = formatFileSize(totalSize) + ' total \u00b7 ' + pendingFiles.map(function(f) { return f.name; }).join(', ');
  }
}

$('btn-file-clear').onclick = function() {
  pendingFiles = [];
  $('file-info-display').classList.add('hide');
  $('file-drop-zone').style.display = '';
};

// Download encrypted file(s)
$('btn-download-encrypted-file').onclick = function() {
  if (encryptedFiles.length > 1) {
    // Batch: download all sequentially
    encryptedFiles.forEach(function(ef, i) {
      setTimeout(function() {
        var a = document.createElement('a');
        a.href = URL.createObjectURL(ef.blob);
        a.download = ef.fileName;
        a.click();
        URL.revokeObjectURL(a.href);
      }, i * 300);
    });
  } else if (encryptedFileBlob) {
    var a = document.createElement('a');
    a.href = URL.createObjectURL(encryptedFileBlob);
    a.download = encryptedFileName || 'encrypted.lownet.enc';
    a.click();
    URL.revokeObjectURL(a.href);
  } else {
    showStatus('No encrypted file', 'error');
  }
};

// === FILE DECRYPTION ===
$('btn-load-encrypted-file').onclick = function() {
  if (!isPremium()) { showPremiumModal(); return; }
  $('file-decrypt-input').click();
};

$('file-decrypt-input').onchange = function(e) {
  var file = e.target.files && e.target.files[0];
  if (!file) return;
  e.target.value = '';
  
  $('file-decrypt-status').classList.remove('hide');
  $('file-decrypt-status').textContent = 'Reading file...';
  $('file-decrypt-status').style.background = 'var(--surface)';
  $('file-decrypt-status').style.color = 'var(--text-muted)';
  $('file-decrypt-result').classList.add('hide');
  
  // Find unlocked identity
  var myIdentity = null;
  session.unlocked.forEach(function(id) { if (!myIdentity) myIdentity = id; });
  if (!myIdentity) {
    $('file-decrypt-status').textContent = 'Unlock an identity first (Keys tab)';
    $('file-decrypt-status').style.background = 'var(--error-subtle)';
    $('file-decrypt-status').style.color = 'var(--error)';
    return;
  }
  
  var reader = new FileReader();
  reader.onload = function(ev) {
    $('file-decrypt-status').textContent = 'Decrypting...';
    
    decryptFileEnvelope(myIdentity, ev.target.result).then(function(result) {
      // Success
      decryptedFileBlob = new Blob([result.fileBuffer], { type: result.fileType });
      decryptedFileName = result.fileName;
      
      $('file-decrypt-status').classList.add('hide');
      $('file-decrypt-result').classList.remove('hide');
      
      var badge = $('file-decrypt-badge');
      badge.classList.remove('error');
      $('file-decrypt-title').textContent = 'Decrypted';
      $('file-decrypt-sub').textContent = result.fileName + ' · ' + formatFileSize(result.fileSize);
      
      var details = $('file-decrypt-details');
      details.textContent = '';
      addInfoRow(details, 'File', result.fileName);
      addInfoRow(details, 'Type', result.fileType);
      addInfoRow(details, 'Size', formatFileSize(result.fileSize));
      addInfoRow(details, 'From', result.sender ? (result.sender.name || 'Anonymous') : 'Unknown');
      addInfoRow(details, 'FP', result.sender ? (result.sender.fp || '-') : '-');
      addInfoRow(details, 'Time', result.timestamp);
      addInfoRow(details, 'Mode', result.privateMode ? 'Private (sender hidden in header)' : 'Public');
      addInfoRow(details, 'ID', result.envId);
      addInfoRow(details, 'License', result.senderLicensed ? 'PRO ✓' : 'Unlicensed');
      
      // Shareware badge
      var existingBanner = document.getElementById('file-decrypt-license-banner');
      if (existingBanner) existingBanner.remove();
      if (!result.senderLicensed) {
        var banner = document.createElement('div');
        banner.id = 'file-decrypt-license-banner';
        banner.style.cssText = 'margin-top:10px;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:10px;color:var(--text-muted);line-height:1.6;text-align:center;';
        banner.innerHTML = 'Encrypted with LOWNET Toolkit <span style="color:var(--text-dim);">(unlicensed)</span><br><a href="https://lownet.org/pro" target="_blank" style="color:var(--accent);text-decoration:none;">Get PRO → lownet.org/pro</a>';
        $('file-decrypt-result').appendChild(banner);
      }
      
      showStatus('File decrypted');
    }).catch(function(err) {
      $('file-decrypt-status').textContent = 'Error: ' + err.message;
      $('file-decrypt-status').style.background = 'var(--error-subtle)';
      $('file-decrypt-status').style.color = 'var(--error)';
      
      // If it's "not for you", try other unlocked identities
      if (err.message.indexOf('not encrypted for') !== -1 && session.unlocked.size > 1) {
        $('file-decrypt-status').textContent += ' (tried first unlocked identity — try unlocking the correct one)';
      }
    });
  };
  reader.readAsArrayBuffer(file);
};

$('btn-download-decrypted-file').onclick = function() {
  if (!decryptedFileBlob) { showStatus('No decrypted file', 'error'); return; }
  var a = document.createElement('a');
  a.href = URL.createObjectURL(decryptedFileBlob);
  a.download = decryptedFileName || 'decrypted-file';
  a.click();
  URL.revokeObjectURL(a.href);
};

// Drag & drop .lownet.enc on verify tab
$('file-decrypt-card').ondragover = function(e) {
  e.preventDefault();
  this.style.borderColor = 'var(--accent)';
};
$('file-decrypt-card').ondragleave = function(e) {
  e.preventDefault();
  this.style.borderColor = 'var(--border)';
};
$('file-decrypt-card').ondrop = function(e) {
  e.preventDefault();
  this.style.borderColor = 'var(--border)';
  if (e.dataTransfer.files && e.dataTransfer.files[0]) {
    // Simulate file input
    var dt = new DataTransfer();
    dt.items.add(e.dataTransfer.files[0]);
    $('file-decrypt-input').files = dt.files;
    $('file-decrypt-input').dispatchEvent(new Event('change'));
  }
};


// ============================================================
// LICENSE UI HANDLERS
// ============================================================
$('btn-activate-license').onclick = function() {
  var key = $('license-key-input').value.trim();
  if (!key) { showStatus('Paste a license key', 'error'); return; }
  $('btn-activate-license').disabled = true;
  $('btn-activate-license').textContent = 'Verifying...';
  verifyLicense(key).then(function(result) {
    if (result.valid) {
      localStorage.setItem('lownet_license', key);
      licenseState = result;
      updateLicenseUI();
      showStatus('PRO license activated!');
    } else {
      showStatus('Invalid license: ' + result.error, 'error');
      $('btn-activate-license').disabled = false;
      $('btn-activate-license').textContent = 'Activate';
    }
  });
};
$('btn-remove-license').onclick = function() {
  localStorage.removeItem('lownet_license');
  licenseState = { valid: false, payload: null };
  $('license-key-input').value = '';
  $('license-key-input').disabled = false;
  updateLicenseUI();
  showStatus('License removed');
};
$('btn-premium-modal-close').onclick = hidePremiumModal;
$('btn-premium-modal-settings').onclick = function() {
  hidePremiumModal();
  // Switch to settings tab
  document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(t){ t.classList.remove('active'); });
  document.querySelector('.tab[data-tab="settings"]').classList.add('active');
  $('tab-settings').classList.add('active');
  $('license-key-input').focus();
};

// ============================================================
// HASH VERIFICATION HANDLERS
// ============================================================
(function() {
  var zone = $('hash-drop-zone'), input = $('hash-file-input'), currentHash = '';
  zone.onclick = function() { input.click(); };
  zone.ondragover = function(e) { e.preventDefault(); zone.style.borderColor = 'var(--accent)'; zone.style.background = 'var(--accent-subtle)'; };
  zone.ondragleave = function(e) { e.preventDefault(); zone.style.borderColor = 'var(--border)'; zone.style.background = 'var(--input-bg)'; };
  zone.ondrop = function(e) { e.preventDefault(); zone.style.borderColor = 'var(--border)'; zone.style.background = 'var(--input-bg)'; if (e.dataTransfer.files && e.dataTransfer.files[0]) hashFile(e.dataTransfer.files[0]); };
  input.onchange = function(e) { if (e.target.files && e.target.files[0]) hashFile(e.target.files[0]); e.target.value = ''; };
  function hashFile(file) {
    $('hash-result').classList.add('hide');
    $('hash-file-info').textContent = 'Hashing ' + file.name + ' (' + formatFileSize(file.size) + ')...';
    $('hash-result').classList.remove('hide');
    $('hash-output').textContent = '...';
    $('hash-compare-result').classList.add('hide');
    $('hash-compare-input').value = '';
    var reader = new FileReader();
    reader.onload = function(ev) {
      sha256(new Uint8Array(ev.target.result)).then(function(hash) {
        currentHash = bytesToHex(hash);
        $('hash-file-info').textContent = file.name + ' · ' + formatFileSize(file.size);
        $('hash-output').textContent = 'sha256:' + currentHash;
      });
    };
    reader.readAsArrayBuffer(file);
  }
  $('btn-copy-hash').onclick = function() {
    if (!currentHash) return;
    navigator.clipboard.writeText('sha256:' + currentHash).then(function() { showStatus('Hash copied'); });
  };
  $('hash-compare-input').oninput = function() {
    var expected = this.value.trim().replace(/^sha256:/i, '').toLowerCase();
    var result = $('hash-compare-result');
    if (!expected || !currentHash) { result.classList.add('hide'); return; }
    result.classList.remove('hide');
    if (expected === currentHash) {
      result.style.background = 'var(--accent-subtle)';
      result.style.color = 'var(--accent)';
      result.textContent = '✓ Match — file integrity verified';
    } else {
      result.style.background = 'var(--error-subtle,#1a0000)';
      result.style.color = 'var(--error)';
      result.textContent = '✗ Mismatch — file may be corrupted or different';
    }
  };
})();

// INIT
crypto.subtle.generateKey('Ed25519',false,['sign']).then(function(){renderKeys();renderContacts();renderLockStatus();loadLicense()}).catch(function(){showStatus('Browser needs Ed25519 (Chrome 113+, Safari 17+)','error')});

// Compute toolkit hash on load (hash of script content for receipt binding)
(async function(){
  try{
    var scripts=document.querySelectorAll('script');
    var mainScript=scripts[scripts.length-1];
    if(mainScript&&mainScript.textContent){
      var hash=await sha256(mainScript.textContent);
      TOOLKIT_HASH='sha256:'+bytesToHex(hash).slice(0,32);
    }
  }catch(e){TOOLKIT_HASH='unknown'}
})();

// Initialize linked notices UI
setTimeout(function(){updateLinkedNoticesUI()},100);

// PWA: Service worker at /sw.js — cache-first with stale-while-revalidate

// ============================================================================
// TERMINAL
// ============================================================================

var termHistory=[];
var termHistoryIdx=-1;
var termVisible=false;
var lastSignedOutput=null;

function termPrint(text,type){
  var el=$('term-output');
  var line=document.createElement('div');
  line.style.marginBottom='4px';
  if(type==='error')line.style.color='var(--error)';
  else if(type==='success')line.style.color='var(--accent)';
  else if(type==='muted')line.style.color='var(--text-muted)';
  else if(type==='warn')line.style.color='var(--warning)';
  line.textContent=text;
  el.appendChild(line);
  el.scrollTop=el.scrollHeight;
}

function termClear(){$('term-output').innerHTML=''}

function termPrintHelp(cmd,desc){
  var el=$('term-output');
  var line=document.createElement('div');
  line.style.marginBottom='6px';
  line.style.display='flex';
  line.style.alignItems='center';
  line.style.gap='12px';
  var pill=document.createElement('span');
  pill.style.cssText='background:var(--surface-hover);color:var(--accent);padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;min-width:140px;display:inline-block;';
  pill.textContent=cmd;
  var descSpan=document.createElement('span');
  descSpan.style.cssText='color:var(--text-secondary);font-size:11px;';
  descSpan.textContent=desc;
  line.appendChild(pill);
  line.appendChild(descSpan);
  el.appendChild(line);
  el.scrollTop=el.scrollHeight;
}

function updateTermPrompt(){
  var status='lownet';
  if(session.unlocked.size>0){
    var fp=session.activeId||Array.from(session.unlocked.keys())[0];
    var short=fp?fp.split(':').pop().slice(0,4).toUpperCase():'?';
    status='lownet['+short+']';
  }else{
    status='lownet[locked]';
  }
  $('term-prompt').textContent=status+'>';
  $('term-status').textContent=publicServerUrl?'relay: lownet.org':'offline';
}

var termCommands={
  help:function(){
    termPrint('LOWNET Terminal','muted');
    termPrint('','muted');
    termPrintHelp('help','Show this help');
    termPrintHelp('clear','Clear terminal output');
    termPrintHelp('theme light|dark','Switch theme');
    termPrint('','muted');
    termPrintHelp('keys list','List identities');
    termPrintHelp('keys unlock <fp>','Unlock identity by fingerprint');
    termPrintHelp('keys lock','Lock all identities');
    termPrintHelp('whoami','Show active identity');
    termPrint('','muted');
    termPrintHelp('vault list','List vault items');
    termPrintHelp('vault count','Count vault items');
    termPrint('','muted');
    termPrintHelp('node info','Get connected node info (NIP-1)');
    termPrintHelp('node connect <url>','Connect to node');
    termPrintHelp('feed','Show recent public proofs');
    termPrintHelp('publish','Publish last signed output');
    termPrintHelp('receipt','Show last signing receipt (LNR-1)');
  },
  
  clear:function(){termClear()},
  
  theme:function(args){
    var mode=args[0];
    if(mode==='light'){
      isLightMode=true;
      document.documentElement.classList.add('light');
      localStorage.setItem('lownet_theme','light');
      termPrint('Theme: light','success');
    }else if(mode==='dark'){
      isLightMode=false;
      document.documentElement.classList.remove('light');
      localStorage.setItem('lownet_theme','dark');
      termPrint('Theme: dark','success');
    }else{
      termPrint('Usage: theme light|dark','error');
    }
  },
  
  keys:function(args){
    var sub=args[0];
    if(sub==='list'){
      keysList().then(function(keys){
        if(keys.length===0){termPrint('No identities','muted');return}
        keys.forEach(function(k){
          var unlocked=session.unlocked.has(k.id);
          var marker=unlocked?'[UNLOCKED]':'[locked]';
          termPrint('  '+k.fp+' '+marker+' '+(k.name||'unnamed'));
        });
      });
    }else if(sub==='unlock'){
      var fp=args[1];
      if(!fp){termPrint('Usage: keys unlock <fingerprint>','error');return}
      keysList().then(function(keys){
        var match=keys.find(function(k){return k.fp.includes(fp)||k.id.includes(fp)});
        if(!match){termPrint('Identity not found: '+fp,'error');return}
        termPrint('Enter passphrase for '+match.name+' in the UI unlock prompt','warn');
        promptUnlock(match.id);
      });
    }else if(sub==='lock'){
      session.unlocked.clear();
      session.activeId=null;
      identities=[];
      renderKeys();
      renderLockStatus();
      updateTermPrompt();
      termPrint('All identities locked','success');
    }else{
      termPrint('Usage: keys list|unlock|lock','error');
    }
  },
  
  vault:function(args){
    var sub=args[0];
    if(sub==='list'){
      vaultList().then(function(items){
        if(items.length===0){termPrint('Vault empty','muted');return}
        items.slice(0,20).forEach(function(item){
          var d=item.data;
          var type=d.ln_type||d.env_version||d.scp1_version||'?';
          var title=d.ln_payload?.title||d.ln_payload?.content?.slice(0,30)||d.ln_id||'untitled';
          termPrint('  ['+item.id+'] '+type+': '+title);
        });
        if(items.length>20)termPrint('  ... and '+(items.length-20)+' more','muted');
      });
    }else if(sub==='count'){
      vaultList().then(function(items){
        termPrint('Vault items: '+items.length);
      });
    }else{
      termPrint('Usage: vault list|count','error');
    }
  },
  
  node:function(args){
    var sub=args[0];
    if(sub==='info'){
      if(!publicServerUrl){termPrint('Not connected. Run: node connect','warn');return}
      termPrint('Fetching node info...','muted');
      fetch(RELAY_URL+'/v1/node/info').then(function(r){return r.json()}).then(function(info){
        if(info.ln_node_info!=='NIP-1'){termPrint('Invalid node info response','error');return}
        termPrint('Node: '+info.node_id,'success');
        termPrint('  Pubkey: '+info.node_pubkey);
        termPrint('  Version: '+info.server_version);
        termPrint('  Build: '+info.build.commit+' ('+info.build.build_time.slice(0,10)+')');
        termPrint('  Repo: '+info.build.repo);
        termPrint('  PoW threshold: '+info.capabilities.pow_verify_threshold.toLocaleString());
        termPrint('  Rate limit: '+info.policy.rate_limit_requests+' req/'+Math.round(info.policy.rate_limit_window_ms/1000)+'s');
        termPrint('  Status: ⚠ Unverified build (Phase 2 pending)','warn');
      }).catch(function(e){
        termPrint('Error: '+e.message,'error');
      });
    }else if(sub==='connect'){
      publicServerUrl=RELAY_URL;
      termPrint('Connecting to '+RELAY_URL+'...','muted');
      fetch(RELAY_URL+'/health').then(function(r){return r.json()}).then(function(data){
        termPrint('Connected! Notices: '+data.notices,'success');
        updateTermPrompt();
      }).catch(function(e){
        termPrint('Connection failed: '+e.message,'error');
      });
    }else{
      termPrint('Usage: node info|connect','error');
    }
  },
  
  feed:function(){
    if(!publicServerUrl){termPrint('Not connected. Run: node connect','warn');return}
    termPrint('Fetching feed...','muted');
    fetch(RELAY_URL+'/feed?limit=10').then(function(r){return r.json()}).then(function(data){
      if(!data.notices||data.notices.length===0){termPrint('No notices','muted');return}
      data.notices.forEach(function(n){
        var author=n.ln_signer?.name||'anon';
        var title=n.ln_payload?.title||n.ln_payload?.content?.slice(0,40)||'-';
        termPrint('  ['+n.ln_type+'] '+author+': '+title);
      });
      termPrint('Total: '+data.total+' notices','muted');
    }).catch(function(e){
      termPrint('Error: '+e.message,'error');
    });
  },
  
  publish:function(){
    var output=$('signed-output').value;
    if(!output){termPrint('No signed output to publish','error');return}
    if(!publicServerUrl){termPrint('Not connected. Run: node connect','warn');return}
    try{
      var notice=JSON.parse(output);
      if(!notice.ln_version){termPrint('Not a valid CNP-1 notice','error');return}
      termPrint('Publishing to '+new URL(RELAY_URL).host+'...','muted');
      publishToServer(notice).then(function(result){
        termPrint('Published! ID: '+result.id,'success');
      }).catch(function(e){
        termPrint('Publish failed: '+e.message,'error');
      });
    }catch(e){
      termPrint('Invalid JSON: '+e.message,'error');
    }
  },
  
  receipt:function(){
    if(!session.lastReceipt){
      termPrint('No receipt available (sign something first)','warn');
      return;
    }
    var r=session.lastReceipt;
    termPrint('Identity Receipt (LNR-1)','success');
    termPrint('  Identity: '+r.identity_fp);
    termPrint('  Name: '+(r.identity_name||'unnamed'));
    termPrint('  Notice: '+r.notice_hash.slice(0,32)+'...');
    termPrint('  Signed: '+r.signed_at);
    termPrint('  Toolkit: '+r.toolkit_version+' ('+r.toolkit_hash+')');
    termPrint('  PoW: '+r.pow_rounds.toLocaleString()+' rounds (seq #'+r.pow_seq+')');
    termPrint('  Security: Level '+r.security_level);
  },
  
  whoami:function(){
    if(session.unlocked.size===0){
      termPrint('No identity unlocked','warn');
      return;
    }
    var id=session.activeId?session.unlocked.get(session.activeId):session.unlocked.values().next().value;
    if(!id){termPrint('No active identity','warn');return}
    termPrint('Name: '+(id.name||'unnamed'));
    termPrint('Fingerprint: '+id.fp);
    termPrint('Sequence: '+(id.seq||0));
    termPrint('Created: '+(id.created||'?'));
    // Show security level
    keysList().then(function(keys){
      var record=keys.find(function(k){return k.id===id.id});
      if(record&&record.biometricCredId){
        termPrint('Security: Level 2 (biometric-gated signing)','success');
      }else{
        termPrint('Security: Level 1 (enable biometric for Level 2)','warn');
      }
    });
  }
};

function termExec(input){
  var parts=input.trim().split(/\s+/);
  var cmd=parts[0].toLowerCase();
  var args=parts.slice(1);
  
  termPrint('> '+input,'muted');
  
  if(!cmd)return;
  
  if(termCommands[cmd]){
    try{
      termCommands[cmd](args);
    }catch(e){
      termPrint('Error: '+e.message,'error');
    }
  }else{
    termPrint('Unknown command: '+cmd+'. Type "help" for commands.','error');
  }
  
  updateTermPrompt();
}

function toggleTerminal(){
  termVisible=!termVisible;
  $('terminal-overlay').classList.toggle('hide',!termVisible);
  if(termVisible){
    $('term-input').focus();
    updateTermPrompt();
  }
}

$('term-close').onclick=toggleTerminal;

$('term-input').addEventListener('keydown',function(e){
  if(e.key==='Enter'){
    var input=this.value.trim();
    if(input){
      termHistory.push(input);
      termHistoryIdx=termHistory.length;
      termExec(input);
    }
    this.value='';
  }else if(e.key==='ArrowUp'){
    e.preventDefault();
    if(termHistoryIdx>0){
      termHistoryIdx--;
      this.value=termHistory[termHistoryIdx]||'';
    }
  }else if(e.key==='ArrowDown'){
    e.preventDefault();
    if(termHistoryIdx<termHistory.length-1){
      termHistoryIdx++;
      this.value=termHistory[termHistoryIdx]||'';
    }else{
      termHistoryIdx=termHistory.length;
      this.value='';
    }
  }else if(e.key==='Escape'){
    toggleTerminal();
  }else if(e.key==='Tab'){
    e.preventDefault();
    var input=this.value.trim().toLowerCase();
    var matches=Object.keys(termCommands).filter(function(c){return c.startsWith(input)});
    if(matches.length===1)this.value=matches[0]+' ';
    else if(matches.length>1)termPrint('Commands: '+matches.join(', '),'muted');
  }
});

// Global keyboard shortcut: Ctrl+K or ` to toggle terminal
document.addEventListener('keydown',function(e){
  if((e.ctrlKey&&e.key==='k')||(e.key==='`'&&!e.target.matches('input,textarea'))){
    e.preventDefault();
    toggleTerminal();
  }
});

// Show terminal hint on first load
if(!localStorage.getItem('lownet_term_hint')){
  setTimeout(function(){
    showStatus('Tip: Press ` or Ctrl+K for terminal');
    localStorage.setItem('lownet_term_hint','1');
  },3000);
}

// Easter Egg: Classic Mode (5x click on title)
(function(){
  var clickCount=0;
  var clickTimer=null;
  var titleEl=document.querySelector('.header-title');
  if(!titleEl)return;
  
  // Restore saved mode
  if(localStorage.getItem('lownet_classic')==='1'){
    document.documentElement.classList.add('classic');
  }
  
  titleEl.style.cursor='default';
  titleEl.addEventListener('click',function(e){
    e.preventDefault();
    clickCount++;
    clearTimeout(clickTimer);
    clickTimer=setTimeout(function(){clickCount=0;},800);
    
    if(clickCount>=5){
      clickCount=0;
      var isClassic=document.documentElement.classList.toggle('classic');
      localStorage.setItem('lownet_classic',isClassic?'1':'0');
      if(isClassic){
        showStatus('Classic Mode');
      }else{
        showStatus('Hyper Mode');
      }
    }
  });
})();

// ============================================================
// WEB SHARE API — share encrypted files via native OS share sheet
// No OAuth. No API keys. No server. No approval process.
// ============================================================
(function() {
  // Show share button only if Web Share API with files is supported
  var shareBtn = $('btn-share-file');
  if (navigator.canShare && navigator.canShare({ files: [new File([''], 'test.enc')] })) {
    // Will be shown when file is encrypted (in setCreateStep)
    shareBtn.dataset.supported = '1';
  }

  shareBtn.onclick = function() {
    if (!isPremium()) { showPremiumModal(); return; }
    if (!encryptedFileBlob) { showStatus('No encrypted file', 'error'); return; }

    // Anonymize filename
    var anonName = 'lownet_' + Array.from(crypto.getRandomValues(new Uint8Array(6)),
      function(b) { return b.toString(16).padStart(2, '0'); }).join('') + '.enc';

    var file = new File([encryptedFileBlob], anonName, { type: 'application/octet-stream' });

    navigator.share({ files: [file] }).then(function() {
      showStatus('File shared');
    }).catch(function(e) {
      if (e.name !== 'AbortError') showStatus('Share cancelled', 'error');
    });
  };
})();

// ============================================================
// PWA: SERVICE WORKER + INSTALL PROMPT
// ============================================================
(function() {
  // Register service worker for offline support
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js', { scope: '/' }).then(function(reg) {
      // Check for updates every hour
      setInterval(function() { reg.update(); }, 60 * 60 * 1000);
    }).catch(function() { /* SW not supported in this context */ });
  }

  // Detect standalone mode
  if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
    document.documentElement.classList.add('pwa-standalone');
  }

  // Extension security warning — show when not in PWA mode and not dismissed
  var isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  var dismissed = false;
  try { dismissed = localStorage.getItem('lownet_ext_warn_dismissed') === '1'; } catch(e) {}
  var warnEl = document.getElementById('ext-warning');
  if (warnEl && !isPWA && !dismissed) {
    warnEl.classList.remove('hide');
  }
  var warnClose = document.getElementById('ext-warning-close');
  if (warnClose) warnClose.onclick = function() {
    warnEl.classList.add('hide');
    try { localStorage.setItem('lownet_ext_warn_dismissed', '1'); } catch(e) {}
  };
  var warnAction = document.getElementById('ext-warn-action');
  if (warnAction) warnAction.onclick = function() {
    var installBtn = document.getElementById('btn-install');
    if (installBtn && !installBtn.classList.contains('hide')) {
      installBtn.click();
    } else {
      alert('To install: use your browser menu → "Add to Home Screen" or "Install App".');
    }
  };
})();

// SELF-INTEGRITY CHECK
// Fetches the served HTML file, computes SHA-256, displays in Help modal.
// Compare against hash published at lownet.org/verify to detect tampering.
(function() {
  var el = document.getElementById('self-integrity-hash');
  if (!el) return;
  fetch(location.href).then(function(r) { return r.arrayBuffer(); }).then(function(buf) {
    return crypto.subtle.digest('SHA-256', buf);
  }).then(function(hash) {
    el.textContent = Array.from(new Uint8Array(hash)).map(function(b) {
      return b.toString(16).padStart(2, '0');
    }).join('');
  }).catch(function() { el.textContent = 'offline (compare manually)'; });
})();
</script>

</body>
</html>
